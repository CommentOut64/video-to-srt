# å‰ç«¯é‡æ„-åç«¯å‡†å¤‡å·¥ä½œæ¸…å•

> åŸºäºã€Šç•Œé¢é‡æ„è¯¦ç»†å¼€å‘æŒ‡å— v3.1ã€‹åˆ†æï¼Œæ¢³ç†åç«¯éœ€è¦æ–°å¢ã€ä¿®æ”¹æˆ–ä¼˜åŒ–çš„éƒ¨åˆ†
>
> **æ›´æ–°æ—¥æœŸï¼š2025-11-25**
> **P0ä»»åŠ¡çŠ¶æ€ï¼šå·²å®Œæˆ**
> **P1ä»»åŠ¡çŠ¶æ€ï¼šå·²å®Œæˆ**
> **P2ä»»åŠ¡çŠ¶æ€ï¼šå·²å®Œæˆ**

---

## å®ç°çŠ¶æ€æ€»è§ˆ

### P0 - é˜»å¡å‰ç«¯å¼€å‘ï¼ˆå·²å®Œæˆï¼‰

| åŠŸèƒ½ | çŠ¶æ€ | æ¥å£ |
|------|------|------|
| è§†é¢‘æµï¼ˆRangeè¯·æ±‚ï¼‰ | âœ… å·²å®ç° | `GET /api/media/{job_id}/video` |
| éŸ³é¢‘æ–‡ä»¶æ¥å£ | âœ… å·²å®ç° | `GET /api/media/{job_id}/audio` |
| æ³¢å½¢å³°å€¼æ•°æ® | âœ… å·²å®ç° | `GET /api/media/{job_id}/peaks` |
| Proxyè§†é¢‘è‡ªåŠ¨ç”Ÿæˆ | âœ… å·²å®ç° | è‡ªåŠ¨è§¦å‘ï¼Œå¼‚æ­¥æ‰§è¡Œ |
| ProxyçŠ¶æ€æ£€æŸ¥ | âœ… å·²å®ç° | `GET /api/media/{job_id}/proxy-status` |
| è§†é¢‘ç¼©ç•¥å›¾ | âœ… å·²å®ç° | `GET /api/media/{job_id}/thumbnails` |
| è½¬å½•åé¢„å¤„ç†æ¥å£ | âœ… å·²å®ç° | `POST /api/media/{job_id}/post-process` |
| SRTå†…å®¹è·å–/ä¿å­˜ | âœ… å·²å®ç° | `GET/POST /api/media/{job_id}/srt` |
| åª’ä½“ä¿¡æ¯æ‘˜è¦ | âœ… å·²å®ç° | `GET /api/media/{job_id}/info` |

### P1 - æå‡ä½“éªŒï¼ˆå·²å®Œæˆï¼‰

| åŠŸèƒ½ | çŠ¶æ€ | ä¿®æ”¹ä½ç½® |
|------|------|----------|
| è½¬å½•å®Œæˆè‡ªåŠ¨é¢„å¤„ç† | âœ… å·²å®ç° | `transcription_service.py` |
| JobStateæ‰©å±•MediaStatus | âœ… å·²å®ç° | `job_models.py` |
| ä»»åŠ¡çŠ¶æ€è¿”å›åª’ä½“ä¿¡æ¯ | âœ… å·²å®ç° | `transcription_routes.py` |

### P2 - åç»­ä¼˜åŒ–ï¼ˆå·²å®Œæˆï¼‰

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ³¢å½¢æ•°æ®FFmpegåŠ é€Ÿ | âœ… å·²å®ç° | å¤§æ–‡ä»¶(>50MB)è‡ªåŠ¨ä½¿ç”¨FFmpegï¼Œæ”¯æŒ`method`å‚æ•°åˆ‡æ¢ |
| Proxyè§†é¢‘è¿›åº¦SSEæ¨é€ | âœ… å·²å®ç° | å®æ—¶æ¨é€`proxy_progress`å’Œ`proxy_complete`äº‹ä»¶ |
| ç¼©ç•¥å›¾Spriteå›¾ä¼˜åŒ– | âœ… å·²å®ç° | åˆå¹¶å¤šä¸ªç¼©ç•¥å›¾ä¸ºå•å¼ å›¾ç‰‡ï¼Œå‡å°‘HTTPè¯·æ±‚ |
| Spriteå›¾ç›´æ¥è®¿é—® | âœ… å·²å®ç° | `GET /api/media/{job_id}/sprite.jpg` |

---

## ä¸€ã€ç°çŠ¶æ€»ç»“

### 1.1 å·²æœ‰åç«¯èƒ½åŠ›

| åŠŸèƒ½æ¨¡å— | æ–‡ä»¶ä½ç½® | çŠ¶æ€ |
|---------|----------|------|
| è½¬å½•ä»»åŠ¡ç®¡ç† | `transcription_routes.py` | âœ… å®Œå–„ |
| ä»»åŠ¡é˜Ÿåˆ—æœåŠ¡ | `job_queue_service.py` | âœ… å®Œå–„ |
| SSEå®æ—¶æ¨é€ | `sse_service.py` | âœ… å®Œå–„ |
| æ¨¡å‹ç®¡ç† | `model_manager_service.py`, `model_preload_manager.py` | âœ… å®Œå–„ |
| ç¡¬ä»¶æ£€æµ‹ | `hardware_service.py` | âœ… å®Œå–„ |
| FFmpegç®¡ç† | `ffmpeg_manager.py` | âœ… å®Œå–„ |
| æ–‡ä»¶ç®¡ç† | `file_service.py` | âœ… åŸºç¡€åŠŸèƒ½ |
| æ–­ç‚¹ç»­ä¼  | `transcription_service.py` | âœ… å®Œå–„ |
| æš‚åœ/æ¢å¤ä»»åŠ¡ | `transcription_routes.py` | âœ… å·²æœ‰ |
| å…¨å±€SSEæµ | `/api/events/global` | âœ… å·²æœ‰ |

### 1.2 ä»»åŠ¡ç›®å½•ç»“æ„ï¼ˆå·²æœ‰ï¼‰

```
jobs/{job_id}/
â”œâ”€â”€ {åŸå§‹è§†é¢‘æ–‡ä»¶}.mp4      # æºè§†é¢‘ï¼ˆæˆ–å¤åˆ¶åˆ°æ­¤å¤„ï¼‰
â”œâ”€â”€ audio.wav               # æå–çš„éŸ³é¢‘
â”œâ”€â”€ segment_*.wav           # åˆ†æ®µéŸ³é¢‘
â”œâ”€â”€ checkpoint.json         # æ–­ç‚¹ç»­ä¼ æ•°æ®
â””â”€â”€ {filename}.srt          # ç”Ÿæˆçš„å­—å¹•
```

### 1.3 æ ¸å¿ƒAPIç«¯ç‚¹ï¼ˆå·²æœ‰ï¼‰

- `POST /api/upload` - ä¸Šä¼ æ–‡ä»¶
- `POST /api/start` - å¯åŠ¨ä»»åŠ¡
- `GET /api/status/{job_id}` - è·å–çŠ¶æ€
- `GET /api/stream/{job_id}` - å•ä»»åŠ¡SSEæµ
- `GET /api/events/global` - å…¨å±€SSEæµ
- `GET /api/download/{job_id}` - ä¸‹è½½SRTæ–‡ä»¶
- `POST /api/pause/{job_id}` - æš‚åœä»»åŠ¡
- `POST /api/prioritize/{job_id}` - æ’é˜ŸåŠŸèƒ½

---

## äºŒã€éœ€è¦æ–°å¢çš„åç«¯åŠŸèƒ½

### 2.1 åª’ä½“èµ„æºè·¯ç”± (media_routes.py) â­â­â­ å…³é”®

**ä¼˜å…ˆçº§ï¼šP0 - é˜»å¡å‰ç«¯å¼€å‘**

æ–°å»ºæ–‡ä»¶ `backend/app/api/routes/media_routes.py`ï¼Œæä¾›ä»¥ä¸‹æ¥å£ï¼š

#### 2.1.1 è§†é¢‘æµæ¥å£ï¼ˆæ”¯æŒRangeè¯·æ±‚ï¼‰

```
GET /api/media/{job_id}/video
```

**åŠŸèƒ½è¦ç‚¹ï¼š**
- æ”¯æŒHTTP Rangeè¯·æ±‚ï¼ˆå¤§è§†é¢‘æ‹–æ‹½è·³è½¬å¿…éœ€ï¼‰
- ä¼˜å…ˆè¿”å›Proxyè§†é¢‘ï¼ˆå¦‚å­˜åœ¨ï¼‰
- è¿”å›206 Partial ContentçŠ¶æ€ç 
- è®¾ç½® `Content-Range`ã€`Accept-Ranges` å“åº”å¤´

**å®ç°è¦ç‚¹ï¼š**
```python
# å‚è€ƒå®ç°æ¡†æ¶
@router.get("/{job_id}/video")
async def get_video(job_id: str, request: Request):
    # 1. æ£€æŸ¥ proxy.mp4 æ˜¯å¦å­˜åœ¨
    # 2. è§£æ Range å¤´
    # 3. è¿”å› StreamingResponse (206)
```

#### 2.1.2 éŸ³é¢‘æ–‡ä»¶æ¥å£

```
GET /api/media/{job_id}/audio
```

**åŠŸèƒ½ï¼š** è¿”å› `audio.wav` æ–‡ä»¶ï¼Œä¾› wavesurfer.js ä½¿ç”¨

#### 2.1.3 æ³¢å½¢å³°å€¼æ•°æ®æ¥å£ â­â­â­ æ ¸å¿ƒ

```
GET /api/media/{job_id}/peaks?samples=2000
```

**åŠŸèƒ½è¦ç‚¹ï¼š**
- ä½¿ç”¨æµå¼WAVè¯»å–ï¼ˆé¿å…å¤§æ–‡ä»¶OOMï¼‰
- è¿”å›å½’ä¸€åŒ–çš„ min/max å³°å€¼æ•°ç»„
- ç¼“å­˜è®¡ç®—ç»“æœåˆ° `peaks_{samples}.json`

**è¿”å›æ ¼å¼ï¼š**
```json
{
  "peaks": [-0.5, 0.8, -0.3, 0.6, ...],  // min, max äº¤æ›¿
  "duration": 180.5
}
```

**å®ç°è¦ç‚¹ï¼š**
```python
# ä½¿ç”¨ Python wave æ¨¡å—æµå¼è¯»å–
import wave
import struct

with wave.open(audio_file, 'rb') as wav:
    # åˆ†å—è¯»å–ï¼Œé€æ­¥è®¡ç®—å³°å€¼
    # é¿å…ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜
```

#### 2.1.4 è§†é¢‘ç¼©ç•¥å›¾æ¥å£

```
GET /api/media/{job_id}/thumbnails?count=20
```

**åŠŸèƒ½è¦ç‚¹ï¼š**
- ä½¿ç”¨ FFmpeg æå–æŒ‡å®šæ•°é‡çš„è§†é¢‘å¸§
- è¿”å› Base64 ç¼–ç çš„å›¾ç‰‡æ•°ç»„
- ç¼“å­˜ç»“æœåˆ° `thumbnails_{count}.json`

**è¿”å›æ ¼å¼ï¼š**
```json
{
  "thumbnails": ["data:image/jpeg;base64,...", ...],
  "timestamps": [0, 9.5, 19.0, ...],
  "duration": 190.0
}
```

#### 2.1.5 Proxyè§†é¢‘çŠ¶æ€æ£€æŸ¥

```
GET /api/media/{job_id}/proxy-status
```

**è¿”å›ï¼š**
```json
{
  "exists": true,
  "size": 123456789,
  "generating": false
}
```

#### 2.1.6 è½¬å½•åé¢„å¤„ç†æ¥å£

```
POST /api/media/{job_id}/post-process
```

**åŠŸèƒ½ï¼š** è½¬å½•å®Œæˆåè‡ªåŠ¨è°ƒç”¨ï¼Œé¢„ç”Ÿæˆç¼–è¾‘å™¨æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ï¼š
- æ³¢å½¢å³°å€¼æ•°æ®
- è§†é¢‘ç¼©ç•¥å›¾
- Proxyè§†é¢‘ï¼ˆå¦‚éœ€è¦ï¼‰

**è§¦å‘æ—¶æœºï¼š** åœ¨ `transcription_service.py` è½¬å½•å®Œæˆåè°ƒç”¨

---

### 2.2 Proxyè§†é¢‘è‡ªåŠ¨ç”ŸæˆæœåŠ¡ â­â­â­ å…³é”®

**ä¼˜å…ˆçº§ï¼šP0 - è§£å†³æµè§ˆå™¨è§†é¢‘æ ¼å¼å…¼å®¹æ€§é—®é¢˜**

**é—®é¢˜èƒŒæ™¯ï¼š** HTML5 `<video>` åªæ”¯æŒ MP4(H.264)ã€WebM ç­‰å°‘æ•°æ ¼å¼ï¼ŒMKVã€AVIã€H.265 ç­‰æ— æ³•æ’­æ”¾

**å®ç°ä½ç½®ï¼š** `backend/app/services/media_service.py`ï¼ˆæ–°å»ºï¼‰

**åŠŸèƒ½è¦ç‚¹ï¼š**
1. æ£€æµ‹è§†é¢‘æ ¼å¼æ˜¯å¦æµè§ˆå™¨å…¼å®¹
2. å¼‚æ­¥ç”Ÿæˆ 720p H.264 Proxy è§†é¢‘
3. ä¸é˜»å¡ä¸»è½¬å½•æµç¨‹

**éœ€è½¬ç çš„æ ¼å¼ï¼š**
- `.mkv`, `.avi`, `.mov`, `.wmv`, `.flv`
- ç¼–ç ä¸º H.265/HEVC çš„ `.mp4`

**FFmpegå‘½ä»¤å‚è€ƒï¼š**
```bash
ffmpeg -i input.mkv \
  -vf scale=-2:720 \
  -c:v libx264 -preset fast -crf 28 \
  -c:a aac -b:a 128k \
  -y proxy.mp4
```

---

### 2.3 è·å–SRTå†…å®¹æ¥å£

**ä¼˜å…ˆçº§ï¼šP1**

```
GET /api/srt/{job_id}/content
```

**åŠŸèƒ½ï¼š** è¿”å›SRTæ–‡ä»¶çš„åŸå§‹æ–‡æœ¬å†…å®¹ï¼ˆä¾›å‰ç«¯è§£æï¼‰

**è¿”å›ï¼š**
```json
{
  "job_id": "xxx",
  "filename": "video.srt",
  "content": "1\n00:00:01,000 --> 00:00:03,000\nç¬¬ä¸€å¥è¯\n\n2\n...",
  "encoding": "utf-8"
}
```

**å¤‡é€‰æ–¹æ¡ˆï¼š** å‰ç«¯å¯ä»¥é€šè¿‡ `/api/download/{job_id}` è·å–åè‡ªè¡Œè§£æ

---

### 2.4 ä¿å­˜ç¼–è¾‘åçš„å­—å¹•æ¥å£

**ä¼˜å…ˆçº§ï¼šP1**

```
POST /api/srt/{job_id}/save
Content-Type: application/json

{
  "content": "1\n00:00:01,000 --> 00:00:03,000\nä¿®æ”¹åçš„æ–‡å­—\n\n..."
}
```

**åŠŸèƒ½ï¼š** ä¿å­˜å‰ç«¯ç¼–è¾‘åçš„SRTå†…å®¹

**å®ç°è¦ç‚¹ï¼š**
- éªŒè¯SRTæ ¼å¼
- å¤‡ä»½åŸæ–‡ä»¶
- å†™å…¥æ–°å†…å®¹

---

## ä¸‰ã€éœ€è¦ä¿®æ”¹/å¢å¼ºçš„ç°æœ‰åŠŸèƒ½

### 3.1 ä»»åŠ¡å®Œæˆåè‡ªåŠ¨é¢„å¤„ç†

**ä¿®æ”¹ä½ç½®ï¼š** `backend/app/services/transcription_service.py`

**ä¿®æ”¹å†…å®¹ï¼š** åœ¨è½¬å½•å®Œæˆåï¼ˆç”ŸæˆSRTæ–‡ä»¶åï¼‰ï¼Œè‡ªåŠ¨è§¦å‘åª’ä½“é¢„å¤„ç†

```python
# åœ¨ _generate_srt() æ–¹æ³•å®Œæˆåæ·»åŠ 
async def _post_process_media(self, job_id: str):
    """è½¬å½•åé¢„å¤„ç†ï¼šç”Ÿæˆç¼–è¾‘å™¨æ‰€éœ€çš„åª’ä½“æ•°æ®"""
    try:
        # è°ƒç”¨ media_routes.post_process_transcription
        # ç”Ÿæˆæ³¢å½¢å³°å€¼ã€ç¼©ç•¥å›¾ã€Proxyè§†é¢‘ç­‰
        pass
    except Exception as e:
        # é¢„å¤„ç†å¤±è´¥ä¸å½±å“è½¬å½•ç»“æœ
        print(f"åª’ä½“é¢„å¤„ç†å¤±è´¥: {e}")
```

### 3.2 JobStateæ¨¡å‹æ‰©å±•

**ä¿®æ”¹ä½ç½®ï¼š** `backend/app/models/job_models.py`

**æ–°å¢å­—æ®µå»ºè®®ï¼š**
```python
@dataclass
class JobState:
    # ... ç°æœ‰å­—æ®µ ...

    # æ–°å¢ï¼šåª’ä½“é¢„å¤„ç†çŠ¶æ€
    media_ready: bool = False        # åª’ä½“èµ„æºæ˜¯å¦å°±ç»ª
    has_proxy_video: bool = False    # æ˜¯å¦æœ‰Proxyè§†é¢‘
    peaks_generated: bool = False    # æ³¢å½¢æ•°æ®æ˜¯å¦ç”Ÿæˆ
    thumbnails_generated: bool = False  # ç¼©ç•¥å›¾æ˜¯å¦ç”Ÿæˆ
```

### 3.3 å¢å¼ºä»»åŠ¡çŠ¶æ€æŸ¥è¯¢

**ä¿®æ”¹ä½ç½®ï¼š** `backend/app/api/routes/transcription_routes.py`

**ä¿®æ”¹æ¥å£ï¼š** `GET /api/status/{job_id}`

**æ–°å¢è¿”å›å­—æ®µï¼š**
```json
{
  // ... ç°æœ‰å­—æ®µ ...
  "media_status": {
    "video_path": "/api/media/{job_id}/video",
    "audio_path": "/api/media/{job_id}/audio",
    "peaks_available": true,
    "thumbnails_available": true,
    "proxy_available": false,
    "proxy_generating": true
  }
}
```

---

## å››ã€è·¯ç”±æ³¨å†Œ

**ä¿®æ”¹ä½ç½®ï¼š** `backend/app/main.py`

**æ–°å¢è·¯ç”±æ³¨å†Œï¼š**
```python
# åœ¨ main.py ä¸­æ·»åŠ 
from api.routes import media_routes

# åœ¨è·¯ç”±æ³¨å†Œéƒ¨åˆ†æ·»åŠ 
app.include_router(media_routes.router)
```

---

## äº”ã€ä»»åŠ¡ä¼˜å…ˆçº§æ’åº

### P0 - é˜»å¡å‰ç«¯å¼€å‘ï¼ˆå¿…é¡»é¦–å…ˆå®Œæˆï¼‰

| ä»»åŠ¡ | å·¥ä½œé‡ä¼°è®¡ | è¯´æ˜ |
|------|-----------|------|
| åˆ›å»º media_routes.py | 2å¤© | åŒ…å«æ‰€æœ‰åª’ä½“ç›¸å…³æ¥å£ |
| å®ç°è§†é¢‘æµ+Rangeè¯·æ±‚ | 0.5å¤© | å¤§è§†é¢‘æ‹–æ‹½å¿…éœ€ |
| å®ç°æ³¢å½¢å³°å€¼æ¥å£ | 0.5å¤© | wavesurfer.js å¿…éœ€ |
| å®ç°Proxyè§†é¢‘ç”Ÿæˆ | 1å¤© | è§†é¢‘æ ¼å¼å…¼å®¹å¿…éœ€ |

### P1 - æå‡ä½“éªŒï¼ˆå¯ä¸å‰ç«¯å¹¶è¡Œå¼€å‘ï¼‰

| ä»»åŠ¡ | å·¥ä½œé‡ä¼°è®¡ | è¯´æ˜ |
|------|-----------|------|
| å®ç°è§†é¢‘ç¼©ç•¥å›¾æ¥å£ | 0.5å¤© | æ—¶é—´è½´é¢„è§ˆåŠŸèƒ½ |
| å®ç°SRTå†…å®¹è·å–/ä¿å­˜æ¥å£ | 0.5å¤© | å­—å¹•ç¼–è¾‘ä¿å­˜ |
| ä»»åŠ¡å®Œæˆè‡ªåŠ¨é¢„å¤„ç† | 0.5å¤© | ä¼˜åŒ–ç¼–è¾‘å™¨åŠ è½½é€Ÿåº¦ |
| JobStateæ¨¡å‹æ‰©å±• | 0.5å¤© | çŠ¶æ€è¿½è¸ªå¢å¼º |

### P2 - åç»­ä¼˜åŒ–

| ä»»åŠ¡ | å·¥ä½œé‡ä¼°è®¡ | è¯´æ˜ |
|------|-----------|------|
| æ³¢å½¢æ•°æ®å†…å­˜ä¼˜åŒ– | 0.5å¤© | ä½¿ç”¨ audiowaveform å·¥å…· |
| Proxyè§†é¢‘è¿›åº¦æ¨é€ | 0.5å¤© | SSEæ¨é€ç”Ÿæˆè¿›åº¦ |
| ç¼©ç•¥å›¾Spriteå›¾ä¼˜åŒ– | 0.5å¤© | åˆå¹¶ä¸ºå•å¼ å›¾ç‰‡å‡å°‘è¯·æ±‚ |

---

## å…­ã€æŠ€æœ¯è¦ç‚¹ä¸æ³¨æ„äº‹é¡¹

### 6.1 æ³¢å½¢æ•°æ®ç”Ÿæˆçš„å†…å­˜é—®é¢˜

**é—®é¢˜ï¼š** ä½¿ç”¨ pydub åŠ è½½2å°æ—¶éŸ³é¢‘å¯èƒ½å ç”¨ 2GB+ å†…å­˜

**è§£å†³æ–¹æ¡ˆï¼š**
1. **æ¨èï¼š** ä½¿ç”¨ Python wave æ¨¡å—æµå¼è¯»å–
2. **å¤‡é€‰ï¼š** ä½¿ç”¨ audiowaveform å‘½ä»¤è¡Œå·¥å…·ï¼ˆC++å®ç°ï¼Œæå¿«ï¼‰

```python
# å†…å­˜å®‰å…¨çš„æ³¢å½¢ç”Ÿæˆ
import wave
import struct

def generate_peaks(audio_path: Path, samples: int = 2000):
    with wave.open(str(audio_path), 'rb') as wav:
        frame_rate = wav.getframerate()
        n_frames = wav.getnframes()
        sample_width = wav.getsampwidth()

        chunk_frames = n_frames // samples
        peaks = []

        for i in range(samples):
            frames_data = wav.readframes(chunk_frames)
            # è§£æå¹¶è®¡ç®— min/max
            # ...

        return peaks
```

### 6.2 Rangeè¯·æ±‚å®ç°è¦ç‚¹

```python
from fastapi import Request
from fastapi.responses import StreamingResponse

def serve_video_with_range(video_path: Path, request: Request):
    file_size = video_path.stat().st_size
    range_header = request.headers.get("range")

    if not range_header:
        # æ— Rangeè¯·æ±‚ï¼Œè¿”å›å®Œæ•´æ–‡ä»¶
        return FileResponse(video_path)

    # è§£æ Range: bytes=start-end
    byte_range = range_header.replace("bytes=", "").split("-")
    start = int(byte_range[0]) if byte_range[0] else 0
    end = int(byte_range[1]) if len(byte_range) > 1 and byte_range[1] else file_size - 1

    def file_iterator():
        with open(video_path, "rb") as f:
            f.seek(start)
            remaining = end - start + 1
            while remaining > 0:
                chunk = f.read(min(8192, remaining))
                if not chunk:
                    break
                yield chunk
                remaining -= len(chunk)

    headers = {
        "Content-Range": f"bytes {start}-{end}/{file_size}",
        "Accept-Ranges": "bytes",
        "Content-Length": str(end - start + 1),
    }

    return StreamingResponse(
        file_iterator(),
        status_code=206,
        media_type="video/mp4",
        headers=headers
    )
```

### 6.3 å¼‚æ­¥Proxyè§†é¢‘ç”Ÿæˆ

```python
import asyncio

async def generate_proxy_video(source: Path, output: Path):
    """å¼‚æ­¥ç”ŸæˆProxyè§†é¢‘ï¼Œä¸é˜»å¡ä¸»æµç¨‹"""
    if output.exists():
        return

    cmd = [
        config.get_ffmpeg_command(),
        '-i', str(source),
        '-vf', 'scale=-2:720',
        '-c:v', 'libx264', '-preset', 'fast', '-crf', '28',
        '-c:a', 'aac', '-b:a', '128k',
        '-y', str(output)
    ]

    process = await asyncio.create_subprocess_exec(
        *cmd,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE
    )
    await process.communicate()
```

### 6.4 è§†é¢‘æ ¼å¼æ£€æµ‹

```python
# æµè§ˆå™¨å…¼å®¹æ ¼å¼
BROWSER_COMPATIBLE = {'.mp4', '.webm'}

# éœ€è¦è½¬ç çš„æ ¼å¼
NEED_TRANSCODE = {'.mkv', '.avi', '.mov', '.wmv', '.flv'}

def needs_proxy(video_path: Path) -> bool:
    suffix = video_path.suffix.lower()

    if suffix in NEED_TRANSCODE:
        return True

    if suffix == '.mp4':
        # å¯é€‰ï¼šæ£€æµ‹æ˜¯å¦ä¸ºH.265ç¼–ç 
        # ä½¿ç”¨ ffprobe æ£€æµ‹ç¼–ç æ ¼å¼
        pass

    return False
```

---

## ä¸ƒã€æ–‡ä»¶ç»“æ„é¢„è§ˆï¼ˆæ–°å¢éƒ¨åˆ†ï¼‰

```
backend/app/
â”œâ”€â”€ api/routes/
â”‚   â”œâ”€â”€ transcription_routes.py  # å·²æœ‰
â”‚   â”œâ”€â”€ model_routes.py          # å·²æœ‰
â”‚   â”œâ”€â”€ hardware_routes.py       # å·²æœ‰
â”‚   â”œâ”€â”€ file_routes.py           # å·²æœ‰
â”‚   â””â”€â”€ media_routes.py          # ğŸ†• æ–°å¢
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ transcription_service.py # ä¿®æ”¹ï¼šæ·»åŠ åå¤„ç†è°ƒç”¨
â”‚   â”œâ”€â”€ ...                      # å·²æœ‰æœåŠ¡
â”‚   â””â”€â”€ media_service.py         # ğŸ†• æ–°å¢ï¼ˆå¯é€‰ï¼Œå°è£…åª’ä½“å¤„ç†é€»è¾‘ï¼‰
â””â”€â”€ models/
    â””â”€â”€ job_models.py            # ä¿®æ”¹ï¼šæ‰©å±•å­—æ®µ
```

---

## å…«ã€æµ‹è¯•éªŒè¯æ¸…å•

### 8.1 è§†é¢‘æµæ¥å£æµ‹è¯•

```bash
# æµ‹è¯•Rangeè¯·æ±‚
curl -I -H "Range: bytes=0-1023" http://localhost:8000/api/media/{job_id}/video

# é¢„æœŸè¿”å›ï¼š
# HTTP/1.1 206 Partial Content
# Content-Range: bytes 0-1023/1234567890
# Accept-Ranges: bytes
```

### 8.2 æ³¢å½¢æ•°æ®æ¥å£æµ‹è¯•

```bash
curl http://localhost:8000/api/media/{job_id}/peaks?samples=2000

# é¢„æœŸè¿”å›ï¼š
# {"peaks": [...], "duration": 180.5}
```

### 8.3 Proxyè§†é¢‘æµ‹è¯•

```bash
# 1. ä¸Šä¼ MKVæ ¼å¼è§†é¢‘
# 2. å®Œæˆè½¬å½•
# 3. æ£€æŸ¥ProxyçŠ¶æ€
curl http://localhost:8000/api/media/{job_id}/proxy-status

# 4. ç­‰å¾…ç”Ÿæˆå®Œæˆåè¯·æ±‚è§†é¢‘
curl http://localhost:8000/api/media/{job_id}/video
```

---

## ä¹ã€æ€»ç»“

### å¿…é¡»å®Œæˆçš„æ ¸å¿ƒå·¥ä½œ

1. **æ–°å»º media_routes.py** - åª’ä½“èµ„æºè·¯ç”±ï¼ˆè§†é¢‘æµã€éŸ³é¢‘ã€æ³¢å½¢ã€ç¼©ç•¥å›¾ï¼‰
2. **å®ç° Range è¯·æ±‚æ”¯æŒ** - å¤§è§†é¢‘æ‹–æ‹½è·³è½¬
3. **å®ç°æ³¢å½¢å³°å€¼ç”Ÿæˆ** - æµå¼å¤„ç†ï¼Œé¿å…OOM
4. **å®ç° Proxy è§†é¢‘ç”Ÿæˆ** - è§£å†³æµè§ˆå™¨å…¼å®¹æ€§

### å¯é€‰å¢å¼ºå·¥ä½œ

1. æ‰©å±• JobState æ¨¡å‹ï¼Œè¿½è¸ªåª’ä½“çŠ¶æ€
2. è½¬å½•å®Œæˆåè‡ªåŠ¨é¢„å¤„ç†
3. SRT å†…å®¹è·å–/ä¿å­˜æ¥å£

### å·¥ä½œé‡ä¼°è®¡

- **P0 ä»»åŠ¡**ï¼šçº¦ 4-5 ä¸ªå·¥ä½œæ—¥
- **P1 ä»»åŠ¡**ï¼šçº¦ 2 ä¸ªå·¥ä½œæ—¥
- **æ€»è®¡**ï¼šçº¦ 1 å‘¨æ—¶é—´

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š2025-11-25*
*åŸºäºï¼šç•Œé¢é‡æ„è¯¦ç»†å¼€å‘æŒ‡å— v3.1*
