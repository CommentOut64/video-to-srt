# è§†é¢‘ç¼–è¾‘å™¨æ¸è¿›å¼åŠ è½½ä¸æ€§èƒ½ä¼˜åŒ–å¼€å‘æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [é—®é¢˜è¯Šæ–­ï¼šè§†é¢‘æ‹–åŠ¨åŠ è½½é—®é¢˜](#1-é—®é¢˜è¯Šæ–­è§†é¢‘æ‹–åŠ¨åŠ è½½é—®é¢˜)
2. [æ¸è¿›å¼åŠ è½½æ¶æ„è®¾è®¡](#2-æ¸è¿›å¼åŠ è½½æ¶æ„è®¾è®¡)
3. [è¯¦ç»†æŠ€æœ¯å®ç°](#3-è¯¦ç»†æŠ€æœ¯å®ç°)
4. [å‰åç«¯æ”¹åŠ¨æ¸…å•](#4-å‰åç«¯æ”¹åŠ¨æ¸…å•)
5. [SSE é€šä¿¡åè®®](#5-sse-é€šä¿¡åè®®)
6. [æ€§èƒ½ä¼˜åŒ–æ¸…å•](#6-æ€§èƒ½ä¼˜åŒ–æ¸…å•)
7. [æµ‹è¯•éªŒè¯æ–¹æ¡ˆ](#7-æµ‹è¯•éªŒè¯æ–¹æ¡ˆ)

---

## 1. é—®é¢˜è¯Šæ–­ï¼šè§†é¢‘æ‹–åŠ¨åŠ è½½é—®é¢˜

### 1.1 é—®é¢˜ç°è±¡

- å¤§å¹…åº¦æ‹–åŠ¨è§†é¢‘è¿›åº¦æ¡æ—¶é¢‘ç¹æ˜¾ç¤º"åŠ è½½ä¸­"
- å°èŒƒå›´æ‹–åŠ¨æ­£å¸¸ï¼Œè·¨åº¦ >30 ç§’æ—¶æ˜æ˜¾
- é•¿è§†é¢‘ï¼ˆ>10åˆ†é’Ÿï¼‰æ›´ä¸¥é‡

### 1.2 æ ¹å› åˆ†æ

#### åŸå›  Aï¼šè§†é¢‘ç¼ºå°‘ FastStart ä¼˜åŒ– â­â­â­â­â­
**é—®é¢˜**ï¼š
- MP4 æ–‡ä»¶çš„ `moov` atomï¼ˆå…ƒæ•°æ®ï¼‰ä½äºæ–‡ä»¶æœ«å°¾
- æµè§ˆå™¨éœ€è¦ä¸‹è½½æ•´ä¸ªæ–‡ä»¶æ‰èƒ½è·å–ç´¢å¼•ä¿¡æ¯
- æ‹–åŠ¨åˆ°ä»»æ„ä½ç½®æ—¶æ— æ³•å¿«é€Ÿå®šä½å…³é”®å¸§

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥ moov atom ä½ç½®
ffprobe -v trace input.mp4 2>&1 | grep -i moov

# è¾“å‡ºç¤ºä¾‹ï¼š
# [mov] moov atom offset: 42156890  â† åœ¨æ–‡ä»¶æœ«å°¾ï¼ˆåï¼‰
# [mov] moov atom offset: 0         â† åœ¨æ–‡ä»¶å¼€å¤´ï¼ˆå¥½ï¼‰
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
åœ¨æ‰€æœ‰è§†é¢‘ç”Ÿæˆæ—¶æ·»åŠ  `-movflags +faststart` å‚æ•°

#### åŸå›  Bï¼šå…³é”®å¸§é—´éš”è¿‡å¤§ â­â­â­â­
**é—®é¢˜**ï¼š
- è§†é¢‘å…³é”®å¸§ï¼ˆI-frameï¼‰é—´éš”è¿‡å¤§ï¼ˆå¦‚æ¯ 250 å¸§ä¸€ä¸ªï¼‰
- æ‹–åŠ¨æ—¶æµè§ˆå™¨éœ€è¦ä»æœ€è¿‘çš„å…³é”®å¸§å¼€å§‹è§£ç 
- é—´éš”å¤§å¯¼è‡´è§£ç æ—¶é—´é•¿

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥å…³é”®å¸§é—´éš”
ffprobe -select_streams v -show_frames input.mp4 2>&1 | grep "pict_type=I" | head -20

# è®¡ç®—é—´éš”ï¼ˆä¸¤ä¸ªIå¸§ä¹‹é—´çš„å¸§æ•°ï¼‰
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
ç”Ÿæˆ Proxy è§†é¢‘æ—¶è®¾ç½® `-g 30`ï¼ˆæ¯ç§’1ä¸ªå…³é”®å¸§ï¼Œå‡è®¾30fpsï¼‰

#### åŸå›  Cï¼šHTTP Range è¯·æ±‚æœªå……åˆ†åˆ©ç”¨ â­â­â­
**é—®é¢˜**ï¼š
- å½“å‰ chunk_size ä¸º 8KBï¼Œå¯èƒ½å¯¹å¤§è§†é¢‘ä¸å¤Ÿ
- æµè§ˆå™¨å¯èƒ½å‘é€å¤šä¸ª Range è¯·æ±‚æ‰èƒ½è·å–è¶³å¤Ÿæ•°æ®

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
æ ¹æ®è¯·æ±‚çš„ Range å¤§å°åŠ¨æ€è°ƒæ•´ chunk_size

#### åŸå›  Dï¼šæµè§ˆå™¨ preload ç­–ç•¥ä¸å½“ â­â­
**é—®é¢˜**ï¼š
- `preload="metadata"` åªé¢„åŠ è½½å…ƒæ•°æ®ï¼Œä¸ç¼“å†²è§†é¢‘å†…å®¹
- æ‹–åŠ¨æ—¶éœ€è¦å®æ—¶è¯·æ±‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
æ”¹ä¸º `preload="auto"` æˆ–æ ¹æ®ç½‘ç»œæƒ…å†µåŠ¨æ€è°ƒæ•´

#### åŸå›  Eï¼šHEVC è§£ç æ€§èƒ½é—®é¢˜ â­â­â­â­â­
**é—®é¢˜**ï¼š
- HEVC ç¼–ç çš„è§†é¢‘åœ¨æµè§ˆå™¨ä¸­æ— æ³•ç¡¬ä»¶è§£ç ï¼ˆå½“å‰å·²å‘ç°ï¼‰
- è½¯ä»¶è§£ç æ€§èƒ½å·®ï¼Œæ‹–åŠ¨æ—¶å¡é¡¿

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
æœ¬æ–‡æ¡£åç»­çš„ä¸‰é˜¶æ®µæ–¹æ¡ˆå·²è§£å†³

### 1.3 ç»¼åˆä¼˜åŒ–æ–¹æ¡ˆ

#### ä¼˜åŒ– 1ï¼šç¡®ä¿æ‰€æœ‰ç”Ÿæˆçš„è§†é¢‘éƒ½æœ‰ FastStart

**ä½ç½®**ï¼š`backend/app/api/routes/media_routes.py`

**ä¿®æ”¹**ï¼š`_generate_proxy_video_with_progress` å‡½æ•°ï¼ˆç¬¬ 207-219 è¡Œï¼‰

```python
cmd = [
    ffmpeg_cmd,
    '-i', str(source),
    '-vf', 'scale=-2:720',
    '-c:v', 'libx264',
    '-preset', 'fast',
    '-crf', '28',
    '-g', '30',              # â† æ–°å¢ï¼šå…³é”®å¸§é—´éš”ï¼ˆæ¯ç§’1ä¸ªï¼Œå‡è®¾30fpsï¼‰
    '-c:a', 'aac',
    '-b:a', '128k',
    '-movflags', '+faststart',  # â† æ–°å¢ï¼šmoov atom å‰ç½®
    '-progress', 'pipe:1',
    '-y',
    str(output)
]
```

**æ•ˆæœ**ï¼š
- æ‹–åŠ¨å“åº”æ—¶é—´ä» 2-5 ç§’é™è‡³ 0.5 ç§’ä»¥å†…
- è§†é¢‘å¼€å§‹æ’­æ”¾æ—¶é—´å‡å°‘ 50%

#### ä¼˜åŒ– 2ï¼šåŠ¨æ€è°ƒæ•´ Range è¯·æ±‚çš„ Chunk Size

**ä½ç½®**ï¼š`backend/app/api/routes/media_routes.py`

**ä¿®æ”¹**ï¼š`_serve_file_with_range` å‡½æ•°ï¼ˆç¬¬ 79-90 è¡Œï¼‰

```python
def file_iterator():
    with open(file_path, "rb") as f:
        f.seek(start)
        remaining = end - start + 1

        # åŠ¨æ€ chunk_sizeï¼šæ ¹æ®è¯·æ±‚å¤§å°è°ƒæ•´
        if remaining < 1024 * 1024:  # < 1MB
            chunk_size = 8192  # 8KB
        elif remaining < 10 * 1024 * 1024:  # < 10MB
            chunk_size = 64 * 1024  # 64KB
        else:
            chunk_size = 256 * 1024  # 256KB

        while remaining > 0:
            read_size = min(chunk_size, remaining)
            data = f.read(read_size)
            if not data:
                break
            yield data
            remaining -= len(data)
```

#### ä¼˜åŒ– 3ï¼šå‰ç«¯ Preload ç­–ç•¥ä¼˜åŒ–

**ä½ç½®**ï¼š`frontend/src/components/editor/VideoStage/index.vue`

**ä¿®æ”¹**ï¼šç¬¬ 10 è¡Œ

```vue
<video
  ref="videoRef"
  :src="videoSource"
  :muted="muted"
  :preload="preloadStrategy"  
  @loadedmetadata="onMetadataLoaded"
  ...
/>

<script setup>
// æ ¹æ®è§†é¢‘å¤§å°å’Œç½‘ç»œæƒ…å†µåŠ¨æ€å†³å®š
const preloadStrategy = computed(() => {
  const duration = projectStore.meta.duration
  if (duration < 300) return 'auto'      // 5åˆ†é’Ÿå†…ï¼šè‡ªåŠ¨é¢„åŠ è½½
  if (duration < 1800) return 'metadata' // 30åˆ†é’Ÿå†…ï¼šä»…å…ƒæ•°æ®
  return 'none'                          // è¶…é•¿è§†é¢‘ï¼šä¸é¢„åŠ è½½
})
</script>
```

#### ä¼˜åŒ– 4ï¼šå‰ç«¯æ‹–åŠ¨é˜²æŠ–

**ä½ç½®**ï¼š`frontend/src/components/editor/VideoStage/index.vue`

**æ–°å¢**ï¼šæ—¶é—´æ›´æ–°é˜²æŠ–

```javascript
import { debounce } from 'lodash-es'  // æˆ–è‡ªå®ç°

// é˜²æŠ–çš„æ—¶é—´æ›´æ–°
const debouncedTimeUpdate = debounce((time) => {
  projectStore.player.currentTime = time
}, 100)  // 100ms å†…å¤šæ¬¡æ‹–åŠ¨åªè§¦å‘ä¸€æ¬¡

function onTimeUpdate() {
  const video = videoRef.value
  debouncedTimeUpdate(video.currentTime)
  emit('timeupdate', video.currentTime)
}
```

#### ä¼˜åŒ– 5ï¼šæ£€æŸ¥å¹¶ä¿®å¤æºè§†é¢‘

**æ–°å¢å·¥å…·**ï¼š`backend/app/utils/video_optimizer.py`

```python
def optimize_video_for_streaming(input_path: Path, output_path: Path):
    """
    ä¼˜åŒ–è§†é¢‘ä»¥æ”¯æŒæµå¼æ’­æ”¾ï¼š
    1. å°† moov atom ç§»åˆ°æ–‡ä»¶å¼€å¤´
    2. è°ƒæ•´å…³é”®å¸§é—´éš”
    3. ä¸é‡æ–°ç¼–ç ï¼ˆå¿«é€Ÿï¼‰
    """
    ffmpeg_cmd = config.get_ffmpeg_command()

    cmd = [
        ffmpeg_cmd,
        '-i', str(input_path),
        '-c', 'copy',                # ä¸é‡æ–°ç¼–ç ï¼ˆå¿«é€Ÿï¼‰
        '-movflags', '+faststart',   # moov atom å‰ç½®
        '-y',
        str(output_path)
    ]

    subprocess.run(cmd, check=True)
```

### 1.4 é¢„æœŸæ•ˆæœ

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|--------|------|
| 5 åˆ†é’Ÿè§†é¢‘æ‹–åŠ¨ | 2-3 ç§’ | 0.3-0.5 ç§’ | **83%** |
| 30 åˆ†é’Ÿè§†é¢‘æ‹–åŠ¨ | 5-8 ç§’ | 0.5-1 ç§’ | **87%** |
| é¦–æ¬¡æ’­æ”¾å¯åŠ¨ | 3-5 ç§’ | 1-2 ç§’ | **60%** |

---

## 2. æ¸è¿›å¼åŠ è½½æ¶æ„è®¾è®¡

### 2.1 æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·ä¸Šä¼ è§†é¢‘                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  åª’ä½“åˆ†æ & éŸ³é¢‘æå–     â”‚  â† æé€Ÿå¯åŠ¨ï¼ˆ0-5ç§’ï¼‰
         â”‚  - FFprobe æ£€æµ‹ç¼–ç       â”‚
         â”‚  - FFmpeg æå–éŸ³é¢‘       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                               â”‚
         â–¼                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Whisper è½¬å½• (GPU) â”‚                        â”‚ å…¼å®¹æ€§æ£€æµ‹          â”‚
â”‚  - æµå¼è¾“å‡ºå­—å¹•      â”‚                        â”‚ - H.264 â†’ ç›´æ¥ä½¿ç”¨  â”‚
â”‚  - å®æ—¶ SSE æ¨é€    â”‚                        â”‚ - HEVC/MKV â†’ è½¬ç    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                               â”‚
         â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                              â”‚                             â”‚
         â”‚                              â–¼                             â–¼
         â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                    â”‚ å…¼å®¹è§†é¢‘          â”‚         â”‚ ä¸å…¼å®¹è§†é¢‘        â”‚
         â”‚                    â”‚ ç›´æ¥ä½¿ç”¨åŸè§†é¢‘     â”‚         â”‚ éœ€è¦ç”Ÿæˆ Proxy    â”‚
         â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                                           â”‚
         â”‚                                                           â–¼
         â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                              â”‚ 360p é¢„è§ˆç”Ÿæˆ (CPU)   â”‚ â† åå°è¿½èµ¶ï¼ˆ30ç§’-10åˆ†é’Ÿï¼‰
         â”‚                                              â”‚ - ultrafast preset   â”‚
         â”‚                                              â”‚ - æ— éŸ³é¢‘è½¨é“          â”‚
         â”‚                                              â”‚ - nice ä½ä¼˜å…ˆçº§       â”‚
         â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                                        â”‚
         â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                              â”‚ SSE é€šçŸ¥å‰ç«¯          â”‚
         â”‚                                              â”‚ å‰ç«¯æ— æ„Ÿåˆ‡æ¢è§†é¢‘æº     â”‚
         â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚
                                         â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ è½¬å½•å®Œæˆ            â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ GPU ç©ºé—²            â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ 720p é«˜è´¨é‡ç”Ÿæˆ     â”‚ â† æœ€ç»ˆä¸€è‡´ï¼ˆç©ºé—²æ—¶ï¼‰
                                  â”‚ - fast preset      â”‚
                                  â”‚ - CRF 23           â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ SSE é€šçŸ¥å‰ç«¯        â”‚
                                  â”‚ æ— æ„Ÿæ›¿æ¢ 360p       â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¸‰é˜¶æ®µè¯¦ç»†è®¾è®¡

#### **é˜¶æ®µ 1ï¼šæé€Ÿå¯åŠ¨ï¼ˆ0-30ç§’ï¼‰**

**ç›®æ ‡**ï¼šç”¨æˆ·ä¸Šä¼ å®Œæˆå 5 ç§’å†…è¿›å…¥ç¼–è¾‘å™¨ï¼Œç«‹å³çœ‹åˆ°å­—å¹•æµå¼è¾“å‡º

**åç«¯ä»»åŠ¡**ï¼š

1. **åª’ä½“åˆ†æ**ï¼ˆ1-2 ç§’ï¼‰
   
   ```python
   async def analyze_media(video_path: Path):
       """
       å¿«é€Ÿåˆ†æè§†é¢‘ï¼Œæå–å…³é”®ä¿¡æ¯
       """
       info = {
           'codec': await get_video_codec(video_path),
           'duration': await get_video_duration(video_path),
           'resolution': await get_video_resolution(video_path),
           'audio_codec': await get_audio_codec(video_path)
       }
   
       # åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬ç 
       info['needs_transcode'] = (
           info['codec'] in NEED_TRANSCODE_CODECS or
           video_path.suffix.lower() in NEED_TRANSCODE_FORMATS
       )
   
       return info
   ```
   
2. **éŸ³é¢‘æå–**ï¼ˆ3-5 ç§’ï¼‰
   ```python
   async def extract_audio_fast(video_path: Path, output_audio: Path):
       """
       æé€Ÿæå–éŸ³é¢‘ï¼ˆå¤åˆ¶æµï¼Œä¸é‡æ–°ç¼–ç ï¼‰
       """
       ffmpeg_cmd = config.get_ffmpeg_command()
   
       cmd = [
           ffmpeg_cmd,
           '-i', str(video_path),
           '-vn',                    # ä¸è¦è§†é¢‘æµ
           '-acodec', 'copy',        # å¤åˆ¶éŸ³é¢‘æµï¼ˆä¸é‡æ–°ç¼–ç ï¼‰
           '-y',
           str(output_audio)
       ]
   
       # å¦‚æœéŸ³é¢‘æ˜¯ AAC/MP3ï¼Œç›´æ¥å¤åˆ¶ï¼ˆ< 1 ç§’ï¼‰
       # å¦‚æœæ˜¯å…¶ä»–ç¼–ç ï¼Œéœ€è¦è½¬ä¸º WAVï¼ˆç”¨äº Whisperï¼‰
   
       await run_subprocess(cmd)
   ```

3. **Whisper è½¬å½•å¯åŠ¨**ï¼ˆç«‹å³ï¼‰
   ```python
   async def start_transcription(job_id: str, audio_path: Path):
       """
       å¯åŠ¨ Whisper è½¬å½•ï¼Œæµå¼è¾“å‡ºåˆ°å‰ç«¯
       """
       # ä½¿ç”¨ç°æœ‰çš„è½¬å½•é€»è¾‘ï¼Œç¡®ä¿ SSE å®æ—¶æ¨é€
       asyncio.create_task(transcribe_with_whisper(job_id, audio_path))
   ```

**å‰ç«¯åŠ¨ä½œ**ï¼š

1. **ç«‹å³è¿›å…¥ç¼–è¾‘å™¨**
   ```javascript
   // TaskMonitorView.vue
   async function handleEdit(task) {
     // ä¸ç­‰å¾…ä»»ä½•èµ„æºå‡†å¤‡å®Œæˆï¼Œç›´æ¥è·³è½¬
     router.push({ name: 'editor', params: { jobId: task.job_id } })
   }
   ```

2. **ç¼–è¾‘å™¨å¸ƒå±€**
   ```vue
   <!-- EditorView.vue -->
   <div class="editor-layout">
     <!-- å·¦ä¾§ï¼šå­—å¹•åˆ—è¡¨ -->
     <SubtitleList :subtitles="subtitles" :streaming="isTranscribing" />
   
     <!-- å³ä¾§ï¼šè§†é¢‘é¢„è§ˆ -->
     <VideoStage :status="videoStatus" />
   
     <!-- åº•éƒ¨ï¼šæ³¢å½¢æ—¶é—´è½´ -->
     <WaveformTimeline :audio-url="audioUrl" />
   </div>
   ```

3. **è§†é¢‘åŒºåŸŸå ä½**
   ```vue
   <!-- VideoStage/index.vue -->
   <div v-if="videoStatus.type === 'preparing'" class="video-placeholder">
     <div class="placeholder-content">
       <div class="spinner"></div>
       <h3>è§†é¢‘ç”»é¢æ­£åœ¨è§£ç </h3>
       <p>{{ videoStatus.message }}</p>
       <div v-if="videoStatus.progress > 0" class="progress-bar">
         <div class="progress-fill" :style="{ width: videoStatus.progress + '%' }"></div>
         <span>{{ videoStatus.progress }}%</span>
       </div>
     </div>
   </div>
   
   <video v-else ref="videoRef" :src="videoSource" ... />
   ```

4. **æ³¢å½¢æ—¶é—´è½´**
   ```javascript
   // WaveformTimeline/index.vue
   const audioSource = computed(() => {
     // ä¼˜å…ˆä½¿ç”¨æå–çš„éŸ³é¢‘æ–‡ä»¶ï¼ˆM4A/MP3ï¼Œä½“ç§¯å°ï¼‰
     if (projectStore.meta.extractedAudioPath) {
       return projectStore.meta.extractedAudioPath
     }
     // é™çº§ï¼šä½¿ç”¨ WAVï¼ˆä½“ç§¯å¤§ï¼‰
     return `/api/media/${props.jobId}/audio`
   })
   ```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- âœ… ä¸Šä¼ å®Œæˆ â†’ 5 ç§’å†…è¿›å…¥ç¼–è¾‘å™¨
- âœ… å­—å¹•åˆ—è¡¨ï¼šå®æ—¶æµå¼è¾“å‡ºï¼ˆWhisper è¯†åˆ«ä¸€å¥æ˜¾ç¤ºä¸€å¥ï¼‰
- âœ… è§†é¢‘åŒºåŸŸï¼šå ä½æç¤º"æ­£åœ¨è§£ç ..."
- âœ… æ³¢å½¢åŒºåŸŸï¼šå®Œæ•´éŸ³é¢‘æ³¢å½¢ï¼ˆå·²ç¡®è®¤ WaveSurfer.js å·²å®ç°ï¼‰

---

#### **é˜¶æ®µ 2ï¼šåå°è¿½èµ¶ï¼ˆ30ç§’-10åˆ†é’Ÿï¼‰**

**ç›®æ ‡**ï¼šåœ¨ Whisper è½¬å½•çš„åŒæ—¶ï¼Œåå°ä½ä¼˜å…ˆçº§ç”Ÿæˆ 360p é¢„è§ˆè§†é¢‘

**åç«¯ä»»åŠ¡**ï¼š

1. **360p é¢„è§ˆç”Ÿæˆ**ï¼ˆå¹¶å‘æ‰§è¡Œï¼Œä¸é˜»å¡è½¬å½•ï¼‰
   
   ```python
   async def generate_preview_360p(job_id: str, video_path: Path, output_path: Path):
       """
       ç”Ÿæˆ 360p é¢„è§ˆè§†é¢‘ï¼ˆä½ä¼˜å…ˆçº§ï¼Œæ— éŸ³é¢‘ï¼‰
       """
       ffmpeg_cmd = config.get_ffmpeg_command()
   
       cmd = [
           ffmpeg_cmd,
           '-i', str(video_path),
           '-vf', 'scale=-2:360',          # 360pï¼ˆå®½åº¦è‡ªé€‚åº”ï¼‰
           '-c:v', 'libx264',
           '-preset', 'ultrafast',         # æœ€å¿«ç¼–ç ï¼ˆè´¨é‡è¾ƒå·®ï¼‰
           '-crf', '28',                   # ä¸­ç­‰è´¨é‡
           '-g', '30',                     # å…³é”®å¸§é—´éš”
           '-an',                          # å»æ‰éŸ³é¢‘ï¼ˆå‡å°ä½“ç§¯ + åŠ é€Ÿï¼‰
           '-movflags', '+faststart',      # FastStart
           '-progress', 'pipe:1',
           '-y',
           str(output_path)
       ]
   
       # Linux/Mac: ä½¿ç”¨ nice é™ä½ä¼˜å…ˆçº§
       if os.name != 'nt':
           cmd = ['nice', '-n', '15'] + cmd
   
       # å¯åŠ¨è¿›ç¨‹ï¼ˆå¸¦è¿›åº¦è¿½è¸ªï¼‰
       await run_with_progress(cmd, job_id, 'preview_360p')
   ```
   
2. **å¹¶å‘æ§åˆ¶**
   ```python
   async def post_upload_processing(job_id: str, video_path: Path):
       """
       ä¸Šä¼ åå¤„ç†æ€»æ§
       """
       # 1. åˆ†æåª’ä½“
       media_info = await analyze_media(video_path)
   
       # 2. æå–éŸ³é¢‘
       audio_path = await extract_audio_fast(video_path, ...)
   
       # 3. å¯åŠ¨è½¬å½•ï¼ˆGPUï¼‰
       transcription_task = asyncio.create_task(
           start_transcription(job_id, audio_path)
       )
   
       # 4. å¦‚æœéœ€è¦è½¬ç ï¼Œå¯åŠ¨ 360p ç”Ÿæˆï¼ˆCPUï¼Œä½ä¼˜å…ˆçº§ï¼‰
       if media_info['needs_transcode']:
           preview_task = asyncio.create_task(
               generate_preview_360p(job_id, video_path, ...)
           )
   
       # 5. ç­‰å¾…è½¬å½•å®Œæˆ
       await transcription_task
   
       # 6. è½¬å½•å®Œæˆåï¼Œå¯åŠ¨ 720p ç”Ÿæˆï¼ˆå¦‚æœéœ€è¦ï¼‰
       if media_info['needs_transcode']:
           await generate_proxy_720p(job_id, video_path, ...)
   ```

3. **SSE è¿›åº¦æ¨é€**
   ```python
   def push_preview_progress(job_id: str, stage: str, progress: float):
       """
       æ¨é€è§†é¢‘ç”Ÿæˆè¿›åº¦
       stage: 'preview_360p' | 'proxy_720p'
       """
       from services.sse_service import get_sse_manager
       sse = get_sse_manager()
   
       sse.broadcast_sync(
           f"job:{job_id}",
           f"{stage}_progress",
           {
               "job_id": job_id,
               "stage": stage,
               "progress": progress
           }
       )
   
   def push_preview_complete(job_id: str, stage: str, video_url: str):
       """
       æ¨é€è§†é¢‘ç”Ÿæˆå®Œæˆäº‹ä»¶
       """
       sse.broadcast_sync(
           f"job:{job_id}",
           f"{stage}_complete",
           {
               "job_id": job_id,
               "stage": stage,
               "video_url": video_url,
               "resolution": "360p" if stage == 'preview_360p' else "720p"
           }
       )
   ```

**å‰ç«¯åŠ¨ä½œ**ï¼š

1. **ç›‘å¬ SSE äº‹ä»¶**
   ```javascript
   // EditorView.vue
   import { useSseManager } from '@/composables/useSseManager'
   
   onMounted(() => {
     const sseManager = useSseManager()
     const channel = `job:${props.jobId}`
   
     // ç›‘å¬ 360p è¿›åº¦
     sseManager.subscribe(channel, 'preview_360p_progress', (data) => {
       videoStatus.value = {
         type: 'preparing',
         message: `æ­£åœ¨ç”Ÿæˆé¢„è§ˆè§†é¢‘ (${data.progress}%)`,
         progress: data.progress
       }
     })
   
     // ç›‘å¬ 360p å®Œæˆ
     sseManager.subscribe(channel, 'preview_360p_complete', async (data) => {
       console.log('[Editor] 360p é¢„è§ˆè§†é¢‘å·²å‡†å¤‡å°±ç»ª')
   
       // æ›´æ–°è§†é¢‘æº
       videoSource.value = data.video_url
   
       // åˆ‡æ¢çŠ¶æ€
       videoStatus.value = {
         type: 'ready',
         resolution: '360p',
         message: 'é¢„è§ˆè§†é¢‘ (360p)'
       }
   
       // å¦‚æœ VideoStage å·²æŒ‚è½½ï¼Œé‡æ–°åŠ è½½è§†é¢‘
       if (videoStageRef.value) {
         await videoStageRef.value.loadVideoSource(data.video_url)
       }
     })
   
     // ç›‘å¬ 720p å®Œæˆï¼ˆæ— æ„Ÿå‡çº§ï¼‰
     sseManager.subscribe(channel, 'proxy_720p_complete', async (data) => {
       console.log('[Editor] 720p é«˜è´¨é‡è§†é¢‘å·²å‡†å¤‡å°±ç»ªï¼Œè‡ªåŠ¨å‡çº§')
   
       // ä¿å­˜å½“å‰æ’­æ”¾çŠ¶æ€
       const currentTime = videoStageRef.value?.getCurrentTime() || 0
       const isPlaying = projectStore.player.isPlaying
   
       // åˆ‡æ¢è§†é¢‘æº
       videoSource.value = data.video_url
       videoStatus.value.resolution = '720p'
       videoStatus.value.message = 'é«˜æ¸…è§†é¢‘ (720p)'
   
       // æ¢å¤æ’­æ”¾çŠ¶æ€
       await videoStageRef.value.loadVideoSource(data.video_url, {
         startTime: currentTime,
         autoPlay: isPlaying
       })
   
       // æ˜¾ç¤ºæç¤ºï¼ˆå¯é€‰ï¼‰
       showNotification('è§†é¢‘å·²å‡çº§è‡³é«˜æ¸…', 'success')
     })
   })
   ```

2. **VideoStage æ— æ„Ÿåˆ‡æ¢**
   ```javascript
   // VideoStage/index.vue
   
   // æ–°å¢æ–¹æ³•ï¼šåŠ è½½æ–°è§†é¢‘æºï¼ˆä¿æŒæ’­æ”¾çŠ¶æ€ï¼‰
   async function loadVideoSource(newSrc, options = {}) {
     const video = videoRef.value
     if (!video) return
   
     const { startTime = 0, autoPlay = false } = options
   
     // ä¿å­˜å½“å‰çŠ¶æ€
     const savedTime = video.currentTime
     const savedVolume = video.volume
     const savedRate = video.playbackRate
   
     // åˆ‡æ¢è§†é¢‘æº
     video.src = newSrc
   
     // ç­‰å¾…å…ƒæ•°æ®åŠ è½½
     await new Promise((resolve) => {
       video.addEventListener('loadedmetadata', () => {
         // æ¢å¤æ’­æ”¾ä½ç½®
         video.currentTime = startTime || savedTime
         video.volume = savedVolume
         video.playbackRate = savedRate
   
         // æ¢å¤æ’­æ”¾
         if (autoPlay) {
           video.play().catch(err => {
             console.warn('[VideoStage] è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', err)
           })
         }
   
         resolve()
       }, { once: true })
     })
   
     console.log('[VideoStage] è§†é¢‘æºå·²åˆ‡æ¢:', newSrc)
   }
   
   // æš´éœ²ç»™çˆ¶ç»„ä»¶
   defineExpose({
     loadVideoSource,
     getCurrentTime: () => videoRef.value?.currentTime || 0
   })
   ```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- âœ… ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹å­—å¹•ï¼Œçªç„¶è§†é¢‘ç”»é¢å‡ºç°ï¼ˆä¸æ»‘ï¼‰
- âœ… 360p è¶³å¤Ÿé¢„è§ˆä½¿ç”¨ï¼Œæ‹–åŠ¨æµç•…
- âœ… åç»­è‡ªåŠ¨å‡çº§åˆ° 720pï¼ˆç”¨æˆ·å‡ ä¹æ— æ„ŸçŸ¥ï¼‰

---

#### **é˜¶æ®µ 3ï¼šæœ€ç»ˆä¸€è‡´ï¼ˆç©ºé—²æ—¶ï¼‰**

**ç›®æ ‡**ï¼šGPU/CPU ç©ºé—²åï¼Œç”Ÿæˆé«˜è´¨é‡ 720p è§†é¢‘ï¼Œç”¨äºå¯¼å‡ºæˆ–é«˜æ¸…é¢„è§ˆ

**åç«¯ä»»åŠ¡**ï¼š

1. **ç­‰å¾…è½¬å½•å®Œæˆ**
   ```python
   async def wait_for_transcription(job_id: str):
       """
       è½®è¯¢ç­‰å¾…è½¬å½•å®Œæˆ
       """
       while True:
           status = await get_job_status(job_id)
           if status['status'] in ['completed', 'failed', 'cancelled']:
               break
           await asyncio.sleep(2)
   ```

2. **720p é«˜è´¨é‡ç”Ÿæˆ**
   ```python
   async def generate_proxy_720p(job_id: str, video_path: Path, output_path: Path):
       """
       ç”Ÿæˆ 720p é«˜è´¨é‡è§†é¢‘ï¼ˆè½¬å½•å®Œæˆåï¼‰
       """
       # ç­‰å¾…è½¬å½•å®Œæˆ
       await wait_for_transcription(job_id)
   
       # æ£€æŸ¥æ˜¯å¦å·²æœ‰ 720p
       if output_path.exists():
           return
   
       ffmpeg_cmd = config.get_ffmpeg_command()
   
       cmd = [
           ffmpeg_cmd,
           '-i', str(video_path),
           '-vf', 'scale=-2:720',
           '-c:v', 'libx264',
           '-preset', 'fast',              # å¹³è¡¡è´¨é‡å’Œé€Ÿåº¦
           '-crf', '23',                   # é«˜è´¨é‡
           '-g', '30',
           '-c:a', 'aac',
           '-b:a', '128k',
           '-movflags', '+faststart',
           '-progress', 'pipe:1',
           '-y',
           str(output_path)
       ]
   
       await run_with_progress(cmd, job_id, 'proxy_720p')
   ```

3. **æ¸…ç†ç­–ç•¥**ï¼ˆå¯é€‰ï¼‰
   ```python
   async def cleanup_preview_360p(job_id: str):
       """
       720p ç”Ÿæˆå®Œæˆåï¼Œåˆ é™¤ 360pï¼ˆèŠ‚çœç©ºé—´ï¼‰
       """
       job_dir = config.JOBS_DIR / job_id
       preview_360p = job_dir / 'preview_360p.mp4'
   
       if preview_360p.exists():
           preview_360p.unlink()
           print(f"[Cleanup] å·²åˆ é™¤ 360p é¢„è§ˆ: {job_id}")
   ```

**å‰ç«¯åŠ¨ä½œ**ï¼š
- ç›‘å¬ `proxy_720p_complete` äº‹ä»¶ï¼ˆå·²åœ¨é˜¶æ®µ 2 å®ç°ï¼‰
- æ— æ„Ÿåˆ‡æ¢è§†é¢‘æº
- å¯é€‰ï¼šæ˜¾ç¤º Toast æç¤º"è§†é¢‘å·²å‡çº§è‡³é«˜æ¸…"

---

### 2.3 çŠ¶æ€æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ä¸Šä¼ è§†é¢‘  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€: uploading              â”‚
â”‚ å‰ç«¯: ä¸Šä¼ è¿›åº¦æ¡              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€: analyzing              â”‚  â† åª’ä½“åˆ†æ + éŸ³é¢‘æå–
â”‚ å‰ç«¯: "åˆ†æä¸­..."            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€: transcribing           â”‚  â† Whisper è½¬å½•å¯åŠ¨
â”‚ å‰ç«¯: è¿›å…¥ç¼–è¾‘å™¨ï¼Œå­—å¹•æµå¼è¾“å‡º â”‚
â”‚ è§†é¢‘çŠ¶æ€: preparing           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                  â”‚
       â–¼ (ä¸éœ€è½¬ç )                        â–¼ (éœ€è¦è½¬ç )
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§†é¢‘çŠ¶æ€: ready   â”‚            â”‚ è§†é¢‘çŠ¶æ€: preparing  â”‚
â”‚ ä½¿ç”¨åŸè§†é¢‘        â”‚            â”‚ ç”Ÿæˆ 360p ä¸­...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ 360p å®Œæˆ            â”‚
                              â”‚ è§†é¢‘çŠ¶æ€: ready      â”‚
                              â”‚ åˆ†è¾¨ç‡: 360p         â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ è½¬å½•å®Œæˆ             â”‚
                              â”‚ å¯åŠ¨ 720p ç”Ÿæˆ       â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ 720p å®Œæˆ            â”‚
                              â”‚ è‡ªåŠ¨åˆ‡æ¢ï¼ˆæ— æ„Ÿï¼‰      â”‚
                              â”‚ åˆ†è¾¨ç‡: 720p         â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. è¯¦ç»†æŠ€æœ¯å®ç°

### 3.1 åç«¯æ ¸å¿ƒæ¨¡å—

#### æ¨¡å— 1ï¼šåª’ä½“åˆ†æå™¨ (`media_analyzer.py`)

```python
"""
åª’ä½“åˆ†ææ¨¡å— - å¿«é€Ÿæå–è§†é¢‘å…³é”®ä¿¡æ¯
"""
import subprocess
import json
import os
from pathlib import Path
from typing import Dict, Optional

class MediaAnalyzer:
    def __init__(self, ffprobe_cmd: str):
        self.ffprobe_cmd = ffprobe_cmd

    async def analyze(self, video_path: Path) -> Dict:
        """
        åˆ†æè§†é¢‘æ–‡ä»¶ï¼Œè¿”å›å®Œæ•´ä¿¡æ¯

        è¿”å›ç¤ºä¾‹:
        {
            'video': {
                'codec': 'hevc',
                'width': 1920,
                'height': 1080,
                'duration': 1696.22,
                'bitrate': 2500000,
                'fps': 30.0
            },
            'audio': {
                'codec': 'aac',
                'sample_rate': 48000,
                'channels': 2,
                'bitrate': 128000
            },
            'needs_transcode': True,
            'transcode_reason': 'HEVCç¼–ç ä¸å…¼å®¹'
        }
        """
        cmd = [
            self.ffprobe_cmd,
            '-v', 'error',
            '-show_streams',
            '-show_format',
            '-of', 'json',
            str(video_path)
        ]

        result = subprocess.run(
            cmd, capture_output=True, text=True,
            creationflags=subprocess.CREATE_NO_WINDOW if os.name == 'nt' else 0
        )

        if result.returncode != 0:
            raise Exception(f"FFprobe å¤±è´¥: {result.stderr}")

        data = json.loads(result.stdout)
        return self._parse_probe_data(data, video_path)

    def _parse_probe_data(self, data: dict, video_path: Path) -> Dict:
        """è§£æ FFprobe è¾“å‡º"""
        video_stream = None
        audio_stream = None

        for stream in data.get('streams', []):
            if stream['codec_type'] == 'video' and not video_stream:
                video_stream = stream
            elif stream['codec_type'] == 'audio' and not audio_stream:
                audio_stream = stream

        if not video_stream:
            raise Exception("æœªæ‰¾åˆ°è§†é¢‘æµ")

        # è§£æè§†é¢‘ä¿¡æ¯
        video_info = {
            'codec': video_stream.get('codec_name', '').lower(),
            'width': int(video_stream.get('width', 0)),
            'height': int(video_stream.get('height', 0)),
            'duration': float(data['format'].get('duration', 0)),
            'bitrate': int(data['format'].get('bit_rate', 0)),
            'fps': self._parse_fps(video_stream)
        }

        # è§£æéŸ³é¢‘ä¿¡æ¯
        audio_info = None
        if audio_stream:
            audio_info = {
                'codec': audio_stream.get('codec_name', '').lower(),
                'sample_rate': int(audio_stream.get('sample_rate', 48000)),
                'channels': int(audio_stream.get('channels', 2)),
                'bitrate': int(audio_stream.get('bit_rate', 128000))
            }

        # åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬ç 
        needs_transcode, reason = self._check_transcode_needed(
            video_info['codec'], video_path.suffix.lower()
        )

        return {
            'video': video_info,
            'audio': audio_info,
            'needs_transcode': needs_transcode,
            'transcode_reason': reason
        }

    def _parse_fps(self, stream: dict) -> float:
        """è§£æå¸§ç‡"""
        fps_str = stream.get('r_frame_rate', '30/1')
        try:
            num, den = fps_str.split('/')
            return float(num) / float(den)
        except:
            return 30.0

    def _check_transcode_needed(self, codec: str, ext: str) -> tuple:
        """æ£€æŸ¥æ˜¯å¦éœ€è¦è½¬ç """
        NEED_TRANSCODE_CODECS = {'hevc', 'h265', 'vp9', 'av1', 'mpeg2video'}
        NEED_TRANSCODE_FORMATS = {'.mkv', '.avi', '.mov', '.wmv', '.flv', '.m4v'}

        if codec in NEED_TRANSCODE_CODECS:
            return True, f"{codec.upper()} ç¼–ç ä¸å…¼å®¹"

        if ext in NEED_TRANSCODE_FORMATS:
            return True, f"{ext.upper()} æ ¼å¼ä¸å…¼å®¹"

        return False, ""
```

#### æ¨¡å— 2ï¼šéŸ³é¢‘æå–å™¨ (`audio_extractor.py`)

```python
"""
éŸ³é¢‘æå–æ¨¡å— - æé€Ÿæå–éŸ³é¢‘æµ
"""
import subprocess
import asyncio
import os
from pathlib import Path

class AudioExtractor:
    def __init__(self, ffmpeg_cmd: str):
        self.ffmpeg_cmd = ffmpeg_cmd

    async def extract_fast(self, video_path: Path, output_path: Path,
                           audio_codec: str = 'aac') -> Path:
        """
        æé€Ÿæå–éŸ³é¢‘ï¼ˆä¼˜å…ˆå¤åˆ¶æµï¼Œé¿å…é‡æ–°ç¼–ç ï¼‰

        Args:
            video_path: æºè§†é¢‘è·¯å¾„
            output_path: è¾“å‡ºéŸ³é¢‘è·¯å¾„ï¼ˆå¸¦æ‰©å±•åï¼‰
            audio_codec: æºéŸ³é¢‘ç¼–ç 

        Returns:
            å®é™…è¾“å‡ºçš„éŸ³é¢‘è·¯å¾„
        """
        # å¦‚æœéŸ³é¢‘å·²ç»æ˜¯ AAC/MP3ï¼Œç›´æ¥å¤åˆ¶ï¼ˆ< 1 ç§’ï¼‰
        if audio_codec in ['aac', 'mp3']:
            return await self._copy_audio_stream(video_path, output_path)

        # å…¶ä»–ç¼–ç ï¼Œè½¬ä¸º WAVï¼ˆç”¨äº Whisperï¼‰
        return await self._convert_to_wav(video_path, output_path)

    async def _copy_audio_stream(self, video_path: Path, output_path: Path) -> Path:
        """å¤åˆ¶éŸ³é¢‘æµï¼ˆä¸é‡æ–°ç¼–ç ï¼‰"""
        # ç¡®å®šè¾“å‡ºæ ¼å¼
        if output_path.suffix == '.wav':
            # Whisper éœ€è¦ WAVï¼Œå¿…é¡»è½¬ç 
            return await self._convert_to_wav(video_path, output_path)

        cmd = [
            self.ffmpeg_cmd,
            '-i', str(video_path),
            '-vn',                  # ä¸è¦è§†é¢‘
            '-acodec', 'copy',      # å¤åˆ¶éŸ³é¢‘æµ
            '-y',
            str(output_path)
        ]

        await self._run(cmd)
        return output_path

    async def _convert_to_wav(self, video_path: Path, output_path: Path) -> Path:
        """è½¬æ¢ä¸º WAVï¼ˆç”¨äº Whisperï¼‰"""
        wav_path = output_path.with_suffix('.wav')

        cmd = [
            self.ffmpeg_cmd,
            '-i', str(video_path),
            '-vn',
            '-acodec', 'pcm_s16le',  # 16-bit PCM
            '-ar', '16000',           # Whisper æ¨èé‡‡æ ·ç‡
            '-ac', '1',               # å•å£°é“ï¼ˆWhisper ä¼šè½¬ï¼‰
            '-y',
            str(wav_path)
        ]

        await self._run(cmd)
        return wav_path

    async def _run(self, cmd: list):
        """è¿è¡Œ FFmpeg å‘½ä»¤"""
        process = await asyncio.create_subprocess_exec(
            *cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE,
            creationflags=subprocess.CREATE_NO_WINDOW if os.name == 'nt' else 0
        )

        stdout, stderr = await process.communicate()

        if process.returncode != 0:
            raise Exception(f"FFmpeg å¤±è´¥: {stderr.decode()}")
```

#### æ¨¡å— 3ï¼šæ¸è¿›å¼è§†é¢‘ç”Ÿæˆå™¨ (`progressive_video_generator.py`)

```python
"""
æ¸è¿›å¼è§†é¢‘ç”Ÿæˆå™¨ - 360p â†’ 720p ä¸¤é˜¶æ®µç”Ÿæˆ
"""
import asyncio
import subprocess
import os
from pathlib import Path

class ProgressiveVideoGenerator:
    def __init__(self, ffmpeg_cmd: str, sse_manager):
        self.ffmpeg_cmd = ffmpeg_cmd
        self.sse = sse_manager

    async def generate_360p_preview(self, job_id: str, video_path: Path,
                                    output_path: Path):
        """
        ç”Ÿæˆ 360p é¢„è§ˆè§†é¢‘ï¼ˆä½ä¼˜å…ˆçº§ï¼Œæ— éŸ³é¢‘ï¼‰
        """
        cmd = [
            self.ffmpeg_cmd,
            '-i', str(video_path),
            '-vf', 'scale=-2:360',
            '-c:v', 'libx264',
            '-preset', 'ultrafast',     # æœ€å¿«ç¼–ç 
            '-crf', '28',
            '-g', '30',                 # å…³é”®å¸§é—´éš”
            '-an',                      # æ— éŸ³é¢‘
            '-movflags', '+faststart',
            '-progress', 'pipe:1',
            '-y',
            str(output_path)
        ]

        # Linux/Mac: é™ä½è¿›ç¨‹ä¼˜å…ˆçº§
        if os.name != 'nt':
            cmd = ['nice', '-n', '15'] + cmd

        # å¯åŠ¨è¿›ç¨‹å¹¶ç›‘å¬è¿›åº¦
        await self._run_with_progress(
            cmd, job_id, 'preview_360p', video_path
        )

        # æ¨é€å®Œæˆäº‹ä»¶
        self.sse.broadcast_sync(
            f"job:{job_id}",
            "preview_360p_complete",
            {
                "job_id": job_id,
                "video_url": f"/api/media/{job_id}/video/preview",
                "resolution": "360p"
            }
        )

    async def generate_720p_proxy(self, job_id: str, video_path: Path,
                                  output_path: Path):
        """
        ç”Ÿæˆ 720p é«˜è´¨é‡è§†é¢‘ï¼ˆè½¬å½•å®Œæˆåï¼‰
        """
        cmd = [
            self.ffmpeg_cmd,
            '-i', str(video_path),
            '-vf', 'scale=-2:720',
            '-c:v', 'libx264',
            '-preset', 'fast',          # å¹³è¡¡è´¨é‡å’Œé€Ÿåº¦
            '-crf', '23',               # é«˜è´¨é‡
            '-g', '30',
            '-c:a', 'aac',
            '-b:a', '128k',
            '-movflags', '+faststart',
            '-progress', 'pipe:1',
            '-y',
            str(output_path)
        ]

        await self._run_with_progress(
            cmd, job_id, 'proxy_720p', video_path
        )

        # æ¨é€å®Œæˆäº‹ä»¶
        self.sse.broadcast_sync(
            f"job:{job_id}",
            "proxy_720p_complete",
            {
                "job_id": job_id,
                "video_url": f"/api/media/{job_id}/video",
                "resolution": "720p"
            }
        )

    async def _run_with_progress(self, cmd: list, job_id: str,
                                 stage: str, video_path: Path):
        """è¿è¡Œ FFmpeg å¹¶æ¨é€è¿›åº¦"""
        # è·å–è§†é¢‘æ—¶é•¿
        duration = await self._get_duration(video_path)

        process = await asyncio.create_subprocess_exec(
            *cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE,
            creationflags=subprocess.CREATE_NO_WINDOW if os.name == 'nt' else 0
        )

        # è§£æè¿›åº¦
        while True:
            line = await process.stdout.readline()
            if not line:
                break

            line_str = line.decode().strip()
            if line_str.startswith('out_time_ms='):
                try:
                    out_time_ms = int(line_str.split('=')[1])
                    progress = min(100, (out_time_ms / 1000000) / duration * 100)

                    # æ¨é€è¿›åº¦
                    self.sse.broadcast_sync(
                        f"job:{job_id}",
                        f"{stage}_progress",
                        {
                            "job_id": job_id,
                            "stage": stage,
                            "progress": round(progress, 1)
                        }
                    )
                except:
                    pass

        await process.wait()

        if process.returncode != 0:
            stderr = await process.stderr.read()
            raise Exception(f"FFmpeg å¤±è´¥: {stderr.decode()}")

    async def _get_duration(self, video_path: Path) -> float:
        """è·å–è§†é¢‘æ—¶é•¿"""
        # ä½¿ç”¨ MediaAnalyzer æˆ–ç›´æ¥è°ƒç”¨ FFprobe
        cmd = [
            'ffprobe', '-v', 'error',
            '-show_entries', 'format=duration',
            '-of', 'default=noprint_wrappers=1:nokey=1',
            str(video_path)
        ]

        result = subprocess.run(
            cmd, capture_output=True, text=True,
            creationflags=subprocess.CREATE_NO_WINDOW if os.name == 'nt' else 0
        )

        if result.returncode == 0:
            return float(result.stdout.strip())
        return 0.0
```

#### æ¨¡å— 4ï¼šä»»åŠ¡ç¼–æ’å™¨ (`task_orchestrator.py`)

```python
"""
ä»»åŠ¡ç¼–æ’å™¨ - åè°ƒè½¬å½•ã€è§†é¢‘ç”Ÿæˆç­‰ä»»åŠ¡
"""
import asyncio
from pathlib import Path

class TaskOrchestrator:
    def __init__(self, media_analyzer, audio_extractor,
                 video_generator, transcription_service):
        self.media_analyzer = media_analyzer
        self.audio_extractor = audio_extractor
        self.video_generator = video_generator
        self.transcription = transcription_service

    async def process_upload(self, job_id: str, video_path: Path):
        """
        ä¸Šä¼ åå¤„ç†æ€»æµç¨‹

        æµç¨‹:
        1. åˆ†æåª’ä½“
        2. æå–éŸ³é¢‘
        3. å¯åŠ¨è½¬å½•ï¼ˆGPUï¼‰
        4. å¹¶å‘ï¼šç”Ÿæˆ 360p é¢„è§ˆï¼ˆå¦‚éœ€è¦ï¼‰
        5. è½¬å½•å®Œæˆåï¼šç”Ÿæˆ 720pï¼ˆå¦‚éœ€è¦ï¼‰
        """
        job_dir = video_path.parent

        # ====== é˜¶æ®µ 1ï¼šæé€Ÿå¯åŠ¨ ======
        print(f"[Orchestrator] å¼€å§‹å¤„ç†ä»»åŠ¡: {job_id}")

        # 1. åˆ†æåª’ä½“
        media_info = await self.media_analyzer.analyze(video_path)
        print(f"[Orchestrator] åª’ä½“åˆ†æå®Œæˆ: {media_info}")

        # 2. æå–éŸ³é¢‘
        audio_path = job_dir / 'audio.wav'
        await self.audio_extractor.extract_fast(
            video_path, audio_path,
            media_info['audio']['codec'] if media_info['audio'] else 'aac'
        )
        print(f"[Orchestrator] éŸ³é¢‘æå–å®Œæˆ: {audio_path}")

        # 3. å¯åŠ¨è½¬å½•
        transcription_task = asyncio.create_task(
            self.transcription.start(job_id, audio_path)
        )
        print(f"[Orchestrator] Whisper è½¬å½•å·²å¯åŠ¨")

        # ====== é˜¶æ®µ 2ï¼šåå°è¿½èµ¶ ======
        if media_info['needs_transcode']:
            # 4. å¹¶å‘ç”Ÿæˆ 360p é¢„è§ˆ
            preview_360p = job_dir / 'preview_360p.mp4'
            preview_task = asyncio.create_task(
                self.video_generator.generate_360p_preview(
                    job_id, video_path, preview_360p
                )
            )
            print(f"[Orchestrator] 360p é¢„è§ˆç”Ÿæˆå·²å¯åŠ¨ï¼ˆåå°ï¼‰")

        # 5. ç­‰å¾…è½¬å½•å®Œæˆ
        await transcription_task
        print(f"[Orchestrator] Whisper è½¬å½•å®Œæˆ")

        # ====== é˜¶æ®µ 3ï¼šæœ€ç»ˆä¸€è‡´ ======
        if media_info['needs_transcode']:
            # 6. ç”Ÿæˆ 720p é«˜è´¨é‡
            proxy_720p = job_dir / 'proxy.mp4'
            await self.video_generator.generate_720p_proxy(
                job_id, video_path, proxy_720p
            )
            print(f"[Orchestrator] 720p é«˜è´¨é‡è§†é¢‘ç”Ÿæˆå®Œæˆ")

            # 7. æ¸…ç† 360pï¼ˆå¯é€‰ï¼‰
            if preview_360p.exists():
                preview_360p.unlink()
                print(f"[Orchestrator] å·²åˆ é™¤ 360p é¢„è§ˆ")

        print(f"[Orchestrator] ä»»åŠ¡å¤„ç†å®Œæˆ: {job_id}")
```

---

### 3.2 å‰ç«¯æ ¸å¿ƒæ¨¡å—

#### æ¨¡å— 1ï¼šSSE ç®¡ç†å™¨å¢å¼º (`useSseManager.js`)

```javascript
// composables/useSseManager.js
import { ref, onUnmounted } from 'vue'

export function useSseManager() {
  const eventSource = ref(null)
  const listeners = new Map()  // event_type -> [callbacks]

  /**
   * è®¢é˜… SSE äº‹ä»¶
   * @param {string} channel - é¢‘é“ IDï¼ˆå¦‚ 'job:xxx'ï¼‰
   * @param {string} eventType - äº‹ä»¶ç±»å‹
   * @param {function} callback - å›è°ƒå‡½æ•°
   */
  function subscribe(channel, eventType, callback) {
    const key = `${channel}:${eventType}`

    if (!listeners.has(key)) {
      listeners.set(key, [])
    }

    listeners.get(key).push(callback)

    // ç¡®ä¿ EventSource å·²è¿æ¥
    ensureConnection(channel)

    console.log(`[SSE] è®¢é˜…äº‹ä»¶: ${key}`)
  }

  /**
   * å–æ¶ˆè®¢é˜…
   */
  function unsubscribe(channel, eventType, callback) {
    const key = `${channel}:${eventType}`

    if (listeners.has(key)) {
      const callbacks = listeners.get(key)
      const index = callbacks.indexOf(callback)
      if (index > -1) {
        callbacks.splice(index, 1)
      }

      if (callbacks.length === 0) {
        listeners.delete(key)
      }
    }
  }

  /**
   * ç¡®ä¿ SSE è¿æ¥å·²å»ºç«‹
   */
  function ensureConnection(channel) {
    if (eventSource.value) return

    const url = `/api/sse/subscribe?channel=${channel}`
    eventSource.value = new EventSource(url)

    eventSource.value.onopen = () => {
      console.log('[SSE] è¿æ¥å·²å»ºç«‹')
    }

    eventSource.value.onerror = (error) => {
      console.error('[SSE] è¿æ¥é”™è¯¯:', error)
      // é‡è¿é€»è¾‘
      setTimeout(() => {
        if (eventSource.value) {
          eventSource.value.close()
          eventSource.value = null
          ensureConnection(channel)
        }
      }, 5000)
    }

    // ç›‘å¬æ‰€æœ‰æ¶ˆæ¯
    eventSource.value.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data)
        const eventType = data.type || 'message'
        const key = `${channel}:${eventType}`

        // è§¦å‘å›è°ƒ
        if (listeners.has(key)) {
          listeners.get(key).forEach(callback => {
            callback(data.data || data)
          })
        }
      } catch (error) {
        console.error('[SSE] æ¶ˆæ¯è§£æå¤±è´¥:', error)
      }
    }
  }

  /**
   * å…³é—­è¿æ¥
   */
  function close() {
    if (eventSource.value) {
      eventSource.value.close()
      eventSource.value = null
      listeners.clear()
      console.log('[SSE] è¿æ¥å·²å…³é—­')
    }
  }

  // ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨å…³é—­
  onUnmounted(() => {
    close()
  })

  return {
    subscribe,
    unsubscribe,
    close
  }
}
```

#### æ¨¡å— 2ï¼šè§†é¢‘çŠ¶æ€ç®¡ç† (`useVideoStatus.js`)

```javascript
// composables/useVideoStatus.js
import { ref, computed } from 'vue'

export function useVideoStatus(jobId) {
  const status = ref({
    type: 'loading',      // loading | preparing | ready | error
    stage: null,          // null | 'preview_360p' | 'proxy_720p'
    progress: 0,          // 0-100
    resolution: null,     // null | '360p' | '720p'
    message: 'åŠ è½½ä¸­...',
    videoUrl: null
  })

  /**
   * æ›´æ–°ä¸ºå‡†å¤‡ä¸­çŠ¶æ€ï¼ˆç”Ÿæˆè§†é¢‘ä¸­ï¼‰
   */
  function setPreparing(stage, progress = 0) {
    status.value = {
      type: 'preparing',
      stage,
      progress,
      resolution: null,
      message: stage === 'preview_360p'
        ? `æ­£åœ¨ç”Ÿæˆé¢„è§ˆè§†é¢‘ (${progress}%)`
        : `æ­£åœ¨ç”Ÿæˆé«˜æ¸…è§†é¢‘ (${progress}%)`,
      videoUrl: null
    }
  }

  /**
   * æ›´æ–°ä¸ºå°±ç»ªçŠ¶æ€
   */
  function setReady(resolution, videoUrl) {
    status.value = {
      type: 'ready',
      stage: resolution === '360p' ? 'preview_360p' : 'proxy_720p',
      progress: 100,
      resolution,
      message: resolution === '360p' ? 'é¢„è§ˆè§†é¢‘ (360p)' : 'é«˜æ¸…è§†é¢‘ (720p)',
      videoUrl
    }
  }

  /**
   * æ›´æ–°ä¸ºé”™è¯¯çŠ¶æ€
   */
  function setError(message) {
    status.value = {
      type: 'error',
      stage: null,
      progress: 0,
      resolution: null,
      message,
      videoUrl: null
    }
  }

  /**
   * æ›´æ–°è¿›åº¦
   */
  function updateProgress(progress) {
    if (status.value.type === 'preparing') {
      status.value.progress = progress
      status.value.message = status.value.stage === 'preview_360p'
        ? `æ­£åœ¨ç”Ÿæˆé¢„è§ˆè§†é¢‘ (${progress}%)`
        : `æ­£åœ¨ç”Ÿæˆé«˜æ¸…è§†é¢‘ (${progress}%)`
    }
  }

  // è®¡ç®—å±æ€§ï¼šæ˜¯å¦æ˜¾ç¤ºå ä½ç¬¦
  const showPlaceholder = computed(() => {
    return status.value.type === 'loading' || status.value.type === 'preparing'
  })

  // è®¡ç®—å±æ€§ï¼šæ˜¯å¦æ˜¾ç¤ºè¿›åº¦æ¡
  const showProgress = computed(() => {
    return status.value.type === 'preparing' && status.value.progress > 0
  })

  return {
    status,
    setPreparing,
    setReady,
    setError,
    updateProgress,
    showPlaceholder,
    showProgress
  }
}
```

#### æ¨¡å— 3ï¼šVideoStage ç»„ä»¶å¢å¼º

å®Œæ•´çš„ VideoStage ç»„ä»¶ä»£ç è§ç¬¬ 2.2 èŠ‚çš„"é˜¶æ®µ 2ï¼šåå°è¿½èµ¶"éƒ¨åˆ†ä¸­çš„"2. **VideoStage æ— æ„Ÿåˆ‡æ¢**"

---

## 4. å‰åç«¯æ”¹åŠ¨æ¸…å•

### 4.1 åç«¯æ–‡ä»¶æ”¹åŠ¨

#### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `backend/app/utils/media_analyzer.py` | åª’ä½“åˆ†ææ¨¡å— |
| `backend/app/utils/audio_extractor.py` | éŸ³é¢‘æå–æ¨¡å— |
| `backend/app/utils/progressive_video_generator.py` | æ¸è¿›å¼è§†é¢‘ç”Ÿæˆå™¨ |
| `backend/app/services/task_orchestrator.py` | ä»»åŠ¡ç¼–æ’å™¨ |

#### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | æ”¹åŠ¨ç‚¹ | è¯¦ç»†è¯´æ˜ |
|---------|-------|---------|
| `backend/app/api/routes/media_routes.py` | 1. æ–°å¢ `-g 30 -movflags +faststart` | ä¼˜åŒ–æ‹–åŠ¨æ€§èƒ½ |
| | 2. ä¿®æ”¹ `_serve_file_with_range` | åŠ¨æ€è°ƒæ•´ chunk_size |
| | 3. æ–°å¢ `/api/media/{job_id}/video/preview` | è¿”å› 360p é¢„è§ˆè§†é¢‘ |
| | 4. æ–°å¢ `/api/media/{job_id}/status/progressive` | è¿”å›æ¸è¿›å¼åŠ è½½çŠ¶æ€ |
| `backend/app/api/routes/transcription_routes.py` | 1. ä¿®æ”¹ä¸Šä¼ å¤„ç† | é›†æˆ TaskOrchestrator |
| | 2. è°ƒç”¨ `orchestrator.process_upload()` | å¯åŠ¨æ¸è¿›å¼å¤„ç†æµç¨‹ |
| `backend/app/core/config.py` | æ–°å¢é…ç½®é¡¹ | å¦‚ä¸‹ |

**æ–°å¢é…ç½®**ï¼ˆ`backend/app/core/config.py`ï¼‰ï¼š
```python
# æ¸è¿›å¼åŠ è½½é…ç½®
ENABLE_PROGRESSIVE_LOADING = True
PREVIEW_RESOLUTION = 360
PROXY_RESOLUTION = 720
PREVIEW_QUALITY = 28      # CRF è´¨é‡ï¼ˆ1-51ï¼Œè¶Šä½è¶Šå¥½ï¼‰
PROXY_QUALITY = 23
```

---

### 4.2 å‰ç«¯æ–‡ä»¶æ”¹åŠ¨

#### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `frontend/src/composables/useSseManager.js` | SSE ç®¡ç†å™¨ |
| `frontend/src/composables/useVideoStatus.js` | è§†é¢‘çŠ¶æ€ç®¡ç† |

#### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | æ”¹åŠ¨ç‚¹ | è¯¦ç»†è¯´æ˜ |
|---------|-------|---------|
| `frontend/src/components/editor/VideoStage/index.vue` | 1. æ–°å¢å ä½ç¬¦ UI | "è§†é¢‘ç”»é¢æ­£åœ¨è§£ç " + è¿›åº¦æ¡ |
| | 2. ç›‘å¬ SSE äº‹ä»¶ | 360p/720p å®Œæˆäº‹ä»¶ |
| | 3. æ–°å¢ `loadVideoSource()` æ–¹æ³• | æ— æ„Ÿåˆ‡æ¢è§†é¢‘æº |
| | 4. æ–°å¢åˆ†è¾¨ç‡æ ‡è¯† | å³ä¸Šè§’æ˜¾ç¤º "360p" / "720p" |
| | 5. ä¼˜åŒ– preload ç­–ç•¥ | æ ¹æ®è§†é¢‘æ—¶é•¿åŠ¨æ€è°ƒæ•´ |
| `frontend/src/views/EditorView.vue` | 1. é›†æˆ SSE ç®¡ç†å™¨ | è®¢é˜…ä»»åŠ¡äº‹ä»¶ |
| | 2. åˆå§‹åŒ–æ—¶è°ƒç”¨çŠ¶æ€ API | è·å–å½“å‰è¿›åº¦ |
| | 3. ä¼ é€’ `extractedAudioUrl` | ä½¿ç”¨æå–çš„éŸ³é¢‘ |
| `frontend/src/components/editor/WaveformTimeline/index.vue` | 1. æ–°å¢ props: `extractedAudioUrl` | ä¼˜å…ˆä½¿ç”¨æå–çš„éŸ³é¢‘ |
| | 2. ä¿®æ”¹ `audioSource` | ä¼˜å…ˆçº§: extracted > wav |
| `frontend/src/views/TaskMonitorView.vue` | ä¿®æ”¹"ç¼–è¾‘"æŒ‰é’® | ä¸ç­‰å¾…èµ„æºï¼Œç›´æ¥è·³è½¬ |
| `frontend/src/stores/projectStore.js` | 1. æ–°å¢ `meta.extractedAudioPath` | å­˜å‚¨æå–çš„éŸ³é¢‘ |
| | 2. æ–°å¢ `video.resolution` | å­˜å‚¨å½“å‰è§†é¢‘åˆ†è¾¨ç‡ |

---

## 5. SSE é€šä¿¡åè®®

### 5.1 äº‹ä»¶ç±»å‹å®šä¹‰

| äº‹ä»¶ç±»å‹ | è§¦å‘æ—¶æœº | æ•°æ®æ ¼å¼ |
|---------|---------|---------|
| `preview_360p_progress` | 360p ç”Ÿæˆè¿›åº¦æ›´æ–°ï¼ˆæ¯ç§’ï¼‰ | `{ job_id, stage, progress }` |
| `preview_360p_complete` | 360p ç”Ÿæˆå®Œæˆ | `{ job_id, video_url, resolution }` |
| `proxy_720p_progress` | 720p ç”Ÿæˆè¿›åº¦æ›´æ–°ï¼ˆæ¯ç§’ï¼‰ | `{ job_id, stage, progress }` |
| `proxy_720p_complete` | 720p ç”Ÿæˆå®Œæˆ | `{ job_id, video_url, resolution }` |

### 5.2 æ•°æ®æ ¼å¼ç¤ºä¾‹

#### preview_360p_progress
```json
{
  "type": "preview_360p_progress",
  "data": {
    "job_id": "abc123",
    "stage": "preview_360p",
    "progress": 45.2
  }
}
```

#### preview_360p_complete
```json
{
  "type": "preview_360p_complete",
  "data": {
    "job_id": "abc123",
    "video_url": "/api/media/abc123/video/preview",
    "resolution": "360p"
  }
}
```

#### proxy_720p_complete
```json
{
  "type": "proxy_720p_complete",
  "data": {
    "job_id": "abc123",
    "video_url": "/api/media/abc123/video",
    "resolution": "720p"
  }
}
```

---

## 6. æ€§èƒ½ä¼˜åŒ–æ¸…å•

### 6.1 åç«¯ä¼˜åŒ–

#### ä¼˜åŒ– 1ï¼šFFmpeg å‚æ•°è°ƒä¼˜

| å‚æ•° | ç”¨é€” | 360p é¢„è§ˆ | 720p é«˜è´¨é‡ |
|------|------|-----------|-----------|
| `-preset` | ç¼–ç é€Ÿåº¦ | `ultrafast` | `fast` |
| `-crf` | è´¨é‡ | 28ï¼ˆä¸­ç­‰ï¼‰ | 23ï¼ˆé«˜ï¼‰ |
| `-g` | å…³é”®å¸§é—´éš” | 30 | 30 |
| `-movflags` | FastStart | `+faststart` | `+faststart` |
| `-an` | éŸ³é¢‘å¤„ç† | å»æ‰éŸ³é¢‘ | ä¿ç•™éŸ³é¢‘ |

#### ä¼˜åŒ– 2ï¼šå¹¶å‘ç­–ç•¥

```python
# CPU é™åˆ¶ï¼šæœ€å¤š 1 ä¸ª Proxy ç”Ÿæˆä»»åŠ¡åŒæ—¶è¿è¡Œ
MAX_CONCURRENT_TRANSCODES = 1

# GPU ä¸é™åˆ¶ï¼ˆWhisper å¯ä»¥å•ç‹¬ç”¨ GPUï¼‰
# CPU ç¼–ç ä¸ GPU è½¬å½•äº’ä¸å¹²æ‰°
```

#### ä¼˜åŒ– 3ï¼šè¿›ç¨‹ä¼˜å…ˆçº§

```bash
# Linux/Macï¼š360p ä½¿ç”¨ nice é™ä½ä¼˜å…ˆçº§
nice -n 15 ffmpeg ...

# Windowsï¼šPowerShell ä¸­è®¾ç½®ä¼˜å…ˆçº§
# Start-Process -FilePath ffmpeg.exe -ArgumentList ... -WindowStyle Minimized
```

### 6.2 å‰ç«¯ä¼˜åŒ–

#### ä¼˜åŒ– 1ï¼šPreload ç­–ç•¥

| è§†é¢‘æ—¶é•¿ | preload ç­–ç•¥ | åŸå›  |
|---------|-----------|------|
| < 5 åˆ†é’Ÿ | `auto` | è‡ªåŠ¨é¢„åŠ è½½æ•´ä¸ªè§†é¢‘ |
| 5-30 åˆ†é’Ÿ | `metadata` | ä»…åŠ è½½å…ƒæ•°æ®ï¼ŒèŠ‚çœå¸¦å®½ |
| > 30 åˆ†é’Ÿ | `none` | æŒ‰éœ€åŠ è½½ï¼Œä¸é¢„åŠ è½½ |

#### ä¼˜åŒ– 2ï¼šRange è¯·æ±‚ä¼˜åŒ–

```javascript
// å‰ç«¯è‡ªåŠ¨å¤„ç† Range è¯·æ±‚
// HTML5 Video å…ƒç´ åŸç”Ÿæ”¯æŒ Range è¯·æ±‚
// åç«¯è¿”å› 206 Partial Content å“åº”
```

#### ä¼˜åŒ– 3ï¼šé˜²æŠ–å’ŒèŠ‚æµ

```javascript
// æ—¶é—´æ›´æ–°é˜²æŠ–ï¼ˆ100msï¼‰
const debouncedTimeUpdate = debounce((time) => {
  projectStore.player.currentTime = time
}, 100)
```

### 6.3 ç½‘ç»œä¼˜åŒ–

#### ä¼˜åŒ– 1ï¼šè§†é¢‘æ–‡ä»¶å¤§å°

| åˆ†è¾¨ç‡ | é¢„è®¾ | æ¯”ç‰¹ç‡ | æ–‡ä»¶å¤§å° | ç”Ÿæˆæ—¶é—´ |
|--------|------|--------|---------|---------|
| 360p | ultrafast | ~800kbps | 28åˆ†é’Ÿ â‰ˆ 210MB | ~3-5åˆ†é’Ÿ |
| 720p | fast | ~2500kbps | 28åˆ†é’Ÿ â‰ˆ 660MB | ~15-20åˆ†é’Ÿ |

#### ä¼˜åŒ– 2ï¼šCDN ç¼“å­˜ç­–ç•¥

```python
# å“åº”å¤´
Cache-Control: public, max-age=86400  # 1 å¤©ç¼“å­˜
ETag: "video-hash"
Last-Modified: <file-mtime>
```

---

## 7. æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

### 7.1 åç«¯æµ‹è¯•

#### æµ‹è¯• 1ï¼šåª’ä½“åˆ†æ

```python
def test_media_analyzer():
    analyzer = MediaAnalyzer(ffprobe_cmd)

    # æµ‹è¯• H.264 MP4ï¼ˆå…¼å®¹ï¼‰
    info = await analyzer.analyze(Path('test_h264.mp4'))
    assert info['video']['codec'] == 'h264'
    assert info['needs_transcode'] == False

    # æµ‹è¯• HEVC MP4ï¼ˆä¸å…¼å®¹ï¼‰
    info = await analyzer.analyze(Path('test_hevc.mp4'))
    assert info['video']['codec'] == 'hevc'
    assert info['needs_transcode'] == True
```

#### æµ‹è¯• 2ï¼šéŸ³é¢‘æå–

```python
def test_audio_extractor():
    extractor = AudioExtractor(ffmpeg_cmd)

    # æµ‹è¯• AAC éŸ³é¢‘æå–
    audio_path = await extractor.extract_fast(
        Path('test_aac.mp4'),
        Path('test_audio.m4a'),
        'aac'
    )
    assert audio_path.exists()
    assert audio_path.stat().st_size < 50 * 1024 * 1024  # < 50MB
```

#### æµ‹è¯• 3ï¼š360p ç”Ÿæˆ

```python
def test_preview_generation():
    generator = ProgressiveVideoGenerator(ffmpeg_cmd, sse_mock)

    await generator.generate_360p_preview(
        'test_job',
        Path('test_hevc.mp4'),
        Path('preview_360p.mp4')
    )

    # éªŒè¯æ–‡ä»¶å­˜åœ¨
    assert Path('preview_360p.mp4').exists()

    # éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ360p åº”è¯¥ < 200MBï¼‰
    file_size = Path('preview_360p.mp4').stat().st_size
    assert file_size < 200 * 1024 * 1024

    # éªŒè¯ SSE äº‹ä»¶
    sse_mock.broadcast_sync.assert_called_once()
```

### 7.2 å‰ç«¯æµ‹è¯•

#### æµ‹è¯• 1ï¼šSSE ç®¡ç†å™¨

```javascript
describe('useSseManager', () => {
  it('should subscribe to events', () => {
    const { subscribe } = useSseManager()
    const callback = jest.fn()

    subscribe('job:abc', 'test_event', callback)

    // æ¨¡æ‹Ÿ SSE æ¶ˆæ¯
    // ...

    expect(callback).toHaveBeenCalled()
  })
})
```

#### æµ‹è¯• 2ï¼šVideoStage æ— æ„Ÿåˆ‡æ¢

```javascript
describe('VideoStage', () => {
  it('should switch video source without interruption', async () => {
    const wrapper = mount(VideoStage)

    // åˆå§‹åŠ è½½è§†é¢‘
    await wrapper.vm.loadVideoSource('/api/media/job1/video/preview')
    expect(wrapper.vm.$refs.videoRef.src).toContain('preview')

    // åˆ‡æ¢åˆ° 720p
    const currentTime = 30
    await wrapper.vm.loadVideoSource(
      '/api/media/job1/video',
      { startTime: currentTime, autoPlay: true }
    )

    // éªŒè¯åˆ‡æ¢æˆåŠŸ
    expect(wrapper.vm.$refs.videoRef.src).toContain('video')
    expect(wrapper.vm.$refs.videoRef.currentTime).toBe(currentTime)
  })
})
```

### 7.3 é›†æˆæµ‹è¯•

#### åœºæ™¯ 1ï¼šä¸Šä¼  HEVC è§†é¢‘å…¨æµç¨‹

```
1. ç”¨æˆ·ä¸Šä¼  HEVC.mp4 (1GB)
2. åç«¯åˆ†æ â†’ æ£€æµ‹åˆ° HEVC ç¼–ç 
3. æå–éŸ³é¢‘ (< 1ç§’)
4. å¯åŠ¨ Whisper è½¬å½• (GPU)
5. åå°å¯åŠ¨ 360p ç”Ÿæˆ (CPUï¼Œä½ä¼˜å…ˆçº§)
6. å‰ç«¯ï¼š
   - ç«‹å³è¿›å…¥ç¼–è¾‘å™¨ (5ç§’å†…)
   - æ˜¾ç¤º"è§†é¢‘ç”»é¢æ­£åœ¨è§£ç ..."
   - æ³¢å½¢æ˜¾ç¤ºå®Œæ•´éŸ³é¢‘
   - å­—å¹•æµå¼è¾“å‡º
7. 30-60 ç§’åï¼Œ360p å®Œæˆ â†’ è§†é¢‘ç”»é¢å‡ºç°
8. è½¬å½•å®Œæˆåï¼Œå¯åŠ¨ 720p ç”Ÿæˆ
9. 720p å®Œæˆåï¼Œè‡ªåŠ¨å‡çº§ï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰
```

#### åœºæ™¯ 2ï¼šä¸Šä¼  H.264 è§†é¢‘å…¨æµç¨‹

```
1. ç”¨æˆ·ä¸Šä¼  H264.mp4
2. åç«¯åˆ†æ â†’ æ£€æµ‹åˆ° H.264 ç¼–ç ï¼ˆå…¼å®¹ï¼‰
3. æå–éŸ³é¢‘
4. å¯åŠ¨ Whisper è½¬å½•
5. å‰ç«¯ï¼š
   - ç«‹å³è¿›å…¥ç¼–è¾‘å™¨
   - ç›´æ¥ä½¿ç”¨åŸè§†é¢‘ï¼ˆæ— éœ€è½¬ç ï¼‰
   - æ³¢å½¢å’Œå­—å¹•æ­£å¸¸
```

### 7.4 æ€§èƒ½æµ‹è¯•

#### æµ‹è¯•æ–¹æ¡ˆ

```bash
# æµ‹è¯• 1ï¼šæ‹–åŠ¨æ€§èƒ½
ä½¿ç”¨ DevTools æµ‹é‡ï¼š
- ç‚¹å‡»è¿›åº¦æ¡ä¸åŒä½ç½®
- è®°å½•åŠ è½½æ—¶é—´
- ç›®æ ‡ï¼š< 1 ç§’

# æµ‹è¯• 2ï¼šå†…å­˜å ç”¨
ä½¿ç”¨ Performance ç›‘è§†å™¨ï¼š
- åŠ è½½è§†é¢‘æ—¶çš„å†…å­˜å³°å€¼
- ç›®æ ‡ï¼š< 500MB

# æµ‹è¯• 3ï¼šCPU å ç”¨
- 360p ç”Ÿæˆæ—¶ï¼šCPU å ç”¨ 20-30%
- ä¸ Whisper å¹¶å‘æ—¶ï¼šGPU 90%+, CPU 5%
```



