新前端分阶段开发说明

总体架构概览

┌─────────────────────────────────────────────────────────────┐
│                      阶段5: EditorView                        │
│                      (主视图整合)                             │
├─────────────────────────────────────────────────────────────┤
│  阶段4: 辅助组件层                                           │
│  ValidationPanel | AIAssistant | TaskMonitor                │
├─────────────────────────────────────────────────────────────┤
│  阶段3: 核心编辑组件层                                       │
│  VideoStage | WaveformTimeline | SubtitleList | Playback    │
├─────────────────────────────────────────────────────────────┤
│  阶段2: 状态管理层                                           │
│  ProjectStore | UnifiedTaskStore                            │
├─────────────────────────────────────────────────────────────┤
│  阶段1: 服务层 + 项目基础                                    │
│  CacheService | SSEService | 路由/主题/全局配置              │
├─────────────────────────────────────────────────────────────┤
│  阶段0: 旧前端归档与环境准备                                 │
│  前端归档 | 新项目初始化 | 后端接入验证                       │
└─────────────────────────────────────────────────────────────┘

---
阶段 0: 旧前端归档与环境准备

目标

将旧前端代码归档保存，初始化全新的前端项目环境，确保新前端完全替代旧前端并正确接入现有后端。

实现内容

0.1 归档旧前端

```bash
# 在项目根目录执行
# 创建归档目录
mkdir -p archive

# 将旧前端移入归档 (保留完整历史记录以备参考)
mv frontend archive/frontend_legacy

# 如果有 node_modules，先删除再归档
rm -rf archive/frontend_legacy/node_modules
```

0.2 创建新前端项目

```bash
# 在项目根目录创建新的 Vue 项目
npm create vite@latest frontend -- --template vue

# 进入新前端目录
cd frontend

# 安装基础依赖
npm install
```

0.3 配置 Vite 代理接入后端

在 `frontend/vite.config.js` 中配置后端 API 代理:

```javascript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import path from 'path'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src')
    }
  },
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://127.0.0.1:5000',
        changeOrigin: true
      },
      '/media': {
        target: 'http://127.0.0.1:5000',
        changeOrigin: true
      }
    }
  }
})
```

0.4 验证后端连接

创建简单测试页面验证后端通信:

```vue
<!-- src/App.vue -->
<template>
  <div>
    <h1>新前端环境测试</h1>
    <p>后端状态: {{ backendStatus }}</p>
    <button @click="checkBackend">检测后端连接</button>
  </div>
</template>

<script setup>
import { ref } from 'vue'

const backendStatus = ref('未检测')

async function checkBackend() {
  try {
    const res = await fetch('/api/health')
    if (res.ok) {
      backendStatus.value = '连接成功'
    } else {
      backendStatus.value = '连接失败: ' + res.status
    }
  } catch (e) {
    backendStatus.value = '连接错误: ' + e.message
  }
}
</script>
```

0.5 目录结构变化

```
project_root/
├── archive/
│   └── frontend_legacy/    # 旧前端归档
├── frontend/               # 新前端项目 (全新)
│   ├── src/
│   ├── package.json
│   └── vite.config.js
├── app.py                  # 后端入口 (保持不变)
└── ...
```

验收标准

- 旧前端代码已移入 `archive/frontend_legacy/` 目录
- 新前端项目可独立启动 (`npm run dev`)
- 访问 http://localhost:5173 可看到测试页面
- 点击"检测后端连接"按钮显示"连接成功"
- 后端 API 代理正常工作 (`/api/*` 转发到 5000 端口)

注意事项

1. **不要删除旧前端**: 将其归档而非删除，便于参考和回滚
2. **干净的 node_modules**: 归档前删除 node_modules 减少体积
3. **Git 处理**: 使用 `git mv` 保留文件历史，在提交信息中说明迁移
4. **后端兼容**: 确保后端 `/api/health` 端点可用，如无则先跳过验证
5. **端口冲突**: 如 5173 端口被占用，Vite 会自动选择其他端口

---
阶段 1: 项目初始化与服务层

目标

在阶段0创建的新前端项目基础上，实现底层服务，为上层功能提供基础支撑。

实现内容

1.1 项目初始化

src/
├── main.js
├── App.vue
├── router/
│   └── index.js
├── stores/           (空目录)
├── services/
│   ├── cacheService.js
│   └── sseService.js
├── components/       (空目录)
├── views/
│   └── TestView.vue  (测试页面)
└── styles/
    └── variables.scss

1.2 依赖安装

npm install pinia vue-router element-plus @vueuse/core
npm install localforage lru-cache eventemitter3
npm install splitpanes vue-virtual-scroller wavesurfer.js@7 markdown-it

1.3 CacheService 实现要点

- L1 内存 LRU 缓存 (lru-cache)
- L2 IndexedDB 持久化 (localforage)
- get/set/delete/clear 核心方法
- 自动过期清理机制

1.4 SSEService 实现要点

- EventSource 封装
- 自动重连 (指数退避)
- 事件类型分发 (task_progress, task_complete, task_failed)
- 心跳检测与降级轮询

验收标准

- 独立 Vue 项目可启动 (npm run dev)
- CacheService 单元测试通过 (存取、过期、LRU淘汰)
- SSEService 可连接后端 /api/tasks/stream 并接收事件
- 测试页面展示 SSE 连接状态和缓存统计

注意事项

1. 完全独立: 不要复用旧前端任何代码，从零开始
2. 路径配置: 使用 Vite 的 @ 别名，避免相对路径混乱
3. API代理: vite.config.js 配置后端代理
4. 禁用Emoji: Element Plus 主题和所有文本中禁用表情符号

---
阶段 2: 状态管理层

目标

实现核心 Store，建立数据流基础，与后端 API 对接。

实现内容

2.1 ProjectStore

- 字幕数据结构 (id, start, end, text, isDirty)
- 播放器状态 (currentTime, isPlaying, playbackRate, volume)
- 撤销/重做 (useRefHistory, 50步历史)
- 验证系统 (时间重叠、字数检测)
- 多级缓存集成 (CacheService)
- SRT 导入/导出

2.2 UnifiedTaskStore

- 任务状态管理 (Map 结构)
- 任务生命周期 (uploading -> transcribing -> editing -> completed)
- SSE 事件订阅
- localStorage 持久化

验收标准

- 测试页面可手动添加字幕、修改、删除
- 撤销/重做功能正常工作
- 刷新页面后字幕数据可从缓存恢复
- 任务列表从后端 /api/tasks/status 同步
- SSE 进度更新实时反映到 Store

测试页面设计

<!-- views/StoreTestView.vue -->
<template>
  <div>
    <h3>ProjectStore 测试</h3>
    <button @click="addSubtitle">添加字幕</button>
    <button @click="undo">撤销</button>
    <button @click="redo">重做</button>
    <div v-for="sub in subtitles">{{ sub.text }}</div>

    <h3>TaskStore 测试</h3>
    <div v-for="task in tasks">{{ task.filename }} - {{ task.progress }}%</div>
  </div>
</template>

注意事项

1. Store 解耦: ProjectStore 不应依赖 UnifiedTaskStore，只通过 EditorView 协调
2. 防抖保存: 缓存写入使用 3 秒节流
3. 响应式陷阱: Map 结构需要使用 ref() 包装才能响应式

---
阶段 3: 核心编辑组件层

目标

实现编辑器的四大核心组件，可独立运行和测试。

实现内容

3.1 PlaybackControls

- 播放/暂停按钮
- 进度条拖拽
- 时间显示 (当前/总时长)
- 倍速选择 (0.5x - 4x)
- 音量控制
- 键盘快捷键 (Space, 方向键)

3.2 VideoStage

- HTML5 video 元素封装
- 字幕覆盖层显示
- 与 ProjectStore 双向绑定
- Proxy 视频自动切换
- 加载/错误状态处理

3.3 SubtitleList

- RecycleScroller 虚拟滚动 (始终启用)
- TimeInput 时间编辑组件
- 文本 textarea 编辑
- 自动滚动跟随当前播放
- 批量选择操作

3.4 WaveformTimeline

- wavesurfer.js v7 初始化
- 后端峰值数据加载 (/api/media/:jobId/peaks)
- RegionsPlugin 字幕区域显示
- 拖拽调整时间
- 视频缩略图轨道 (可选)

验收标准

- 播放控制按钮可控制视频播放/暂停
- 拖动进度条可跳转，时间显示正确
- 字幕覆盖在视频上，跟随播放时间切换
- 字幕列表滚动流畅 (1000+ 条测试)
- 编辑字幕文本后，视频字幕实时更新
- 波形显示正常，可拖拽调整字幕区域
- 调整区域后 SubtitleList 同步更新

测试页面设计

<!-- views/EditorTestView.vue -->
<template>
  <div class="editor-test">
    <div class="left-panel">
      <VideoStage :job-id="testJobId" />
      <WaveformTimeline :job-id="testJobId" />
    </div>
    <div class="right-panel">
      <PlaybackControls />
      <SubtitleList />
    </div>
  </div>
</template>

注意事项

1. 循环更新: VideoStage 和 WaveformTimeline 都监听 Store，需防止循环触发
2. 时间精度: 使用秒(小数)而非毫秒，统一数据格式
3. 虚拟滚动: SubtitleList 必须使用 vue-virtual-scroller，不能因字幕少就跳过
4. 波形缓存: 峰值数据应缓存到 CacheService (7天TTL)

---
阶段 4: 辅助功能组件层

目标

实现验证、AI助手、任务监控等增强功能。

实现内容

4.1 ValidationPanel

- 问题检测规则:
  - 时间重叠 (error)
  - 字数超长 (warning, >30字)
  - 显示时长异常 (warning, <0.5s 或 >7s)
  - 空字幕 (error)
- 问题列表显示
- 点击跳转定位
- 一键修复可修复问题
- 导出验证报告 (JSON)

4.2 AIAssistant

- 功能模式切换 (润色/翻译/建议)
- 多语言翻译下拉选择
- API 调用 (/api/ai/assist)
- 流式响应显示
- 对比视图 (原文 vs 修改)
- 应用到字幕
- 历史记录 (localStorage)

4.3 TaskMonitor

- el-popover 弹窗设计
- 最近任务列表 (最多8个)
- 实时进度条
- 暂停/恢复/取消操作
- 任务完成跳转编辑器

验收标准

- ValidationPanel 正确检测各类问题
- 点击问题可跳转到对应字幕
- AIAssistant 可调用后端 AI 接口
- 润色结果可一键应用到字幕
- TaskMonitor 实时显示后台任务进度
- 任务完成后可直接进入编辑器

测试页面设计

<!-- views/AssistTestView.vue -->
<template>
  <el-tabs>
    <el-tab-pane label="验证面板">
      <ValidationPanel />
    </el-tab-pane>
    <el-tab-pane label="AI助手">
      <AIAssistant :context="currentSubtitle" />
    </el-tab-pane>
  </el-tabs>
  <TaskMonitor />
</template>

注意事项

1. AI 降级: 后端 AI 接口不可用时，应优雅降级显示错误
2. 验证性能: 字幕数量多时，验证计算使用 computed 缓存
3. 任务状态: TaskMonitor 需同时监听 SSE 和轮询，确保不丢失更新

---
阶段 5: 主视图整合

目标

组装所有组件为完整的 EditorView，配置路由，替换旧前端入口。

实现内容

5.1 EditorView 实现

- splitpanes 可调整布局
- 子组件协调 (provide/inject)
- 顶部工具栏 (返回、项目名、保存、导出、布局切换)
- 底部状态栏 (字幕数、当前位置、最后保存时间)
- 自动保存 (30秒间隔)
- 键盘快捷键统一管理 (Ctrl+S, Ctrl+Z, Ctrl+Y)
- 离开确认 (beforeRouteLeave)

5.2 路由配置

const routes = [
  { path: '/', redirect: '/tasks' },
  { path: '/tasks', component: TaskListView },
  { path: '/editor/:jobId', component: EditorView, props: true },
]

5.3 TaskListView (任务列表页)

- 任务卡片网格显示
- 上传新视频入口
- 任务状态筛选
- 删除任务

5.4 整合入口

- 修改 index.html 指向新前端
- 移除或归档旧前端代码

验收标准

- 从任务列表点击任务可进入编辑器
- 编辑器布局可拖拽调整大小
- 所有子组件正常工作且数据同步
- Ctrl+S 保存成功
- 未保存时离开有确认提示
- 导出 SRT/VTT/TXT/JSON 功能正常
- 完整流程: 上传 -> 转录 -> 编辑 -> 导出

布局结构

┌────────────────────────────────────────────────────────────┐
│ [返回] 项目名.mp4  [*未保存]   [播放控制]   [撤销][重做][保存][导出▼][布局][任务] │
├──────────────────────────────┬─────────────────────────────┤
│                              │  [字幕列表 | 问题检查 | AI] │
│     VideoStage               │                             │
│                              │                             │
├──────────────────────────────┤                             │
│                              │                             │
│    WaveformTimeline          │                             │
│                              │                             │
├──────────────────────────────┴─────────────────────────────┤
│ 共 156 条字幕  当前: #42   最后保存: 14:32:00              │
└────────────────────────────────────────────────────────────┘

注意事项

1. 路由守卫: 使用 beforeRouteLeave 而非 window.onbeforeunload
2. 布局持久化: 面板大小存入 localStorage
3. 错误边界: 子组件错误不应导致整个编辑器崩溃
4. 旧前端隔离: 完成后彻底删除旧前端代码，不要保留"兼容模式"

---
阶段 6: 优化与收尾

目标

性能优化、测试完善、文档更新。

实现内容

6.1 性能优化

- 虚拟滚动性能检测 (10000条字幕测试)
- 波形渲染优化 (大文件>1小时)
- 缓存命中率监控
- 组件懒加载 (AIAssistant)

6.2 测试

- Store 单元测试 (Vitest)
- 组件测试 (@vue/test-utils)
- E2E 测试 (可选, Cypress)

6.3 构建优化

// vite.config.js
rollupOptions: {
  output: {
    manualChunks: {
      'vendor': ['vue', 'vue-router', 'pinia'],
      'ui': ['element-plus'],
      'waveform': ['wavesurfer.js']
    }
  }
}

6.4 文档更新

- 更新组件文档的变更部分
- 删除旧前端相关文档

验收标准

- Lighthouse 性能得分 > 80
- 核心功能测试覆盖率 > 70%
- 生产构建体积 < 500KB (gzip)
- 旧前端代码完全移除

---
开发时间线建议

| 阶段   | 预估工作量  | 依赖      |
|------|--------|---------|
| 阶段 0 | 环境准备   | 无       |
| 阶段 1 | 基础设施搭建 | 阶段 0    |
| 阶段 2 | 状态管理   | 阶段 1    |
| 阶段 3 | 核心组件   | 阶段 2    |
| 阶段 4 | 辅助功能   | 阶段 2    |
| 阶段 5 | 主视图整合  | 阶段 3, 4 |
| 阶段 6 | 优化收尾   | 阶段 5    |

阶段 3 和阶段 4 可以并行开发，它们都只依赖阶段 2 的 Store。

---
通用注意事项

1. 绝对路径禁止: 所有资源路径使用 /api/ 前缀，由 Vite 代理转发
2. FFmpeg 路径: 前端不涉及 FFmpeg，全部由后端处理
3. 模型路径: 前端不涉及模型文件，全部由后端处理
4. 代码风格: 使用 Composition API + <script setup>
5. 类型安全: 关键数据结构使用 JSDoc 或 TypeScript 注释
6. 日志规范: 开发环境 console.log，生产环境移除
