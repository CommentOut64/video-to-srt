# 任务进度统一 - 完整分析与修改方案

> 文档版本: V1.1
> 创建日期: 2024
> 最后更新: 2024
> 状态: 待实施

---

## 一、问题概述

当前项目存在以下核心问题：

| 问题编号 | 问题描述 | 影响范围 | 严重程度 |
|---------|---------|---------|---------|
| P1 | 任务监控启动时卡住，必须手动刷新 | TaskMonitor、EditorHeader | 高 |
| P2 | 动态进度区卡进度，必须手动刷新 | EditorHeader | 高 |
| P3 | 多套进度机制且彼此不一致 | 全局 | 高 |
| P4 | 对齐阶段进度没有显示 | EditorView | 中 |
| P5 | 进度字段命名不统一 (percent/progress/percentage) | 前后端 | 高 |
| P6 | SSE信号字段不一致 (code vs signal) | 前后端 | 高 |
| P7 | 错误状态缺乏可视化反馈 | 前端UI | 中 |

---

## 二、系统架构分析

### 2.1 当前数据流

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              后端                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  TranscriptionService                           JobQueueService          │
│  ├─ _update_progress()                          ├─ worker_loop()         │
│  │   └─ 计算阶段进度                             │                        │
│  │   └─ _push_sse_progress()                    ├─ _notify_queue_change()│
│  │       ├─ 频道: job:{id}                       │   └─ 推送queue_update  │
│  │       │   └─ 事件: progress                   │                        │
│  │       │   └─ 字段: percent ✓                  ├─ _notify_job_status()  │
│  │       └─ 频道: global                         │   └─ 推送job_status    │
│  │           └─ 事件: job_progress               │   └─ 字段: progress ✗  │
│  │           └─ 字段: percent ✓                  │                        │
│  │                                               ├─ _notify_job_progress()│
│  └─ _push_sse_signal()                          │   └─ 【从未被调用!】     │
│      └─ 频道: job:{id}                           │   └─ 字段: progress ✗  │
│      └─ 事件: signal                             │                        │
│      └─ 字段: code ✗ (前端期望signal)            └────────────────────────┤
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ SSE 事件流
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              前端                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  sseChannelManager.js                                                    │
│  ├─ subscribeGlobal()                                                    │
│  │   ├─ onJobProgress(jobId, data.percent, data)  ← 期望percent          │
│  │   └─ onJobStatus(jobId, status, data)                                 │
│  │                                                                        │
│  └─ subscribeJob(jobId)                                                  │
│      ├─ onProgress(data)  ← data.percent                                 │
│      └─ onSignal(data.signal, data)  ← 期望data.signal，收到data.code    │
│                                                                           │
│  ───────────────────────────────────────────────────────────             │
│                                                                           │
│  App.vue                              EditorView.vue                     │
│  ├─ syncTasksFromBackend() ← 无超时   ├─ subscribeSSE()                  │
│  └─ subscribeGlobal()                 │   └─ handleProgress(data.percent)│
│      ├─ onJobProgress → store         │   └─ handleSignal(data.signal)   │
│      └─ onJobStatus → store           └─ startProgressPolling() ← 冗余    │
│                                            └─ 15秒轮询一次                │
│                                                                           │
│  ───────────────────────────────────────────────────────────             │
│                                                                           │
│  unifiedTaskStore.js                                                     │
│  ├─ updateTaskProgress(jobId, progress, status)                          │
│  ├─ updateTaskStatus(jobId, status)                                      │
│  └─ updateTaskMessage(jobId, message)                                    │
│                                                                           │
│  ───────────────────────────────────────────────────────────             │
│                                                                           │
│  UI 组件                                                                  │
│  ├─ TaskMonitor       → task.progress (从store读取)                      │
│  ├─ EditorHeader      → currentTaskProgress (props传入)                  │
│  └─ EditorView        → taskProgress (本地ref + SSE)                     │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 关键问题定位

#### 问题1: `_notify_job_progress()` 从未被调用

**文件**: `backend/app/services/job_queue_service.py`

```python
# 第420-436行 - 方法定义
def _notify_job_progress(self, job_id: str):
    """推送任务进度更新到全局SSE（低频调用，节省带宽）"""
    job = self.jobs.get(job_id)
    if not job:
        return

    data = {
        "id": job_id,
        "progress": job.progress,  # ← 字段名不一致！应为percent
        "message": job.message,
        "phase": job.phase,
        "processed": job.processed,
        "total": job.total,
        "timestamp": time.time()
    }

    self.sse_manager.broadcast_sync("global", "job_progress", data)
```

**问题**: 此方法在整个文件中**从未被调用**！导致全局频道没有进度推送。

#### 问题2: 进度字段命名不一致

| 位置 | 事件类型 | 字段名 | 是否正确 |
|-----|---------|--------|---------|
| `transcription_service._push_sse_progress()` 第651行 | progress | `percent` | ✓ |
| `transcription_service._push_sse_progress()` 第663行 (global) | job_progress | `percent` | ✓ |
| `job_queue_service._notify_job_status()` 第411行 | job_status | `progress` | ✗ |
| `job_queue_service._notify_job_progress()` 第428行 | job_progress | `progress` | ✗ |
| `sseChannelManager.subscribeGlobal()` 第61行 | job_progress | 期望`percent` | - |

#### 问题3: SSE信号字段不一致

**后端发送** (`job_queue_service.py` 第281-289行):
```python
self.sse_manager.broadcast_sync(
    f"job:{job.job_id}",
    "signal",
    {
        "code": f"job_{job.status}",  # ← 使用 "code"
        "message": job.message,
        "status": job.status
    }
)
```

**前端期望** (`EditorView.vue` 第433行):
```javascript
if (data.signal === 'job_complete') {  // ← 期望 "signal"
    ...
}
```

#### 问题4: 轮询和SSE混用

**文件**: `frontend/src/views/EditorView.vue`

```javascript
// 第466-480行
function startProgressPolling() {
  progressPollTimer = setInterval(async () => {
    await loadTranscribingSegments()  // 调用 getTranscriptionText()
  }, 15000)  // 15秒轮询
}
```

与SSE实时推送形成冲突，可能导致界面抖动。

#### 问题5: 启动无超时保护

**文件**: `frontend/src/App.vue`

```javascript
// 第27-36行
const syncSuccess = await taskStore.syncTasksFromBackend()  // ← 无超时
if (syncSuccess) {
  console.log('[App] 任务列表同步成功')
} else {
  console.warn('[App] 任务列表同步失败')
}
```

如果后端响应缓慢，整个应用会卡住。

---

## 三、标准进度模型设计

### 3.1 后端标准进度模型

```typescript
interface ProgressData {
  // 任务标识
  job_id: string;

  // 核心进度
  percent: number;           // 总进度百分比 (0-100)，保留1位小数
  phase: PhaseType;          // 当前阶段
  phase_percent: number;     // 当前阶段内进度 (0-100)

  // 任务状态
  status: TaskStatus;        // 任务状态
  message: string;           // 状态消息

  // 处理统计
  processed: number;         // 已处理项数
  total: number;             // 总项数

  // 元信息
  language?: string;         // 检测到的语言
  timestamp: number;         // 时间戳
}

// 阶段类型枚举
enum PhaseType {
  PENDING = "pending",         // 等待开始
  EXTRACT = "extract",         // 提取音频
  SPLIT = "split",             // 音频分段
  TRANSCRIBE = "transcribe",   // 转录中
  ALIGN = "align",             // 对齐中
  TRANSLATE = "translate",     // 翻译中（预留）
  PROOFREAD = "proofread",     // 校对中（预留）
  SRT = "srt",                 // 生成字幕
  COMPLETE = "complete"        // 完成
}

// 任务状态枚举
enum TaskStatus {
  CREATED = "created",
  QUEUED = "queued",
  PROCESSING = "processing",
  PAUSED = "paused",
  FINISHED = "finished",
  FAILED = "failed",
  CANCELED = "canceled"
}
```

### 3.2 阶段权重配置

```python
# backend/app/core/config.py
PHASE_WEIGHTS = {
    "pending": 0,       # 等待开始
    "extract": 5,       # 音频提取占5%
    "split": 5,         # 音频分段占5%
    "transcribe": 55,   # 转录处理占55%
    "align": 25,        # 对齐处理占25%
    "translate": 0,     # 翻译（预留）
    "proofread": 0,     # 校对（预留）
    "srt": 5,          # SRT生成占5%
    "complete": 5       # 完成确认占5%
}
TOTAL_WEIGHT = 100
```

### 3.3 前端阶段显示配置

```javascript
// frontend/src/constants/taskPhases.js
export const PHASE_CONFIG = {
  pending: {
    label: '等待中',
    color: 'gray',
    bgColor: 'rgba(139, 148, 158, 0.15)'
  },
  extract: {
    label: '提取音频',
    color: '#8b949e',
    bgColor: 'rgba(139, 148, 158, 0.15)'
  },
  split: {
    label: '分段中',
    color: '#8b949e',
    bgColor: 'rgba(139, 148, 158, 0.15)'
  },
  transcribe: {
    label: '转录中',
    color: '#58a6ff',
    bgColor: 'rgba(88, 166, 255, 0.15)'
  },
  align: {
    label: '对齐中',
    color: '#3fb950',
    bgColor: 'rgba(63, 185, 80, 0.15)'
  },
  translate: {
    label: '翻译中',
    color: '#a371f7',
    bgColor: 'rgba(163, 113, 247, 0.15)'
  },
  proofread: {
    label: '校对中',
    color: '#f778ba',
    bgColor: 'rgba(247, 120, 186, 0.15)'
  },
  srt: {
    label: '生成字幕',
    color: '#3fb950',
    bgColor: 'rgba(63, 185, 80, 0.15)'
  },
  complete: {
    label: '已完成',
    color: '#3fb950',
    bgColor: 'rgba(63, 185, 80, 0.15)'
  },
  error: {
    label: '错误',
    color: '#f85149',
    bgColor: 'rgba(248, 81, 73, 0.15)'
  }
}

// 状态显示配置
export const STATUS_CONFIG = {
  created: { label: '已创建', color: '#8b949e' },
  queued: { label: '排队中', color: '#8b949e' },
  processing: { label: '处理中', color: '#58a6ff' },
  paused: { label: '已暂停', color: '#d29922' },
  finished: { label: '已完成', color: '#3fb950' },
  failed: { label: '失败', color: '#f85149' },
  canceled: { label: '已取消', color: '#8b949e' }
}
```

---

## 四、附加功能设计（翻译与校对）

### 4.1 设计原则

翻译和校对作为**可选附加功能**，采用以下设计原则：

1. **进度条复用**：翻译和校对直接复用主进度条，不创建多层进度条
2. **独立流程**：每个流程独立 0-100% 计算，流程切换时进度归零
3. **前置依赖**：翻译和校对必须在转录对齐完成后才能开始
4. **流式更新**：所有阶段均采用 SSE 实时推送，不使用轮询

### 4.2 流程切换示意

```
阶段1: 核心流程（转录+对齐）
[████████████████████████████░░░░░░░░] 75% 对齐中

↓ 核心完成后，如果启用了翻译

阶段2: 翻译流程（进度归零重新开始）
[██████████░░░░░░░░░░░░░░░░░░░░░░░░░░] 30% 翻译中

↓ 翻译完成后，如果启用了校对

阶段3: 校对流程（进度再次归零）
[████████████████░░░░░░░░░░░░░░░░░░░░] 45% 校对中
```

### 4.3 阶段权重配置

```python
# backend/app/core/config.py

# 核心流程权重（转录+对齐 = 100%）
CORE_PHASE_WEIGHTS = {
    "pending": 0,
    "extract": 5,       # 音频提取占5%
    "split": 5,         # 音频分段占5%
    "transcribe": 60,   # 转录处理占60%
    "align": 25,        # 对齐处理占25%
    "srt": 5,          # SRT生成占5%
}

# 附加阶段（独立流程，各自100%）
ADDON_PHASES = {
    "translate": {"label": "翻译中", "color": "#a371f7", "weight": 100},
    "proofread": {"label": "校对中", "color": "#f778ba", "weight": 100},
}
```

### 4.4 进度数据结构扩展

```typescript
interface ProgressData {
  job_id: string;

  // 核心进度字段
  percent: number;           // 当前流程进度 (0-100)
  phase: PhaseType;          // 当前阶段
  phase_percent: number;     // 当前阶段内进度

  // 流程标识（新增）
  flow: FlowType;            // 当前所处流程

  // 任务状态
  status: TaskStatus;
  message: string;

  // 流程完成状态（新增）
  flow_status?: {
    core: 'pending' | 'processing' | 'finished' | 'failed';
    translate: 'pending' | 'processing' | 'finished' | 'failed';
    proofread: 'pending' | 'processing' | 'finished' | 'failed';
  };

  // ...其他字段
}

// 流程类型枚举（新增）
enum FlowType {
  CORE = "core",           // 核心流程（转录+对齐）
  TRANSLATE = "translate", // 翻译流程
  PROOFREAD = "proofread", // 校对流程
  DONE = "done"           // 全部完成
}

// 阶段类型扩展
enum PhaseType {
  // 核心阶段
  PENDING = "pending",
  EXTRACT = "extract",
  SPLIT = "split",
  TRANSCRIBE = "transcribe",
  ALIGN = "align",
  SRT = "srt",

  // 附加阶段
  TRANSLATE = "translate",
  PROOFREAD = "proofread",

  // 完成状态
  COMPLETE = "complete"
}
```

### 4.5 前端阶段配置扩展

```javascript
// frontend/src/constants/taskPhases.js

export const PHASE_CONFIG = {
  // 核心阶段
  pending: { label: '等待中', color: '#8b949e', flow: 'core' },
  extract: { label: '提取音频', color: '#8b949e', flow: 'core' },
  split: { label: '分段中', color: '#8b949e', flow: 'core' },
  transcribe: { label: '转录中', color: '#58a6ff', flow: 'core' },
  align: { label: '对齐中', color: '#3fb950', flow: 'core' },
  srt: { label: '生成字幕', color: '#3fb950', flow: 'core' },

  // 附加阶段（独立流程）
  translate: { label: '翻译中', color: '#a371f7', flow: 'translate' },
  proofread: { label: '校对中', color: '#f778ba', flow: 'proofread' },

  // 完成状态
  complete: { label: '已完成', color: '#3fb950', flow: 'done' }
}

// 流程显示标签（用于区分显示）
export const FLOW_LABELS = {
  core: '转录',
  translate: '翻译',
  proofread: '校对',
  done: '完成'
}
```

### 4.6 Store 任务模型扩展

```javascript
// frontend/src/stores/unifiedTaskStore.js

function addTask(taskData) {
  const task = {
    job_id: taskData.job_id,
    filename: taskData.filename,
    status: taskData.status || 'created',

    // 当前进度（统一字段，不同流程复用）
    progress: 0,
    phase: 'pending',
    phase_percent: 0,
    message: '',

    // 当前所处流程（新增）
    flow: 'core',  // core / translate / proofread / done

    // 附加功能配置（创建任务时设置）
    settings: {
      translate: {
        enabled: false,
        targetLang: 'en'
      },
      proofread: {
        enabled: false
      }
    },

    // 各流程完成状态（新增）
    flowStatus: {
      core: 'pending',
      translate: 'pending',
      proofread: 'pending'
    },

    // ...其他字段
  }

  tasksMap.value.set(task.job_id, task)
  saveTasks()
}

// 更新进度（处理流程切换）
function updateTaskProgress(jobId, percent, status, extraData = {}) {
  const task = tasksMap.value.get(jobId)
  if (!task) return

  const newFlow = extraData.flow || 'core'

  // 流程切换时，进度自然从新值开始（后端会发0）
  if (newFlow !== task.flow) {
    console.log(`[Store] 流程切换: ${task.flow} -> ${newFlow}`)
    task.flow = newFlow
  }

  task.progress = typeof percent === 'number' ? Math.round(percent * 10) / 10 : 0
  if (status) task.status = status
  if (extraData.phase) task.phase = extraData.phase
  if (extraData.phase_percent !== undefined) task.phase_percent = extraData.phase_percent
  if (extraData.message) task.message = extraData.message

  task.updatedAt = Date.now()
}
```

### 4.7 UI 显示逻辑

```vue
<!-- EditorHeader.vue 动态进度区 -->
<template>
  <div class="progress-capsule">
    <div class="progress-track">
      <div
        class="progress-fill"
        :style="{
          width: currentTaskProgress + '%',
          background: getProgressColor()
        }"
      ></div>
    </div>
    <span class="capsule-text">
      <!-- 流程标识徽章（仅非核心流程显示） -->
      <span v-if="currentFlow !== 'core'" class="flow-badge">
        {{ flowLabel }}
      </span>
      <!-- 阶段标签 -->
      <span class="phase-label" :style="{ color: phaseColor }">
        {{ phaseLabel }}
      </span>
      {{ formatProgress(currentTaskProgress) }}%
    </span>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { PHASE_CONFIG, FLOW_LABELS } from '@/constants/taskPhases'

const props = defineProps({
  currentTaskProgress: Number,
  currentTaskPhase: String,
  currentFlow: { type: String, default: 'core' }
})

const phaseLabel = computed(() =>
  PHASE_CONFIG[props.currentTaskPhase]?.label || '处理中'
)

const phaseColor = computed(() =>
  PHASE_CONFIG[props.currentTaskPhase]?.color || '#58a6ff'
)

const flowLabel = computed(() =>
  FLOW_LABELS[props.currentFlow] || ''
)

function getProgressColor() {
  return PHASE_CONFIG[props.currentTaskPhase]?.color || '#58a6ff'
}
</script>

<style scoped>
.flow-badge {
  padding: 1px 4px;
  margin-right: 4px;
  font-size: 10px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
}
</style>
```

### 4.8 后端流程控制

```python
# backend/app/services/transcription_service.py

def _run_pipeline(self, job: JobState):
    """执行转录处理管道（支持附加流程）"""

    # ========== 阶段1: 核心流程 ==========
    job.flow = "core"

    # 提取音频
    self._update_progress(job, 'extract', 0, '提取音频中')
    # ...

    # 音频分段
    self._update_progress(job, 'split', 0, '音频分段中')
    # ...

    # 转录处理
    self._update_progress(job, 'transcribe', 0, '加载模型中')
    # ...

    # 对齐处理
    self._update_progress(job, 'align', 0, '准备对齐...')
    # ...

    # 生成SRT
    self._update_progress(job, 'srt', 0, '写入 SRT...')
    # ...

    # 标记核心流程完成
    job.flow_status['core'] = 'finished'
    self._push_sse_signal(job, "core_complete", "转录完成")

    # ========== 阶段2: 翻译流程（可选） ==========
    if job.settings.translate.enabled:
        job.flow = "translate"
        job.phase = "translate"
        job.progress = 0  # 进度归零
        job.phase_percent = 0
        self._push_sse_progress(job)  # 推送流程切换

        self._run_translate(job)

        job.flow_status['translate'] = 'finished'
        self._push_sse_signal(job, "translate_complete", "翻译完成")

    # ========== 阶段3: 校对流程（可选） ==========
    if job.settings.proofread.enabled:
        job.flow = "proofread"
        job.phase = "proofread"
        job.progress = 0  # 进度归零
        job.phase_percent = 0
        self._push_sse_progress(job)

        self._run_proofread(job)

        job.flow_status['proofread'] = 'finished'
        self._push_sse_signal(job, "proofread_complete", "校对完成")

    # ========== 全部完成 ==========
    job.flow = "done"
    job.status = 'finished'
    job.phase = 'complete'
    job.progress = 100
    self._push_sse_signal(job, "job_complete", "全部处理完成")
```

### 4.9 SSE 事件扩展

```python
# 新增信号类型
SIGNAL_TYPES = {
    # 核心流程
    'core_complete': '核心流程完成',

    # 附加流程
    'translate_complete': '翻译完成',
    'proofread_complete': '校对完成',

    # 最终完成
    'job_complete': '全部处理完成',

    # 错误和控制
    'job_failed': '任务失败',
    'job_canceled': '任务取消',
    'job_paused': '任务暂停',
    'memory_warning': '内存警告'
}
```

### 4.10 JobSettings 模型扩展

```python
# backend/app/models/job_models.py

from dataclasses import dataclass, field

@dataclass
class TranslateSettings:
    """翻译设置"""
    enabled: bool = False
    target_lang: str = "en"         # 目标语言
    provider: str = "openai"        # 翻译服务商（openai/google/deepl）

@dataclass
class ProofreadSettings:
    """校对设置"""
    enabled: bool = False
    style: str = "formal"           # 校对风格（formal/casual/technical）

@dataclass
class JobSettings:
    """任务设置"""
    # 原有字段
    model: str = "medium"
    device: str = "cuda"
    compute_type: str = "float16"
    batch_size: int = 16
    word_timestamps: bool = False

    # 新增：附加任务设置
    translate: TranslateSettings = field(default_factory=TranslateSettings)
    proofread: ProofreadSettings = field(default_factory=ProofreadSettings)
```

### 4.11 设计优势总结

| 优势 | 说明 |
|------|------|
| **UI简洁** | 始终只有一个进度条，用户界面清爽 |
| **逻辑清晰** | 每个流程独立0-100%，易于理解 |
| **前提明确** | 翻译/校对必须在转录完成后才能开始，避免资源冲突 |
| **扩展方便** | 未来添加配音、压制等功能时架构不变 |
| **复用高** | 进度条、SSE机制、UI组件全部复用 |
| **性能好** | 流程串行执行，无需并发管理 |

---

## 五、SSE事件规范

### 5.1 频道定义

| 频道ID | 用途 | 推送方 | 订阅方 |
|-------|------|-------|-------|
| `global` | 全局任务事件 | JobQueueService + TranscriptionService | App.vue |
| `job:{job_id}` | 单任务详细进度 | TranscriptionService | EditorView |
| `models` | 模型下载进度 | ModelManager | ModelDownloader |

### 5.2 事件类型规范

#### 全局频道 (global)

| 事件类型 | 触发时机 | 数据结构 |
|---------|---------|---------|
| `connected` | SSE连接建立 | `{ channel_id, message, timestamp }` |
| `initial_state` | 连接后首次推送 | `{ queue, running, interrupted, jobs }` |
| `queue_update` | 队列变化 | `{ queue, running, interrupted, timestamp }` |
| `job_status` | 任务状态变化 | `{ id, status, percent, message, filename, phase, timestamp }` |
| `job_progress` | 任务进度更新 | `{ id, percent, phase, phase_percent, message, processed, total, timestamp }` |
| `ping` | 心跳 | `{ timestamp, count }` |

#### 单任务频道 (job:{job_id})

| 事件类型 | 触发时机 | 数据结构 |
|---------|---------|---------|
| `connected` | SSE连接建立 | `{ channel_id, message, timestamp }` |
| `initial_state` | 连接后首次推送 | `{ job_id, phase, percent, status, message, processed, total, language }` |
| `progress` | 进度更新 | `{ job_id, phase, percent, phase_percent, message, status, processed, total, language }` |
| `signal` | 关键节点信号 | `{ job_id, signal, message, status, percent }` |
| `segment` | 单段转录完成 | `{ segment_index, segments, language, progress }` |
| `aligned` | 对齐完成 | `{ segments, word_segments, message }` |
| `align_progress` | 对齐进度 | `{ job_id, phase, batch, segments, message }` |
| `ping` | 心跳 | `{ timestamp, count }` |

### 5.3 信号代码规范

```javascript
// 统一使用 signal 字段，不使用 code
const SIGNAL_TYPES = {
  // 核心流程
  CORE_COMPLETE: 'core_complete',

  // 附加流程
  TRANSLATE_COMPLETE: 'translate_complete',
  PROOFREAD_COMPLETE: 'proofread_complete',

  // 最终完成
  JOB_COMPLETE: 'job_complete',

  // 错误和控制
  JOB_FAILED: 'job_failed',
  JOB_CANCELED: 'job_canceled',
  JOB_PAUSED: 'job_paused',
  MEMORY_WARNING: 'memory_warning'
}
```

---

## 六、修改清单

### 6.1 后端修改

#### 修改1: 统一进度字段命名

**文件**: `backend/app/services/job_queue_service.py`

```python
# 第408-415行 - _notify_job_status()
def _notify_job_status(self, job_id: str, status: str):
    """推送任务状态变化到全局SSE"""
    job = self.jobs.get(job_id)
    if not job:
        return

    data = {
        "id": job_id,
        "status": status,
        "percent": round(job.progress, 1),  # ← 改为 percent，保留1位小数
        "message": job.message,
        "filename": job.filename,
        "phase": job.phase,  # ← 新增：阶段信息
        "timestamp": time.time()
    }

    self.sse_manager.broadcast_sync("global", "job_status", data)

# 第420-436行 - _notify_job_progress()
def _notify_job_progress(self, job_id: str):
    """推送任务进度更新到全局SSE"""
    job = self.jobs.get(job_id)
    if not job:
        return

    data = {
        "id": job_id,
        "percent": round(job.progress, 1),  # ← 改为 percent，保留1位小数
        "phase": job.phase,
        "phase_percent": 0,  # ← 新增：阶段内进度（需要从job获取）
        "message": job.message,
        "processed": job.processed,
        "total": job.total,
        "timestamp": time.time()
    }

    self.sse_manager.broadcast_sync("global", "job_progress", data)
```

#### 修改2: 统一信号字段

**文件**: `backend/app/services/job_queue_service.py`

```python
# 第281-289行 - worker_loop 中的信号推送
# 将 "code" 改为 "signal"
self.sse_manager.broadcast_sync(
    f"job:{job.job_id}",
    "signal",
    {
        "signal": f"job_{job.status}",  # ← 改为 signal
        "job_id": job.job_id,
        "message": job.message,
        "status": job.status,
        "percent": round(job.progress, 1)
    }
)
```

#### 修改3: 进度四舍五入

**文件**: `backend/app/services/transcription_service.py`

```python
# 第625行 - _update_progress()
job.progress = round((done_weight + current_weight) / total_weight * 100, 1)  # ← 改为1位小数
```

#### 修改4: 新增阶段内进度计算

**文件**: `backend/app/services/transcription_service.py`

```python
# 在 JobState 模型中新增 phase_percent 字段
# 在 _update_progress 中计算并设置
def _update_progress(self, job, phase, phase_ratio, message=""):
    job.phase = phase
    job.phase_percent = round(phase_ratio * 100, 1)  # 阶段内进度

    # ... 现有的总进度计算逻辑 ...

    job.progress = round((done_weight + current_weight) / total_weight * 100, 1)
```

### 6.2 前端修改

#### 修改1: 创建阶段配置常量

**新建文件**: `frontend/src/constants/taskPhases.js`

```javascript
/**
 * 任务阶段和状态配置常量
 */

// 阶段配置
export const PHASE_CONFIG = {
  pending: { label: '等待中', color: '#8b949e', bgColor: 'rgba(139, 148, 158, 0.15)' },
  extract: { label: '提取音频', color: '#8b949e', bgColor: 'rgba(139, 148, 158, 0.15)' },
  split: { label: '分段中', color: '#8b949e', bgColor: 'rgba(139, 148, 158, 0.15)' },
  transcribe: { label: '转录中', color: '#58a6ff', bgColor: 'rgba(88, 166, 255, 0.15)' },
  align: { label: '对齐中', color: '#3fb950', bgColor: 'rgba(63, 185, 80, 0.15)' },
  translate: { label: '翻译中', color: '#a371f7', bgColor: 'rgba(163, 113, 247, 0.15)' },
  proofread: { label: '校对中', color: '#f778ba', bgColor: 'rgba(247, 120, 186, 0.15)' },
  srt: { label: '生成字幕', color: '#3fb950', bgColor: 'rgba(63, 185, 80, 0.15)' },
  complete: { label: '已完成', color: '#3fb950', bgColor: 'rgba(63, 185, 80, 0.15)' }
}

// 状态配置
export const STATUS_CONFIG = {
  created: { label: '已创建', color: '#8b949e', bgColor: 'rgba(139, 148, 158, 0.15)' },
  queued: { label: '排队中', color: '#8b949e', bgColor: 'rgba(139, 148, 158, 0.15)' },
  processing: { label: '处理中', color: '#58a6ff', bgColor: 'rgba(88, 166, 255, 0.15)' },
  paused: { label: '已暂停', color: '#d29922', bgColor: 'rgba(210, 153, 34, 0.15)' },
  finished: { label: '已完成', color: '#3fb950', bgColor: 'rgba(63, 185, 80, 0.15)' },
  failed: { label: '失败', color: '#f85149', bgColor: 'rgba(248, 81, 73, 0.15)' },
  canceled: { label: '已取消', color: '#8b949e', bgColor: 'rgba(139, 148, 158, 0.15)' },
  error: { label: '连接错误', color: '#f85149', bgColor: 'rgba(248, 81, 73, 0.15)' }
}

// 获取阶段显示信息
export function getPhaseInfo(phase) {
  return PHASE_CONFIG[phase] || PHASE_CONFIG.pending
}

// 获取状态显示信息
export function getStatusInfo(status) {
  return STATUS_CONFIG[status] || STATUS_CONFIG.created
}

// 格式化进度显示
export function formatProgress(percent) {
  if (typeof percent !== 'number' || isNaN(percent)) return '0.0'
  return percent.toFixed(1)
}
```

#### 修改2: 统一sseChannelManager字段处理

**文件**: `frontend/src/services/sseChannelManager.js`

```javascript
// 第43-71行 - subscribeGlobal
subscribeGlobal(handlers = {}) {
  const channelId = 'global'
  const url = `${this.baseURL}/api/events/global`

  return this._subscribe(channelId, url, {
    initial_state: (data) => {
      console.log('[SSE Global] 初始状态:', data)
      handlers.onInitialState?.(data)
    },
    queue_update: (data) => {
      handlers.onQueueUpdate?.(data.queue)
    },
    job_status: (data) => {
      // 兼容处理：优先使用percent，fallback到progress
      const percent = data.percent ?? data.progress ?? 0
      handlers.onJobStatus?.(data.id, data.status, { ...data, percent })
    },
    job_progress: (data) => {
      // 兼容处理：优先使用percent，fallback到progress
      const percent = data.percent ?? data.progress ?? 0
      handlers.onJobProgress?.(data.id, percent, { ...data, percent })
    },
    connected: (data) => {
      handlers.onConnected?.(data)
    },
    ping: () => {}
  })
}

// 第87-127行 - subscribeJob
subscribeJob(jobId, handlers = {}) {
  const channelId = `job:${jobId}`
  const url = `${this.baseURL}/api/stream/${jobId}`

  return this._subscribe(channelId, url, {
    initial_state: (data) => {
      handlers.onInitialState?.(data)
    },
    progress: (data) => {
      handlers.onProgress?.(data)
    },
    signal: (data) => {
      // 兼容处理：优先使用signal，fallback到code
      const signal = data.signal || data.code

      if (signal === 'job_complete') {
        handlers.onComplete?.(data)
      } else if (signal === 'job_failed') {
        handlers.onFailed?.(data)
      } else if (signal === 'job_paused') {
        handlers.onPaused?.(data)
      } else if (signal === 'job_canceled') {
        handlers.onCanceled?.(data)
      }

      handlers.onSignal?.(signal, data)
    },
    align_progress: (data) => {
      handlers.onAlignProgress?.(data)
    },
    segment: (data) => {
      handlers.onSegment?.(data)
    },
    aligned: (data) => {
      handlers.onAligned?.(data)
    },
    proxy_progress: (data) => {
      handlers.onProxyProgress?.(data.progress)
    },
    proxy_complete: (data) => {
      handlers.onProxyComplete?.()
    },
    connected: (data) => {
      handlers.onConnected?.(data)
    },
    ping: () => {}
  })
}
```

#### 修改3: 移除EditorView中的轮询

**文件**: `frontend/src/views/EditorView.vue`

```javascript
// 删除或禁用 startProgressPolling 和相关轮询逻辑
// 完全依赖SSE进行进度更新

// 如果需要保留作为fallback，改为60秒超长轮询
function startProgressPolling() {
  stopProgressPolling()
  // 仅作为SSE失败时的备用方案，间隔延长到60秒
  progressPollTimer = setInterval(async () => {
    if (!isTranscribing.value) {
      stopProgressPolling()
      return
    }
    // 仅在SSE断开时才执行轮询
    if (!sseConnected.value) {
      try {
        await loadTranscribingSegments()
      } catch (e) {
        console.warn('[EditorView] 轮询刷新失败:', e)
      }
    }
  }, 60000)  // 改为60秒
}
```

#### 修改4: App.vue添加超时保护

**文件**: `frontend/src/App.vue`

```javascript
onMounted(async () => {
  console.log('[App] 应用已挂载，执行初始化')

  // 第一步：从后端同步任务列表（添加超时保护）
  console.log('[App] 步骤 1: 从后端同步任务列表...')
  try {
    // 添加5秒超时
    const syncPromise = taskStore.syncTasksFromBackend()
    const timeoutPromise = new Promise((_, reject) =>
      setTimeout(() => reject(new Error('同步超时')), 5000)
    )

    const syncSuccess = await Promise.race([syncPromise, timeoutPromise])
      .catch(err => {
        console.warn('[App] 任务列表同步超时或失败:', err.message)
        return false
      })

    if (syncSuccess) {
      console.log('[App] 任务列表同步成功')
    }
  } catch (error) {
    console.error('[App] 任务列表同步异常:', error)
  }

  // 第二步：立即订阅全局 SSE（不等待同步完成）
  console.log('[App] 步骤 2: 订阅全局 SSE 事件流...')
  unsubscribeGlobal = sseChannelManager.subscribeGlobal({
    // ... 现有handlers
  })
})
```

#### 修改5: 更新unifiedTaskStore任务模型

**文件**: `frontend/src/stores/unifiedTaskStore.js`

```javascript
// 更新任务数据结构
function addTask(taskData) {
  const task = {
    job_id: taskData.job_id,
    filename: taskData.filename,
    file_path: taskData.file_path || null,
    status: taskData.status || TaskStatus.CREATED,
    phase: taskData.phase || 'pending',
    progress: taskData.progress || 0,
    phase_percent: taskData.phase_percent || 0,  // 新增：阶段内进度
    message: taskData.message || '',
    settings: taskData.settings || null,
    language: taskData.language || null,  // 新增：语言
    processed: taskData.processed || 0,   // 新增：已处理数
    total: taskData.total || 0,           // 新增：总数
    createdAt: taskData.createdAt || Date.now(),
    updatedAt: Date.now(),
    isDirty: false,
    sseConnected: false,  // 新增：SSE连接状态
    lastError: null       // 新增：最后错误信息
  }

  tasksMap.value.set(task.job_id, task)
  saveTasks()
}

// 更新进度方法
function updateTaskProgress(jobId, percent, status, extraData = {}) {
  const task = tasksMap.value.get(jobId)
  if (task) {
    task.progress = typeof percent === 'number' ? Math.round(percent * 10) / 10 : 0  // 保留1位小数
    if (status) task.status = status
    if (extraData.phase) task.phase = extraData.phase
    if (extraData.phase_percent !== undefined) task.phase_percent = extraData.phase_percent
    if (extraData.processed !== undefined) task.processed = extraData.processed
    if (extraData.total !== undefined) task.total = extraData.total
    task.updatedAt = Date.now()
  }
}

// 新增：更新SSE连接状态
function updateTaskSSEStatus(jobId, connected, error = null) {
  const task = tasksMap.value.get(jobId)
  if (task) {
    task.sseConnected = connected
    task.lastError = error
    task.updatedAt = Date.now()
  }
}
```

#### 修改6: 更新TaskMonitor显示阶段标签

**文件**: `frontend/src/components/editor/TaskMonitor/index.vue`

```vue
<template>
  <!-- ... -->

  <!-- 任务信息 -->
  <div class="task-info">
    <div class="task-header">
      <span class="task-name" :title="task.title || task.filename">
        {{ task.title || task.filename }}
      </span>
      <!-- 使用阶段标签替代简单状态 -->
      <span
        class="task-phase-tag"
        :style="{
          background: getPhaseStyle(task).bgColor,
          color: getPhaseStyle(task).color
        }"
      >
        {{ getPhaseLabel(task) }}
      </span>
    </div>

    <!-- 进度条 -->
    <div v-if="['processing', 'queued'].includes(task.status)" class="task-progress">
      <div class="progress-bar">
        <div class="progress-fill" :style="{ width: task.progress + '%' }"></div>
      </div>
      <span class="progress-text">{{ formatProgress(task.progress) }}%</span>
    </div>

    <!-- ... -->
  </div>
</template>

<script setup>
import { PHASE_CONFIG, STATUS_CONFIG, formatProgress } from '@/constants/taskPhases'

// 获取阶段样式
function getPhaseStyle(task) {
  if (task.status === 'failed') {
    return STATUS_CONFIG.failed
  }
  if (task.status === 'processing' && task.phase) {
    return PHASE_CONFIG[task.phase] || PHASE_CONFIG.pending
  }
  return STATUS_CONFIG[task.status] || STATUS_CONFIG.created
}

// 获取阶段标签文本
function getPhaseLabel(task) {
  if (task.status === 'failed') {
    return '失败'
  }
  if (task.status === 'processing' && task.phase) {
    return PHASE_CONFIG[task.phase]?.label || '处理中'
  }
  return STATUS_CONFIG[task.status]?.label || task.status
}
</script>
```

#### 修改7: 更新EditorHeader显示阶段

**文件**: `frontend/src/components/editor/EditorHeader.vue`

```vue
<template>
  <!-- 中间：动态进度区 -->
  <div class="header-center">
    <!-- 当前任务转录中 -->
    <div v-if="isCurrentTaskTranscribing" class="progress-capsule">
      <div class="progress-track">
        <div class="progress-fill" :style="{ width: currentTaskProgress + '%' }"></div>
      </div>
      <!-- 显示阶段和进度 -->
      <span class="capsule-text">
        <span class="phase-label" :style="{ color: phaseColor }">{{ phaseLabel }}</span>
        {{ formatProgress(currentTaskProgress) }}%
      </span>
    </div>
    <!-- ... -->
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { PHASE_CONFIG, formatProgress } from '@/constants/taskPhases'

const props = defineProps({
  // ... 现有props
  currentTaskPhase: { type: String, default: 'pending' }  // 新增
})

// 阶段标签
const phaseLabel = computed(() => {
  return PHASE_CONFIG[props.currentTaskPhase]?.label || '处理中'
})

// 阶段颜色
const phaseColor = computed(() => {
  return PHASE_CONFIG[props.currentTaskPhase]?.color || '#58a6ff'
})
</script>
```

---

## 七、错误处理设计

### 7.1 SSE连接错误处理

```javascript
// sseChannelManager.js 增强错误处理
_createConnection(channelId, url, eventHandlers) {
  try {
    const eventSource = new EventSource(url)

    eventSource.onerror = (error) => {
      console.error(`[SSE ${channelId}] 连接错误:`, error)

      // 发送连接错误事件
      this.emit('connection_error', { channelId, error })

      // 通知handlers
      eventHandlers.onError?.({ channelId, error, readyState: eventSource.readyState })

      if (eventSource.readyState === EventSource.CLOSED) {
        this._scheduleReconnect(channelId)
      }
    }

    eventSource.onopen = () => {
      console.log(`[SSE ${channelId}] 连接已打开`)
      this.emit('connection_open', { channelId })
      eventHandlers.onOpen?.({ channelId })
    }

    // ...
  } catch (error) {
    console.error(`[SSE ${channelId}] 创建连接失败:`, error)
    this.emit('connection_failed', { channelId, error })
    this._scheduleReconnect(channelId)
  }
}
```

### 7.2 前端错误状态显示

```vue
<!-- TaskMonitor错误状态 -->
<div v-if="task.lastError" class="task-error-indicator">
  <svg class="error-icon" viewBox="0 0 24 24">
    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
  </svg>
  <span>{{ task.lastError }}</span>
</div>

<!-- SSE断开指示器 -->
<div v-if="!task.sseConnected && task.status === 'processing'" class="sse-disconnected">
  <span class="warning-dot"></span>
  <span>连接中断，等待重连...</span>
</div>
```

---

## 八、实施计划

### 8.1 阶段一：后端统一（优先级：高）

| 任务 | 文件 | 估计复杂度 |
|-----|------|----------|
| 统一进度字段为 `percent` | job_queue_service.py | 低 |
| 统一信号字段为 `signal` | job_queue_service.py | 低 |
| 进度四舍五入到1位小数 | transcription_service.py | 低 |
| 新增 `phase_percent` 字段 | transcription_service.py | 中 |
| 调用 `_notify_job_progress` | job_queue_service.py | 低 |

### 8.2 阶段二：前端Store统一（优先级：高）

| 任务 | 文件 | 估计复杂度 |
|-----|------|----------|
| 创建阶段配置常量 | constants/taskPhases.js | 低 |
| 更新任务数据模型 | unifiedTaskStore.js | 中 |
| 兼容处理SSE字段 | sseChannelManager.js | 中 |

### 8.3 阶段三：前端UI更新（优先级：中）

| 任务 | 文件 | 估计复杂度 |
|-----|------|----------|
| 更新TaskMonitor阶段显示 | TaskMonitor/index.vue | 中 |
| 更新EditorHeader阶段显示 | EditorHeader.vue | 中 |
| 更新EditorView进度处理 | EditorView.vue | 中 |
| 添加错误状态显示 | 多个组件 | 中 |

### 8.4 阶段四：优化和清理（优先级：低）

| 任务 | 文件 | 估计复杂度 |
|-----|------|----------|
| 移除冗余轮询 | EditorView.vue | 低 |
| 添加超时保护 | App.vue | 低 |
| 添加SSE重连指示器 | 多个组件 | 低 |

---

## 九、测试用例

### 9.1 后端测试

```python
# test_progress_consistency.py
def test_progress_field_name():
    """测试进度字段统一为percent"""
    # 模拟SSE推送
    data = service._push_sse_progress(job)
    assert 'percent' in data
    assert 'progress' not in data  # 确保没有使用旧字段名

def test_signal_field_name():
    """测试信号字段统一为signal"""
    # 模拟信号推送
    data = service._push_sse_signal(job, 'job_complete')
    assert 'signal' in data
    assert data['signal'] == 'job_complete'
    assert 'code' not in data  # 确保没有使用旧字段名

def test_progress_decimal():
    """测试进度保留1位小数"""
    job.progress = 33.333333
    data = service._push_sse_progress(job)
    assert data['percent'] == 33.3
```

### 9.2 前端测试

```javascript
// test_progress_display.spec.js
describe('TaskMonitor', () => {
  it('should display phase label correctly', () => {
    const task = { status: 'processing', phase: 'transcribe', progress: 50 }
    expect(getPhaseLabel(task)).toBe('转录中')
  })

  it('should format progress with one decimal', () => {
    expect(formatProgress(33.333)).toBe('33.3')
    expect(formatProgress(100)).toBe('100.0')
  })
})

describe('SSE Field Compatibility', () => {
  it('should handle both percent and progress fields', () => {
    const data1 = { id: '123', percent: 50 }
    const data2 = { id: '123', progress: 50 }

    // 两种格式都应该被正确处理
    expect(extractPercent(data1)).toBe(50)
    expect(extractPercent(data2)).toBe(50)
  })
})
```

---

## 十、回滚方案

如果实施过程中出现问题，可按以下步骤回滚：

1. **后端回滚**: 恢复 `job_queue_service.py` 和 `transcription_service.py` 的备份
2. **前端回滚**: 恢复 `sseChannelManager.js`、`unifiedTaskStore.js` 等文件的备份
3. **临时兼容**: 前端保留对 `progress` 和 `code` 字段的兼容处理，确保新旧版本后端都能正常工作

---

## 十一、附录

### A. 相关文件清单

| 文件路径 | 类型 | 主要改动 |
|---------|------|---------|
| `backend/app/services/job_queue_service.py` | 后端 | 统一字段名、调用通知方法、支持流程切换 |
| `backend/app/services/transcription_service.py` | 后端 | 进度精度、阶段内进度、附加流程控制 |
| `backend/app/core/config.py` | 后端 | 阶段权重配置、附加阶段定义 |
| `backend/app/models/job_models.py` | 后端 | 新增翻译和校对设置模型 |
| `frontend/src/constants/taskPhases.js` | 前端 | 新建，阶段配置、流程标签 |
| `frontend/src/services/sseChannelManager.js` | 前端 | 字段兼容处理 |
| `frontend/src/stores/unifiedTaskStore.js` | 前端 | 数据模型更新、流程切换处理 |
| `frontend/src/views/EditorView.vue` | 前端 | 移除轮询、更新进度处理 |
| `frontend/src/components/editor/EditorHeader.vue` | 前端 | 阶段显示、流程徽章 |
| `frontend/src/components/editor/TaskMonitor/index.vue` | 前端 | 阶段标签显示 |
| `frontend/src/App.vue` | 前端 | 超时保护 |

### B. 参考资料

- [SSE规范](https://html.spec.whatwg.org/multipage/server-sent-events.html)
- [EventSource MDN文档](https://developer.mozilla.org/en-US/docs/Web/API/EventSource)
- 项目内文档: `docs/新前端/fix/任务进度统一.md`

---

> 文档结束
