# 视频播放器问题修复补充

## 修复日期
2025年12月1日

## 问题背景

在完成了《播放问题修复总结.md》中的初步修复后，用户报告仍存在以下两个问题：

1. **空格键依然无法在每次加载编辑器后的第一次波形区域定位后响应**：但一旦使用点击按钮切换播放状态后又可以使用空格键了
2. **播放视频时拖动进度条，会导致跳回原进度点**：即拖不动进度

## 深度调查

使用 tr:scout agent 进行了深入的代码调查，生成了两份详细的调查报告：
- `llmdoc/agent/space_key_focus_issue_investigation_report.md`
- `llmdoc/agent/progress_bar_seek_loop_issue_report.md`（预期）

### 问题1：空格键无法响应

#### 根本原因

**焦点管理问题**：WaveSurfer 在初始化时创建了一个独立的 `audio` 元素作为媒体源，当用户点击波形区域进行定位后，这个隐藏的 audio 元素获得了浏览器焦点。

当焦点在 audio/video 元素上时，**浏览器的默认媒体控制会优先拦截空格键**（用于播放/暂停媒体），导致自定义的 useShortcuts 全局键盘监听器无法捕获该事件。

#### 为什么点击按钮后恢复正常

点击 PlaybackControls 的 togglePlay 按钮会将焦点从 WaveSurfer 的 audio 元素转移到按钮元素上，从而恢复了 window 级别的键盘事件监听器的正常工作。

### 问题2：拖动进度条跳回原点

#### 根本原因

**watch 监听器遗漏 isSeeking 检查**：`VideoStage/index.vue` (第253-267行) 的 `watch(() => projectStore.player.currentTime, ...)` 监听器**没有检查 `isSeeking` 状态**。

虽然之前的修复已经：
- 在 `onTimeUpdate` 中添加了 `isSeeking` 检查
- 在 `VideoStage` 的 `seeking/seeked` 事件中设置/解除锁
- 在 `PlaybackControls` 的拖动逻辑中设置/解除锁

但是遗漏了 **`watch currentTime` 监听器**的检查。

#### 问题流程

1. 用户拖动进度条 → `PlaybackControls.startDrag()` 设置 `isSeeking = true`
2. `onDrag` 持续调用 `projectStore.seekTo(newTime)` 更新 Store 时间
3. **VideoStage 的 watch 被触发**，因为它没有检查 `isSeeking`，所以会执行 `video.currentTime = newTime`
4. video seek 操作触发 `seeking/seeked` 事件
5. 虽然 `onTimeUpdate` 被 `isSeeking` 阻止，但 **watch 还在持续响应**
6. 如果有延迟，可能会导致"跳回"现象

#### 为什么只在播放时出现问题

- **播放状态**：`timeupdate` 事件持续触发，频繁更新 `Store.currentTime`，增加了竞态条件的概率
- **暂停状态**：`timeupdate` 事件不触发，只有用户操作会改变时间，竞态条件概率极低

## 修复方案

### 修复1：VideoStage watch currentTime

**文件**：`frontend/src/components/editor/VideoStage/index.vue`

**位置**：第253-274行

**修改内容**：在 watch 监听器开头添加 isSeeking 检查

```javascript
watch(() => projectStore.player.currentTime, (newTime) => {
  if (!videoRef.value) return

  // 【关键修复】如果正在seek中，不要响应watch（避免拖动进度条时跳回）
  if (projectStore.player.isSeeking) {
    console.log('[VideoStage] watch被isSeeking锁阻止，跳过同步')
    return
  }

  const now = Date.now()

  // 防止循环同步：如果刚刚由video更新了Store，则跳过
  if (now - lastSyncTime.value < 300) return

  // 只有当时间差较大时才seek（避免小抖动）
  const timeDiff = Math.abs(videoRef.value.currentTime - newTime)
  if (timeDiff > 0.5) {
    videoRef.value.currentTime = newTime
    lastSyncTime.value = now
    console.log(`[VideoStage] 外部跳转: ${newTime.toFixed(2)}s (diff: ${timeDiff.toFixed(2)}s)`)
  }
})
```

**效果**：确保在用户拖动进度条时，watch 监听器不会干扰 seek 操作，彻底解决"跳回原点"问题。

### 修复2：WaveSurfer audio 元素焦点管理

**文件**：`frontend/src/components/editor/WaveformTimeline/index.vue`

#### 修改2.1：设置 audio 元素 tabIndex

**位置**：第316-328行（在 wavesurfer.on("ready") 事件处理中）

**修改内容**：

```javascript
wavesurfer.on("ready", () => {
  isLoading.value = false;
  isReady.value = true;
  retryCount.value = 0;

  // 【关键修复】防止 WaveSurfer 的 audio 元素获取焦点，导致空格键被浏览器拦截
  // 为 audio 元素设置 tabIndex = -1，使其不可通过 Tab 键聚焦
  const audioElement = wavesurfer.getMediaElement();
  if (audioElement) {
    audioElement.setAttribute('tabindex', '-1');
    console.log('[WaveformTimeline] audio元素tabIndex已设置为-1，防止焦点捕获');
  }

  // 其余初始化逻辑...
});
```

#### 修改2.2：点击后重置焦点

**位置**：第706-719行（在 handleUpperZoneMouseDown 函数中）

**修改内容**：

```javascript
function handleUpperZoneMouseDown(e) {
  if (!wavesurfer || !isReady.value) return;
  if (e.button !== 0) return;

  e.preventDefault();
  e.stopPropagation();

  // 【关键修复】点击波形后，强制将焦点重置到 body，防止焦点停留在 audio 元素上
  // 这样可以确保 useShortcuts 的全局键盘监听器能正常捕获空格键
  if (document.activeElement && document.activeElement.tagName === 'AUDIO') {
    document.body.focus();
    console.log('[WaveformTimeline] 焦点已重置到body，确保空格键正常工作');
  }

  // 其余交互逻辑...
}
```

**效果**：
1. 设置 `tabIndex = -1` 防止 audio 元素通过 Tab 键获得焦点
2. 点击波形后强制重置焦点到 body，确保空格键始终能被全局键盘监听器捕获

## 修复效果预期

### 问题1：空格键响应
- ✅ 点击波形区域定位后，空格键立即可用，无需点击按钮恢复
- ✅ audio 元素不再捕获焦点，不会干扰全局键盘监听
- ✅ 用户体验流畅，符合预期

### 问题2：进度条拖动
- ✅ 播放状态下拖动进度条，不会跳回原进度点
- ✅ 暂停状态下拖动进度条，依然保持流畅
- ✅ 多组件同步机制完善，全局 isSeeking 锁覆盖所有关键路径

## 测试建议

### 空格键测试
1. 加载编辑器
2. 点击波形区域的任意位置（定位播放时间）
3. 立即按空格键
4. 预期：视频应正常播放/暂停，无需先点击按钮

### 进度条拖动测试（重点）
1. 播放视频
2. 在播放过程中拖动进度条到不同位置
3. 预期：进度条可以顺畅拖动，不会跳回原位置
4. 重复多次测试，确保稳定性

### 综合测试
1. 快速连续操作：点击波形 → 按空格键 → 拖动进度条 → 再按空格键
2. 预期：所有操作流畅无卡顿，没有异常行为

## 技术总结

### 关键改进

1. **完善了全局 isSeeking 锁机制**：
   - 之前的修复覆盖了 `onTimeUpdate` 和事件处理
   - 本次修复补充了 **watch 监听器**的检查
   - 现在所有修改 currentTime 的路径都受到锁保护

2. **解决了焦点管理问题**：
   - WaveSurfer audio 元素不再干扰全局键盘事件
   - 点击波形后主动重置焦点，确保用户操作流畅
   - 采用双重保险：tabIndex + 主动重置

3. **数据流更加清晰**：
   ```
   用户拖动进度条
       ↓
   设置 isSeeking = true
       ↓
   持续更新 Store.currentTime
       ↓
   watch 检查 isSeeking → 跳过（不触发video.seek）
   onTimeUpdate 检查 isSeeking → 跳过（不更新Store）
       ↓
   seeking/seeked 事件管理锁
       ↓
   解除 isSeeking = false
       ↓
   恢复正常同步
   ```

## 风险评估

### 低风险
- 修改都是增量式的，只添加了检查逻辑
- 不影响原有功能，只是完善了边界情况的处理
- 使用了标准的 DOM API（setAttribute, focus）

### 需要注意
- 确保所有浏览器都支持 `getMediaElement()` 方法（WaveSurfer v7+）
- 焦点重置可能在极端情况下影响其他UI元素的焦点状态（但风险很低）

## 后续建议

1. **监控日志**：观察控制台中的修复日志，确认机制正常工作
2. **边界测试**：测试快速连续操作，确保没有遗漏的竞态条件
3. **用户反馈**：收集实际用户使用反馈，验证修复效果

---

**修复完成时间**：2025年12月1日
**修复人**：Claude Code AI Assistant
**关联文档**：
- 《播放问题修复总结.md》（初步修复）
- 《播放问题调查报告.md》（问题分析）
- `llmdoc/agent/space_key_focus_issue_investigation_report.md`（空格键问题调查）
