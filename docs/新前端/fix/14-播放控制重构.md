# 播放控制系统重构 - PlaybackManager 单例模式

## 问题背景

之前使用 `usePlaybackController` hook 存在架构问题：

### 问题根因

每个组件（VideoStage、PlaybackControls、WaveformTimeline）各自创建了**独立的控制器实例**，导致：

1. **锁状态不共享**：PlaybackControls 拖拽时设置的锁，VideoStage 的实例感知不到
2. **Video 元素无法被其他组件直接操作**：SimplePlaybackController 没有 videoRef，无法同步 Video
3. **时间覆盖问题**：Store 被更新后，Video 仍在旧位置播放，timeupdate 把 Store 覆盖回去

```
┌─────────────────────────────────────────────────────────────────┐
│   旧架构问题：三个独立实例，状态不同步                            │
├─────────────────────────────────────────────────────────────────┤
│  VideoStage 实例 A          PlaybackControls 实例 B             │
│  ├─ isSeekLocked: false     ├─ isSeekLocked: true (拖拽时)     │
│  ├─ videoRef: ✅            ├─ videoRef: ❌                     │
│  └─ 持续收到 timeupdate     └─ 无法同步 Video                   │
│                                                                  │
│  结果：拖拽时 Video 继续在旧位置播放，Store 被覆盖回去            │
└─────────────────────────────────────────────────────────────────┘
```

## 新架构设计

### 核心思想：全局单例 + 集中式控制

```
┌─────────────────────────────────────────────────────────────────┐
│                     PlaybackManager (全局单例)                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  统一状态：isSeeking, isDragging, lastSeekTime              │ │
│  │  统一方法：seekTo(), startDragging(), togglePlay()          │ │
│  │  统一资源：videoElement, wavesurferInstance                 │ │
│  │  数据源：projectStore.player (唯一真相来源)                   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
           │                    │                    │
    register│Video         seekTo()            seekTo()
           ▼                    ▼                    ▼
    ┌────────────┐      ┌────────────────┐    ┌─────────────────┐
    │ VideoStage │      │ PlaybackControls│    │ WaveformTimeline│
    │  (注册)     │      │   (调用)        │    │   (注册+调用)   │
    └────────────┘      └────────────────┘    └─────────────────┘
```

### 关键改进

1. **全局单例**：所有组件共享同一个 PlaybackManager 实例
2. **集中式锁管理**：锁状态全局统一，所有组件都能感知
3. **直接操作元素**：PlaybackManager 持有 Video 和 WaveSurfer 的引用，可以直接操作
4. **保护期机制**：seek 后有保护期，期间忽略 Video 的 timeupdate

## 数据流

```
用户拖拽进度条:
  PlaybackControls.startDrag()
    └─► PlaybackManager.startDragging('progressBar')
          ├─► 设置 isSeeking = true (全局锁)
          └─► 返回

用户移动鼠标:
  PlaybackControls.onDrag()
    └─► PlaybackManager.updateDragging(newTime)
          ├─► 更新 projectStore.player.currentTime
          ├─► 直接更新 videoElement.currentTime (✅ 关键!)
          └─► 同步 wavesurfer.seekTo()

此时 Video 触发 timeupdate:
  PlaybackManager.handleVideoTimeUpdate()
    └─► isLocked() = true → 直接返回，不覆盖 Store

用户释放鼠标:
  PlaybackControls.stopDrag()
    └─► PlaybackManager.stopDragging()
          ├─► 记录 lastSeekTime
          └─► 延迟 150ms 后释放锁

150ms 内的 timeupdate:
  PlaybackManager.handleVideoTimeUpdate()
    └─► isInProtectionPeriod() = true → 直接返回
```

## 文件变更

### 新增文件

- `frontend/src/services/PlaybackManager.js` - 全局播放管理器

### 删除文件

- `frontend/src/hooks/usePlaybackController.js` - 已废弃

### 修改文件

- `VideoStage/index.vue` - 注册 Video 元素到 PlaybackManager
- `PlaybackControls/index.vue` - 使用 PlaybackManager
- `WaveformTimeline/index.vue` - 使用 PlaybackManager + 注册 WaveSurfer

## API 变更

### 旧 API (已废弃)

```javascript
// 每个组件各自创建实例
const playbackController = usePlaybackController({ videoRef, componentName })
const playbackController = useSimplePlaybackController('ComponentName')
```

### 新 API

```javascript
// 所有组件共享同一个实例
import { usePlaybackManager } from '@/services/PlaybackManager'

const playbackManager = usePlaybackManager()

// VideoStage 注册 Video 元素
playbackManager.registerVideo(videoRef.value)

// WaveformTimeline 注册 WaveSurfer
playbackManager.registerWaveSurfer(wavesurfer)

// 所有组件使用相同方法
playbackManager.seekTo(time)
playbackManager.startDragging('source')
playbackManager.updateDragging(time)
playbackManager.stopDragging()
playbackManager.togglePlay()
```

## 修复的问题

1. ✅ **播放时拖不动进度**：PlaybackManager 直接操作 Video 元素
2. ✅ **暂停后拖动再播放跳回**：保护期机制防止旧 timeupdate 覆盖
3. ✅ **空格键失效**：WaveformTimeline 的空格键直接调用 togglePlay()
4. ✅ **点击波形无法定位**：seekTo 直接操作 Video 和 WaveSurfer

## 配置常量

```javascript
const CONFIG = {
  SYNC_THRESHOLD: 0.05,        // 时间同步阈值（秒）
  SEEK_LOCK_TIMEOUT: 3000,     // 锁超时时间（毫秒）
  SEEK_PROTECTION_PERIOD: 150, // seek 后的保护期（毫秒）
  DEBOUNCE_DELAY: 30,          // 防抖延迟（毫秒）
}
```
