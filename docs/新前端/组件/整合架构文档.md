# 前端组件整合架构文档

## 概述

本文档说明视频字幕编辑器前端系统的完整架构，包括所有组件的分类、职责、依赖关系和协作方式。通过理解本文档，开发者可以清晰地了解如何将各个独立的组件文档组合成���个完整、高效的前端应用。

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        EditorView                            │
│                      (主视图容器)                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Header: PlaybackControls + Toolbar                  │   │
│  ├──────────────────────────────────────────────────────┤   │
│  │                                                       │   │
│  │  ┌────────────────┐  ┌──────────────────────────┐   │   │
│  │  │  VideoStage    │  │   SubtitleList           │   │   │
│  │  │  ┌──────────┐  │  │   (虚拟滚动)             │   │   │
│  │  │  │ 视频播放 │  │  │                           │   │   │
│  │  │  └──────────┘  │  │                           │   │   │
│  │  │                │  ├──────────────────────────┤   │   │
│  │  ├────────────────┤  │  ValidationPanel         │   │   │
│  │  │ WaveformTimeline│  │  (问题检查)              │   │   │
│  │  │ (波形+缩略图)  │  │                           │   │   │
│  │  └───────��────────┘  ├──────────────────────────┤   │   │
│  │                      │  AIAssistant             │   │   │
│  │                      │  (AI 辅助)               │   │   │
│  │                      └──────────────────────────┘   │   │
│  │                                                       │   │
│  ├──────────────────────────────────────────────────────┤   │
│  │  Footer: 状态栏 + 统计信息                           │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  Popover: TaskMonitor (全局任务监控)                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      State Layer (Pinia)                     │
│  ┌──────────────────┐  ┌────────────────────────────────┐   │
│  │ UnifiedTaskStore │  │      ProjectStore              │   │
│  │ (任务生命周期)   │  │      (字幕数据)                │   │
│  └──────────────────┘  └────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    Service Layer                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐   │
│  │ CacheService │  │  SSEService  │  │  Backend API     │   │
│  │ (多级缓存)   │  │  (实时通信)  │  │  (HTTP 请求)     │   │
│  └──────────────┘  └──────────────┘  └──────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 组件分类

### 1. 状态管理层 (Store Layer)

#### 1.1 UnifiedTaskStore
- **文档**: `UnifiedTaskStore.md`
- **职责**: 管理任务全生命周期（上传→转录→编辑→导出）
- **关键功能**:
  - 任务状态追踪
  - 阶段自动跳转
  - 路由导航控制
  - 任务持久化
- **被依赖**: EditorView, TaskMonitor

#### 1.2 ProjectStore
- **文档**: `ProjectStore.md`
- **职责**: 管理字幕项目数据和编辑状态
- **关键功能**:
  - 字幕 CRUD 操作
  - 撤销/重做机制
  - 验证系统
  - 多级缓存
  - 导入/导出
- **被依赖**: EditorView, SubtitleList, ValidationPanel, AIAssistant

### 2. UI 组件层 (Component Layer)

#### 2.1 容器组件

##### EditorView
- **文档**: `EditorView.md`
- **职责**: 主编辑器视图容器
- **关键功能**:
  - 布局管理（可调整面板大小）
  - 子组件协调
  - 快捷键统一管理
  - 自动保存
  - 离开确认
- **依赖**: 所有 UI 组件 + ProjectStore + UnifiedTaskStore
- **路由**: `/editor/:jobId`

#### 2.2 核心编辑组件

##### VideoStage
- **文档**: `VideoStage.md`
- **职责**: 视频播放和字幕叠加显示
- **关键功能**:
  - HTML5 视频播放
  - 字幕实时叠加
  - 播放状态同步
  - 代理视频处理
- **依赖**: ProjectStore (播放器状态、当前字幕)

##### WaveformTimeline
- **文档**: `WaveformTimeline.md`
- **职责**: 音频波形可视化和时间轴导航
- **关键功能**:
  - wavesurfer.js v7 集成
  - 字幕区域显示和编辑
  - 视频缩略图轨道
  - 后端波形数据加载
- **依赖**: ProjectStore (字幕数据、播放时间), CacheService (波形缓存)

##### SubtitleList
- **文档**: `SubtitleList.md`
- **职责**: 字幕列表显示和编辑
- **关键功能**:
  - 虚拟滚动 (vue-virtual-scroller，始终启用)
  - 实时编辑
  - 批量操作
  - 自动滚动跟随
- **依赖**: ProjectStore (字幕数组、选中项)

##### PlaybackControls
- **文档**: `PlaybackControls.md`
- **职责**: 媒体播放控制
- **关键功能**:
  - 播放/暂停/进度控制
  - 倍速播放
  - 音量控制
  - 键盘快捷键
- **依赖**: ProjectStore (播放器状态)

#### 2.3 辅助功能组件

##### ValidationPanel
- **文档**: `ValidationPanel.md`
- **职责**: 字幕验证和问题检查
- **关键功能**:
  - 实时问题检测（重叠、字数、时长）
  - 问题分类显示
  - 快速定位和修复
  - 报告导出
- **依赖**: ProjectStore (字幕数据、验证错误)

##### AIAssistant
- **文档**: `AIAssistant.md`
- **职责**: AI 辅助编辑
- **关键功能**:
  - 文本润色
  - 多语言翻译
  - 智能建议
  - 历史记录
- **依赖**: ProjectStore (当前字幕), Backend AI API

##### TaskMonitor
- **文档**: `TaskMonitor.md`
- **职责**: 全局任务监控弹窗
- **关键功能**:
  - Edge 风格弹窗设计
  - 任务暂停/恢复/取消
  - 实时进度更新
  - 问题检测提示
- **依赖**: UnifiedTaskStore, SSEService

### 3. 服务层 (Service Layer)

#### 3.1 CacheService
- **文档**: `CacheService.md`
- **职责**: 多级缓存管理
- **关键功能**:
  - L1 内存 LRU 缓存
  - L2 IndexedDB 持久化
  - 自动淘汰和清理
  - 批量操作
- **被依赖**: ProjectStore, WaveformTimeline, VideoStage

#### 3.2 SSEService
- **文档**: `SSEService.md`
- **职责**: 实时通信服务
- **关键功能**:
  - SSE 连接管理
  - 自动重连
  - 心跳检测
  - 降级轮询
- **被依赖**: UnifiedTaskStore, TaskMonitor

## 数据流架构

### 3.1 任务生命周期数据流

```
用户上传视频
    ↓
UnifiedTaskStore.createTask()
    ↓
POST /api/tasks/create
    ↓
任务进入队列 (phase: 'uploading')
    ↓
SSE 推送进度: task_progress
    ↓
UnifiedTaskStore 更新进度
    ↓
TaskMonitor 显示实时进度
    ↓
上传完成 → 自动转为 phase: 'transcribing'
    ↓
转录完成 → 自动跳转到编辑器
    ↓
router.push(`/editor/${jobId}`)
```

### 3.2 字幕编辑数据流

```
EditorView 加载
    ↓
ProjectStore.restoreProject(jobId)
    ↓
尝试从 CacheService 恢复
    ↓
如未命中，GET /api/projects/:jobId
    ↓
ProjectStore.importSRT(content)
    ↓
解析 SRT → subtitles 数组
    ↓
触发响应式更新
    ↓
SubtitleList 渲染 (虚拟滚动)
WaveformTimeline 渲染区域
ValidationPanel 检测问题
    ↓
用户编辑字幕
    ↓
ProjectStore.updateSubtitle(id, changes)
    ↓
触发 history.push (撤销/重做)
触发验证检查
触发缓存更新 (debounced)
    ↓
自动保存定时器
    ↓
PUT /api/projects/:jobId
```

### 3.3 实时同步数据流

```
后端任务进度变化
    ↓
SSE 推送事件
    ↓
SSEService.handleMessage('task_progress', data)
    ↓
触发 emit('task_progress', data)
    ↓
UnifiedTaskStore 订阅事件
    ↓
更新任务状态
    ↓
TaskMonitor 响应式更新 UI
```

## 开发流程指南

### 阶段一：搭建基础架构

1. **初始化项目** (Vue 3.4 + Vite)
   ```bash
   npm create vite@latest subtitle-editor -- --template vue
   cd subtitle-editor
   npm install
   ```

2. **安装核心依赖**
   ```bash
   npm install pinia vue-router element-plus
   npm install @vueuse/core
   npm install localforage lru-cache
   npm install wavesurfer.js@7
   npm install vue-virtual-scroller
   npm install splitpanes
   npm install eventemitter3
   npm install markdown-it
   ```

3. **创建目录结构**
   ```
   src/
   ├── stores/
   │   ├── unifiedTaskStore.js
   │   └── projectStore.js
   ├── services/
   │   ├── cacheService.js
   │   └── sseService.js
   ├── components/
   │   ├── TaskMonitor/
   │   ├── VideoStage/
   │   ├── WaveformTimeline/
   │   ├── SubtitleList/
   │   ├── PlaybackControls/
   │   ├── ValidationPanel/
   │   └── AIAssistant/
   ├── views/
   │   └── EditorView.vue
   └── router/
       └── index.js
   ```

### 阶段二：实现服务层

**按以下顺序开发，确保依赖关系正确**:

1. **CacheService** (`CacheService.md`)
   - 实现 LRU 内存缓存
   - 集成 IndexedDB
   - 编写单元测试

2. **SSEService** (`SSEService.md`)
   - 实现 EventSource 封装
   - 添加重连逻辑
   - 测试心跳机制

### 阶段三：实现状态管理

1. **ProjectStore** (`ProjectStore.md`)
   - 实现字幕 CRUD
   - 实现撤销/重做栈
   - 集成 CacheService
   - 实���验证系统

2. **UnifiedTaskStore** (`UnifiedTaskStore.md`)
   - 实现任务状态机
   - 集成 SSEService
   - 实现阶段跳转逻辑

### 阶段四：实现核心组件

**建议并行开发以下组件**:

1. **VideoStage** (`VideoStage.md`)
   - HTML5 video 集成
   - 字幕叠加逻辑
   - 与 ProjectStore 双向绑定

2. **WaveformTimeline** (`WaveformTimeline.md`)
   - wavesurfer.js 初始化
   - 区域插件集成
   - 后端波形数据加载

3. **SubtitleList** (`SubtitleList.md`)
   - vue-virtual-scroller 集成
   - 实时编辑功能
   - 批量操作

4. **PlaybackControls** (`PlaybackControls.md`)
   - 播放控制 UI
   - 键盘快捷键
   - 状态同步

### 阶段五：实现辅助组件

1. **ValidationPanel** (`ValidationPanel.md`)
   - 验证规则实现
   - 自动修复功能

2. **AIAssistant** (`AIAssistant.md`)
   - AI API 集成
   - 建议应用逻辑

3. **TaskMonitor** (`TaskMonitor.md`)
   - 弹窗 UI 实现
   - SSE 事件订阅

### 阶段六：整合主视图

1. **EditorView** (`EditorView.md`)
   - 组装所有子组件
   - 实现布局系统 (splitpanes)
   - 添加工具栏和状态栏
   - 实现自动保存
   - 配置路由

2. **路由配置**
   ```javascript
   // router/index.js
   import { createRouter, createWebHistory } from 'vue-router'
   import EditorView from '@/views/EditorView.vue'

   const routes = [
     {
       path: '/editor/:jobId',
       name: 'editor',
       component: EditorView,
       props: true
     }
   ]

   export default createRouter({
     history: createWebHistory(),
     routes
   })
   ```

### 阶段七：测试和优化

1. **单元测试**
   - Store 逻辑测试
   - Service 功能测试

2. **集成测试**
   - 组件交互测试
   - 端到端流程测试

3. **性能优化**
   - 虚拟滚动性能
   - 缓存命中率
   - 波形渲染性能

## 关键交互场景

### 场景 1：用户进入编辑器

```
1. 用户点击任务进入编辑器
   → router.push('/editor/job-123')

2. EditorView mounted
   → ProjectStore.restoreProject('job-123')

3. CacheService 查询缓存
   → 命中：直接恢复数据
   → 未命中：fetch /api/projects/job-123

4. 所有子组件响应式更新
   → VideoStage 加载视频
   → WaveformTimeline 渲染波形
   → SubtitleList 显示字��列表
   → ValidationPanel 检查问题
```

### 场景 2：用户编辑字幕文本

```
1. SubtitleList 中用户修改文本
   → ProjectStore.updateSubtitle(id, { text: newText })

2. ProjectStore 更新数据
   → subtitles[index].text = newText
   → history.push(snapshot) // 撤销/重做
   → isDirty = true
   → 触发验证检查

3. 响应式更新传播
   → SubtitleList 重新渲染该项
   → VideoStage 更新字幕显示
   → ValidationPanel 重新验证
   → WaveformTimeline 区域文本更新

4. 防抖缓存更新
   → CacheService.set('project-job-123', data)

5. 自动保存定时器触发
   → PUT /api/projects/job-123
```

### 场景 3：任务进度实时更新

```
1. 后端转录任务进度变化
   → SSE 推送: task_progress

2. SSEService 接收消息
   → handleMessage('task_progress', { jobId, progress: 45 })
   → emit('task_progress', data)

3. UnifiedTaskStore 订阅处理
   → updateTaskProgress('job-123', 45)
   �� tasks['job-123'].progress = 45

4. TaskMonitor 响应式更新
   → 进度条动画到 45%
   → 显示当前阶段文本
```

### 场景 4：用户应用 AI 建议

```
1. AIAssistant 中用户点击"润色"
   → POST /api/ai/assist { mode: 'polish', text: '...' }

2. 后端返回润色结果
   → { text: '润色后的文本', confidence: 0.95 }

3. 用户点击"应用到字幕"
   → emit('apply-suggestion', { subtitleId, newText })
   → EditorView 处理事件
   → ProjectStore.updateSubtitle(subtitleId, { text: newText })

4. 触发正常编辑流程
   → 所有组件响应式更新
   → 历史记录、验证、缓存...
```

## 数据持久化策略

### 本地持久化

1. **项目数据** (ProjectStore)
   - 存储位置: CacheService (IndexedDB)
   - 存储时机:
     - 用户编辑后 (防抖 2秒)
     - 手动保存时
     - 离开页面前
   - 恢复时机: 进入编辑器时优先从缓存恢复

2. **任务状态** (UnifiedTaskStore)
   - 存储位置: localStorage
   - 存储时机: 任务状态变化时
   - 恢复时机: 应用启动时

3. **用户偏好**
   - 布局配置: localStorage
   - AI 历史记录: localStorage
   - 播放器设置: localStorage

### 服务端同步

1. **自动保存**
   - 间隔: 30秒 (可配置)
   - 条件: isDirty === true
   - 接口: PUT /api/projects/:jobId

2. **手动保存**
   - 触发: 用户点击保存按钮
   - 快捷键: Ctrl+S
   - 接口: PUT /api/projects/:jobId

3. **导出**
   - 格式: SRT, VTT, TXT, JSON
   - 方式: 客户端生成 + 下载
   - 可选后端生成

## 错误处理策略

### 网络错误

1. **API 请求失败**
   - 自动重试 (最多 3 次)
   - 指数退避
   - 用户友好提示

2. **SSE ��接中断**
   - 自动重连
   - 降级到轮询
   - 通知用户连接状态

### 数据错误

1. **缓存损坏**
   - 清除损坏缓存
   - 从服务端重新加载
   - 日志记录错误

2. **SRT 解析失败**
   - 显示详细错误位置
   - 提供修复建议
   - 允许手动编辑原文

### 用户操作错误

1. **验证错误**
   - 实时提示
   - 阻止保存 (可选)
   - 提供自动修复

2. **并发冲突**
   - 检测服务端数据变化
   - 提示用户选择版本
   - 支持合并编辑

## 性能优化清单

### 渲染性能

- [ ] SubtitleList 始终使用虚拟滚动
- [ ] WaveformTimeline 使用后端预计算波形数据
- [ ] VideoStage 懒加载视频资源
- [ ] 使用 Vue computed 缓存派生状态
- [ ] 避免不必要的响应式深层监听

### 网���性能

- [ ] 多级缓存策略 (内存 + IndexedDB)
- [ ] API 请求防抖/节流
- [ ] SSE 降级轮询
- [ ] 资源预加载 (视频缩略图、波形数据)
- [ ] Gzip 压缩传输

### 内存性能

- [ ] 及时清理无���数据
- [ ] LRU 缓存自动淘汰
- [ ] 组件销毁时取消订阅
- [ ] 限制历史记录栈大小
- [ ] 避免内存泄漏 (定时器、事件监听器)

## 测试策略

### 单元测试

```javascript
// stores/__tests__/projectStore.spec.js
import { setActivePinia, createPinia } from 'pinia'
import { useProjectStore } from '../projectStore'

describe('ProjectStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  it('should import SRT correctly', () => {
    const store = useProjectStore()
    const srt = '1\n00:00:01,000 --> 00:00:02,000\nHello\n\n'

    store.importSRT(srt)

    expect(store.subtitles).toHaveLength(1)
    expect(store.subtitles[0].text).toBe('Hello')
  })

  it('should support undo/redo', () => {
    const store = useProjectStore()
    store.subtitles = [{ id: 1, text: 'Original' }]

    store.updateSubtitle(1, { text: 'Modified' })
    expect(store.subtitles[0].text).toBe('Modified')

    store.undo()
    expect(store.subtitles[0].text).toBe('Original')

    store.redo()
    expect(store.subtitles[0].text).toBe('Modified')
  })
})
```

### 集成测试

```javascript
// components/__tests__/EditorView.spec.js
import { mount } from '@vue/test-utils'
import { createTestingPinia } from '@pinia/testing'
import EditorView from '../EditorView.vue'

describe('EditorView Integration', () => {
  it('should load project data on mount', async () => {
    const wrapper = mount(EditorView, {
      props: { jobId: 'test-123' },
      global: {
        plugins: [createTestingPinia()]
      }
    })

    await wrapper.vm.$nextTick()

    // 验证数据加载
    expect(wrapper.vm.projectStore.meta.jobId).toBe('test-123')
  })
})
```

### E2E 测试

```javascript
// e2e/editor-workflow.spec.js
describe('Editor Workflow', () => {
  it('should complete full editing workflow', () => {
    cy.visit('/editor/test-job')

    // 等待加载
    cy.contains('字幕列表').should('be.visible')

    // 编辑字幕
    cy.get('.subtitle-item').first().dblclick()
    cy.get('input').clear().type('New text')
    cy.get('input').blur()

    // 验证更新
    cy.get('.subtitle-item').first().should('contain', 'New text')

    // 保存
    cy.contains('保存').click()
    cy.contains('保存成功').should('be.visible')
  })
})
```

## 部署配置

### 构建配置

```javascript
// vite.config.js
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    }
  },
  build: {
    target: 'es2015',
    outDir: 'dist',
    assetsDir: 'assets',
    sourcemap: false,
    minify: 'terser',
    chunkSizeWarningLimit: 1000,
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor': ['vue', 'vue-router', 'pinia'],
          'ui': ['element-plus'],
          'waveform': ['wavesurfer.js']
        }
      }
    }
  },
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  }
})
```

### 环境变量

```bash
# .env.production
VITE_API_BASE_URL=https://api.example.com
VITE_SSE_ENDPOINT=https://api.example.com/stream
VITE_ENABLE_AI_ASSISTANT=true
```

## 总结

本架构文档提供了视频字幕编辑器前��系统的完整蓝图。通过模块化、分层的设计，每个组件都有明确的职责和边界，便于独立开发、测试和维护。

### 关键设计原则

1. **单一职责**: 每个组件只负责一个明确的功能域
2. **依赖倒置**: 通过 Store 和 Service 解耦组件
3. **响应式驱动**: 利用 Vue 响应式系统自动传播更新
4. **Local-First**: 优先使用本地缓存，提升响应速度
5. **渐进增强**: 核心功能稳定，高级功能可选

### 开发建议

1. 严格按照依赖关系顺序开发（服务层 → Store 层 → 组件层）
2. 每个组件开发完成后立即编写测试
3. 使用 TypeScript 增强类型安全（可选但推荐）
4. 遵循 Vue 3 Composition API 最佳实践
5. 定期进行性能分析和优化

### 文档维护

当修改任何组件时，请同步更新：
1. 对应的组件文档 (如 `SubtitleList.md`)
2. 本整合文档中的相关章节
3. 依赖关系图（如有变化）

---

**最后更新**: 2025-11-25
**版本**: v1.0
**维护者**: 开发团队