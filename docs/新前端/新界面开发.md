# Video-to-SRT Proï¼šå‰ç«¯é‡æ„å¼€å‘æ–‡æ¡£ (v2.1)(å·²åºŸå¼ƒ)

## 1\. é¡¹ç›®æ„¿æ™¯ä¸æŠ€æœ¯æ ˆ

  * **æ ¸å¿ƒç†å¿µ**ï¼šLocal-Firstï¼ˆæœ¬åœ°ä¼˜å…ˆï¼‰ã€ç”Ÿäº§åŠ›å·¥å…·ã€éçº¿æ€§ç¼–è¾‘ã€‚
  * **äº¤äº’æ¨¡å¼**ï¼šå·¥ä½œå°æ¨¡å¼ï¼ˆWorkbenchï¼‰ã€‚
  * **æŠ€æœ¯æ ˆå‡çº§**ï¼š
      * **æ¡†æ¶**ï¼šVue 3 (Composition API) + Vite
      * **çŠ¶æ€ç®¡ç†**ï¼šPinia (å•ä¸€ç§æº Single Source of Truth)
      * **UI æ¡†æ¶**ï¼šElement Plus (å®¹å™¨/äº¤äº’ç»„ä»¶) + **SCSS (æ¨¡å—åŒ–æ ·å¼)**
      * **æ ¸å¿ƒåº“**ï¼š
          * **éŸ³è§†é¢‘å¯è§†åŒ–**ï¼š`wavesurfer.js` (V7) â€”â€” *æ³¨ï¼šé‡‡ç”¨ Backend Peaks æ¨¡å¼ä»¥æå‡é•¿éŸ³é¢‘æ€§èƒ½ã€‚*
          * **é•¿åˆ—è¡¨ä¼˜åŒ–**ï¼š`vue-virtual-scroller`
          * **å·¥å…·åº“**ï¼š`@vueuse/core` (æ·±è‰²æ¨¡å¼ã€å¿«æ·é”®ã€ResizeObserver)

-----

## 2\. æ ¸å¿ƒæ•°æ®ç»“æ„ (Pinia Store è®¾è®¡)

å‰ç«¯å¹¶ä¸ç›´æ¥æ“ä½œ SRT å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ç»´æŠ¤ä¸€ä¸ªå“åº”å¼çš„å¯¹è±¡æ•°ç»„ã€‚

```javascript
// stores/projectStore.js

state: () => ({
  // 1. é¡¹ç›®å…ƒæ•°æ®
  meta: {
    jobId: null,
    videoPath: null,      // è§†é¢‘æºæ–‡ä»¶è·¯å¾„ (ç”¨äº <video>)
    audioPath: null,      // éŸ³é¢‘æºæ–‡ä»¶è·¯å¾„ (ç”¨äº wavesurfer)
    peaksPath: null,      // æ³¢å½¢æ•°æ®æ–‡ä»¶è·¯å¾„ (æ–°å¢ï¼šåç«¯é¢„è®¡ç®—çš„æ³¢å½¢æ•°æ®)
    duration: 0,
    lastSaved: Date.now()
  },

  // 1.5 ä»»åŠ¡çŠ¶æ€ç®¡ç†ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
  task: {
    status: 'idle',       // 'idle' | 'transcribing' | 'aligning' | 'finished' | 'error' | 'paused'
    progress: 0,
    currentSegment: 0,
    totalSegments: 0,
    phase: '',            // 'transcribe' | 'align'
    streaming: false,     // æ˜¯å¦æ­£åœ¨æ¥æ”¶ SSE æµ
    hasCheckpoint: false, // æ˜¯å¦æœ‰æ–­ç‚¹å¯æ¢å¤
    originalSettings: {}, // æ–­ç‚¹ä¸­ä¿å­˜çš„åŸå§‹é…ç½®
  },

  // 2. å­—å¹•æ ¸å¿ƒæ•°æ® (Single Source of Truth)
  // ä½¿ç”¨ Map æˆ–ä»¥ ID ä¸º Key çš„å¯¹è±¡å¯èƒ½æ¯”æ•°ç»„æ€§èƒ½æ›´å¥½ï¼Œä½†æ•°ç»„å¯¹è™šæ‹Ÿåˆ—è¡¨æ›´å‹å¥½
  subtitles: [
    {
      id: "uuid-1",       // å”¯ä¸€æ ‡è¯†ç¬¦
      start: 1.500,       // ç§’ (float, 3ä½å°æ•°)
      end: 3.200,
      text: "Hello World",
      status: 'confirmed',  // æ–°å¢ï¼š'draft'(æœªå¯¹é½) | 'confirmed'(å·²å¯¹é½/äººå·¥ä¿®æ”¹)
      isDirty: false      // å•è¡Œè„çŠ¶æ€ï¼ˆç”¨æˆ·æ˜¯å¦ä¿®æ”¹è¿‡ï¼‰
    },
    // ...
  ],

  // 3. æ’­æ”¾å™¨å…¨å±€çŠ¶æ€ (ç”¨äºç»„ä»¶é—´åŒæ­¥)
  player: {
    currentTime: 0,
    isPlaying: false,
    playbackRate: 1.0,
    volume: 1.0
  },

  // 4. è§†å›¾çŠ¶æ€
  view: {
    theme: 'dark',        // 'dark' | 'light'
    zoomLevel: 100,       // æ³¢å½¢ç¼©æ”¾æ¯”ä¾‹
    autoScroll: true      // åˆ—è¡¨è‡ªåŠ¨è·Ÿéš
  }
})

actions: {
  // æ ¸å¿ƒæ“ä½œéœ€å°è£…ä¸º Action ä»¥ä¾¿äºåš æ’¤é”€/é‡åš (Undo/Redo)
  updateSubtitle(id, payload) { ... },
  addSubtitle(index, payload) { ... },
  removeSubtitle(id) { ... },

  // å¯¼å…¥å¯¼å‡º
  parseSRT(rawString) { ... },
  generateSRT() { ... },

  // ========== æ–°å¢ï¼šæ–­ç‚¹ç»­ä¼ ä¸æµå¼è¾“å‡ºæ”¯æŒ ==========

  /**
   * SSEæµå¼æ•°æ®æ¥æ”¶ Action
   * å¤„ç†ä»åç«¯æ¨é€è¿‡æ¥çš„ 'segment' (æœªå¯¹é½) å’Œ 'aligned' (å·²å¯¹é½) äº‹ä»¶
   */
  handleStreamEvent(event) {
    if (event.type === 'segment') {
      // å®æ—¶è¿½åŠ æœªå¯¹é½çš„è‰ç¨¿ç‰‡æ®µ
      // å‰ç«¯æ˜¾ç¤ºä¸ºç°è‰²æˆ–æ–œä½“ï¼Œè¡¨ç¤º"æ­£åœ¨ç”Ÿæˆä¸­"
      event.data.segments.forEach(seg => {
        this.subtitles.push({
          ...seg,
          status: 'draft'  // æ ‡è®°ä¸ºè‰ç¨¿çŠ¶æ€
        })
      })
      this.task.progress = event.data.progress.percentage
      this.task.currentSegment = event.data.progress.processed
      this.task.totalSegments = event.data.progress.total
    }
    else if (event.type === 'aligned') {
      // å¯¹é½å®Œæˆï¼šæ‰¹é‡æ›´æ–°æ—¶é—´è½´ï¼Œä½†ä¿ç•™ç”¨æˆ·åœ¨æµå¼ä¼ è¾“æœŸé—´å¯èƒ½æ‰‹åŠ¨ä¿®æ”¹çš„æ–‡æœ¬
      this.mergeAlignedSubtitles(event.data.segments)
      this.task.phase = 'align'
      this.task.status = 'finished'
    }
    else if (event.type === 'connected') {
      this.task.streaming = true
    }
  },

  /**
   * æ™ºèƒ½åˆå¹¶å¯¹é½ç»“æœ (ä¿ç•™ç”¨æˆ·ä¿®æ”¹)
   * å¦‚æœæ•°æ®é‡>5000æ¡ï¼Œå»ºè®®ä½¿ç”¨Web Workerå¤„ç†
   */
  mergeAlignedSubtitles(alignedData) {
    // å®ç°é€»è¾‘ï¼šéå†å½“å‰ subtitles
    // å¦‚æœç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹è¿‡(isDirty=true)ï¼Œåˆ™ä¿ç•™æ–‡æœ¬åªæ›´æ–°æ—¶é—´è½´
    // å¦åˆ™å®Œå…¨æ›¿æ¢ä¸ºå¯¹é½åçš„é«˜ç²¾åº¦æ•°æ®
    this.subtitles = this.subtitles.map(item => {
      const aligned = alignedData.find(a => a.id === item.id)
      if (!aligned) return item

      if (item.isDirty) {
        // ä¿ç•™ç”¨æˆ·ä¿®æ”¹çš„æ–‡æœ¬ï¼Œä»…æ›´æ–°æ—¶é—´è½´
        return {
          ...item,
          start: aligned.start,
          end: aligned.end,
          status: 'confirmed'
          // text ä¿æŒä¸å˜
        }
      } else {
        // å®Œå…¨ä¿¡ä»»AIçš„å¯¹é½ç»“æœ
        return {
          ...item,
          start: aligned.start,
          end: aligned.end,
          text: aligned.text,
          status: 'confirmed'
        }
      }
    })
  },

  /**
   * åŠ è½½æ–­ç‚¹ä¿¡æ¯ï¼ˆç”¨äºæ¢å¤ä»»åŠ¡ï¼‰
   */
  async loadCheckpoint(jobId) {
    try {
      const response = await fetch(`/api/checkpoint-settings/${jobId}`)
      const data = await response.json()

      if (data.has_checkpoint) {
        this.task.hasCheckpoint = true
        this.task.originalSettings = data.original_settings
        this.task.currentSegment = data.progress.processed
        this.task.totalSegments = data.progress.total
        this.task.progress = (data.progress.processed / data.progress.total) * 100
        return data
      }
      return null
    } catch (error) {
      console.error('åŠ è½½æ–­ç‚¹å¤±è´¥:', error)
      return null
    }
  },

  /**
   * å‚æ•°æ ¡éªŒï¼ˆå¯¹æ¯”å½“å‰UIè®¾ç½®å’Œæ–­ç‚¹ä¸­çš„åŸå§‹è®¾ç½®ï¼‰
   * è¿”å›: { valid: boolean, changes: array, warningLevel: string }
   */
  validateSettingsChange(currentSettings, originalSettings) {
    const immutableParams = ['device', 'word_timestamps']
    const warnParams = ['model']  // å…è®¸ä¿®æ”¹ä½†éœ€ä¸¥é‡è­¦å‘Š
    const freeParams = ['compute_type', 'batch_size', 'cpu_affinity_enabled', 'cpu_affinity_strategy']

    const changedImmutable = []
    const changedWarn = []
    const changedFree = []

    // æ£€æŸ¥ç¦æ­¢ä¿®æ”¹çš„å‚æ•°
    for (const key of immutableParams) {
      if (currentSettings[key] !== originalSettings[key]) {
        changedImmutable.push({
          key,
          old: originalSettings[key],
          new: currentSettings[key]
        })
      }
    }

    // æ£€æŸ¥éœ€è¦è­¦å‘Šçš„å‚æ•°
    for (const key of warnParams) {
      if (currentSettings[key] !== originalSettings[key]) {
        changedWarn.push({
          key,
          old: originalSettings[key],
          new: currentSettings[key]
        })
      }
    }

    // æ£€æŸ¥è‡ªç”±ä¿®æ”¹çš„å‚æ•°
    for (const key of freeParams) {
      if (currentSettings[key] !== originalSettings[key]) {
        changedFree.push({
          key,
          old: originalSettings[key],
          new: currentSettings[key]
        })
      }
    }

    return {
      valid: changedImmutable.length === 0,
      immutableChanges: changedImmutable,
      warnChanges: changedWarn,
      freeChanges: changedFree,
      warningLevel: changedImmutable.length > 0 ? 'error' :
                    changedWarn.length > 0 ? 'warning' :
                    changedFree.length > 0 ? 'info' : 'none'
    }
  }
}
```

-----

## 3\. é¡µé¢å¸ƒå±€ä¸æ ·å¼è§„èŒƒ

### 3.1 æ ·å¼å·¥ç¨‹åŒ–

  * **é¢„å¤„ç†å™¨**ï¼šä½¿ç”¨ **SCSS**ã€‚
  * **æ¨¡å—åŒ–**ï¼šé‡‡ç”¨ Vue Scoped CSS + BEM å‘½åè§„èŒƒï¼Œæˆ–è€… CSS Modulesï¼Œé˜²æ­¢æ ·å¼æ±¡æŸ“ã€‚
  * **å“åº”å¼è®¾è®¡**ï¼š
      * **æ–­ç‚¹**ï¼š`Desktop` (\>1200px), `Laptop` (992px-1200px), `Tablet` (\<992px)ã€‚
      * **ç­–ç•¥**ï¼šåœ¨å°å±å¹•ä¸‹ï¼Œéšè—å³ä¾§å­—å¹•åˆ—è¡¨ï¼ˆæ”¹ä¸ºæŠ½å±‰å¼ Drawer å‘¼å‡ºï¼‰ï¼Œä¼˜å…ˆä¿è¯è§†é¢‘å’Œæ³¢å½¢çš„å¯æ“ä½œåŒºåŸŸã€‚
  * **ä¸»é¢˜å®šåˆ¶ (Theming)**ï¼š
      * åŸºäº CSS Variables å®šä¹‰è¯­ä¹‰åŒ–é¢œè‰²ï¼ˆå¦‚ `--bg-primary`, `--text-normal`ï¼‰ã€‚
      * åˆ©ç”¨ `@vueuse/core` çš„ `useDark` å®ç°ä¸€é”®åˆ‡æ¢ **æ·±è‰²/æµ…è‰²** æ¨¡å¼ã€‚
      * **é»˜è®¤æ·±è‰²**ï¼šé€‚åˆæ²‰æµ¸å¼ç¼–è¾‘ï¼›**å¯é€‰æµ…è‰²**ï¼šé€‚åˆå¼ºå…‰ç¯å¢ƒä¸‹æ ¡å¯¹ã€‚

### 3.2 EditorView (ç¼–è¾‘å™¨) å¸ƒå±€è¯¦æƒ…

é‡‡ç”¨ **Flex/Grid æ··åˆå¸ƒå±€**ï¼Œç¡®ä¿åœ¨çª—å£ç¼©æ”¾æ—¶å„åŒºåŸŸæ¯”ä¾‹åè°ƒã€‚

#### **A. é¡¶éƒ¨å·¥å…·æ  (Header)**

  * **å·¦**ï¼šLogoã€æ–‡ä»¶åã€ä¿å­˜çŠ¶æ€ï¼ˆè‡ªåŠ¨ä¿å­˜ä¸­... / å·²ä¿å­˜ï¼‰ã€‚
  * **å³**ï¼š
      * **ä¸»é¢˜åˆ‡æ¢**ï¼šâ˜€ï¸/ğŸŒ™ å›¾æ ‡ã€‚
      * **å¯¼å‡º**ï¼šSRT/TXT/è§†é¢‘å‹åˆ¶ã€‚
      * **è®¾ç½®**ï¼šæ‰“å¼€è®¾ç½®æ¨¡æ€çª—ã€‚

#### **B. ä¸­éƒ¨å·¥ä½œåŒº (Workspace)** - *æ”¯æŒæ‹–æ‹½æ”¹å˜åˆ†æ å®½åº¦*

  * **å·¦ä¾§ï¼šè§†é¢‘ç›‘è§†å™¨ (Video Monitor)**
      * **è‡ªé€‚åº”**ï¼šä¿æŒ 16:9 æˆ–è§†é¢‘åŸå§‹æ¯”ä¾‹ï¼Œå±…ä¸­æ˜¾ç¤ºã€‚
      * **äº¤äº’**ï¼šæ”¯æŒæ»šè½®ç¼©æ”¾ (Zoom)ã€ç©ºæ ¼æ‹–æ‹½ (Pan)ã€‚
  * **å³ä¾§ï¼šè„šæœ¬ç¼–è¾‘å™¨ (Script Editor)**
      * **åŒæ¨¡å¼åˆ‡æ¢**ï¼š[åˆ—è¡¨æ¨¡å¼] (é»˜è®¤) | [æ–‡ç¨¿æ¨¡å¼] (é€‚åˆå¤§æ®µä¿®æ”¹)ã€‚
      * **å“åº”å¼**ï¼šåœ¨çª„å±æ¨¡å¼ä¸‹è‡ªåŠ¨æŠ˜å ï¼Œç‚¹å‡»å›¾æ ‡ä¾§æ»‘å±•å¼€ã€‚

#### **C. åº•éƒ¨æ§åˆ¶å° (Bottom Console)**

  * **æ’­æ”¾æ§åˆ¶æ¡**ï¼š
      * **å€é€Ÿæ§åˆ¶**ï¼šä¸å†ä»…é™äºä¸‹æ‹‰èœå•ï¼Œæä¾› **è‡ªå®šä¹‰è¾“å…¥æ¡†** (0.5x - 4.0x) å’Œ **æ»‘å—**ï¼Œæ»¡è¶³æé™æ ¡å¯¹éœ€æ±‚ã€‚
      * **éŸ³é‡/é™éŸ³**ã€‚
  * **æ³¢å½¢æ—¶é—´è½´**ï¼š
      * å…¨å®½æ˜¾ç¤ºï¼Œé«˜åº¦è‡ªé€‚åº”ï¼ˆå»ºè®®è‡³å°‘ 150pxï¼‰ã€‚

-----

## 4\. æ ¸å¿ƒç»„ä»¶æŠ€æœ¯è¯¦è§£ä¸ä¼˜åŒ–

### 4.1 åç«¯æ¥å£å¢å¼º (é…åˆé•¿éŸ³é¢‘ä¼˜åŒ–)

ä¸ºäº†è§£å†³ `wavesurfer.js` è§£æé•¿éŸ³é¢‘ï¼ˆ1å°æ—¶+ï¼‰å¯¼è‡´çš„æµè§ˆå™¨å¡æ­»é—®é¢˜ï¼Œå¿…é¡»ç”±åç«¯é¢„è®¡ç®—æ³¢å½¢æ•°æ®ã€‚

  * **æ–°å¢æ¥å£**ï¼š`GET /api/media/{job_id}/peaks`
  * **åŠŸèƒ½**ï¼šåç«¯ä½¿ç”¨ `audiowaveform` (C++å·¥å…·) æˆ– Python `librosa` å¿«é€Ÿæå–éŸ³é¢‘çš„å³°å€¼æ•°æ® (JSON/Dat æ ¼å¼)ã€‚
  * **å‰ç«¯é€»è¾‘**ï¼š`wavesurfer.load(audioUrl, peaksData)`ã€‚è¿™æ ·æ— è®ºéŸ³é¢‘å¤šé•¿ï¼Œæ³¢å½¢å›¾éƒ½æ˜¯ç¬é—´æ¸²æŸ“å‡ºæ¥çš„ã€‚

### 4.2 WaveformTimeline (æ³¢å½¢æ—¶é—´è½´) - *å¢å¼ºäº¤äº’*

  * **æŠ€æœ¯é€‰å‹**ï¼š`wavesurfer.js` + `Regions Plugin` + `Timeline Plugin`ã€‚
  * **åŒæ­¥æ‹–æ‹½ (Sync Dragging)**ï¼š
      * **åŠŸèƒ½**ï¼šåœ¨æ³¢å½¢ä¸Šæ‹–æ‹½ Region çš„è¾¹ç¼˜ï¼ˆè°ƒæ•´æ—¶é—´ï¼‰æ—¶ï¼Œå³ä¾§å­—å¹•åˆ—è¡¨å¯¹åº”çš„æ—¶é—´è¾“å…¥æ¡†æ•°å€¼**å®æ—¶è·³åŠ¨æ›´æ–°**ã€‚
      * **åå‘åŒæ­¥**ï¼šåœ¨å³ä¾§åˆ—è¡¨ä¿®æ”¹æ—¶é—´æ•°å­—æ—¶ï¼Œæ³¢å½¢ä¸Šçš„ Region **å®æ—¶ä½ç§»**ã€‚
  * **æ€§èƒ½ä¼˜åŒ–**ï¼š
      * å¯ç”¨ `backend` æ¨¡å¼ï¼ˆMediaElementï¼‰ï¼Œå¤ç”¨ `<video>` æ ‡ç­¾çš„éŸ³é¢‘è½¨é“ï¼Œé¿å…åŠ è½½ä¸¤ä»½å¤§æ–‡ä»¶ã€‚

### 4.3 å¼‚å¸¸å¤„ç†ä¸é²æ£’æ€§ (Robustness)

è®¾è®¡ä¸€ä¸ªå…¨å±€çš„ `ErrorHandler` æœºåˆ¶ï¼š

1.  **èµ„æºåŠ è½½å¤±è´¥**ï¼š
      * è§†é¢‘/éŸ³é¢‘ 404ï¼šæ˜¾ç¤º"èµ„æºä¸¢å¤±"å ä½å›¾ï¼Œå¹¶æä¾›"é‡æ–°å®šä½æ–‡ä»¶"çš„æŒ‰é’®ã€‚
      * æ³¢å½¢æ•°æ®ç”Ÿæˆå¤±è´¥ï¼šå‰ç«¯è‡ªåŠ¨é™çº§ï¼Œå°è¯•åœ¨æµè§ˆå™¨ç«¯è§£ç éŸ³é¢‘ï¼ˆæ˜¾ç¤º Loading è¿›åº¦æ¡ï¼‰ã€‚
2.  **æ“ä½œä¿æŠ¤**ï¼š
      * **æœªä¿å­˜æ‹¦æˆª**ï¼šæ£€æµ‹ `store.isDirty`ï¼Œåœ¨å…³é—­é¡µé¢/åˆ·æ–°å‰å¼¹å‡º `beforeunload` è­¦å‘Šã€‚
      * **è‡ªåŠ¨ä¿å­˜ (Auto-Save)**ï¼šæ¯ 30 ç§’å°†å½“å‰çŠ¶æ€å†™å…¥ `localStorage` æˆ–åç«¯ä¸´æ—¶æ–‡ä»¶ï¼Œé˜²æ­¢å´©åä¸¢å¤±ã€‚
3.  **é”™è¯¯æç¤º UI**ï¼š
      * ä½¿ç”¨ `ElNotification` æ˜¾ç¤ºéé˜»æ–­å¼é”™è¯¯ï¼ˆå¦‚"è‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"ï¼‰ã€‚
      * å…³é”®é”™è¯¯ï¼ˆå¦‚"WebAssembly å´©æºƒ"ï¼‰ä½¿ç”¨æ¨¡æ€çª—å¼•å¯¼åˆ·æ–°ã€‚

### 4.4 æ–­ç‚¹ç»­ä¼ ä¸æµå¼å“åº”æœºåˆ¶ (Integration)

é…åˆåç«¯æ–­ç‚¹ç»­ä¼ å¢å¼ºåŠŸèƒ½ï¼ˆè¯¦è§ã€Šæ–­ç‚¹ç»­ä¼ å¢å¼ºåŠŸèƒ½-å¼€å‘æ–‡æ¡£.mdã€‹ï¼‰ï¼Œå‰ç«¯éœ€å®ç°å¤æ‚çš„æ¡æ‰‹ä¸æ¸²æŸ“é€»è¾‘ã€‚

#### **A. å¯åŠ¨/æ¢å¤æ—¶çš„å‚æ•°æ ¡éªŒ (Handshake)**

åœ¨è°ƒç”¨æ¢å¤æ¥å£å‰ï¼Œå¿…é¡»å…ˆè¿›è¡Œ"å‚æ•°å…¼å®¹æ€§æ£€æŸ¥"ï¼š

1. **è·å– Checkpoint**ï¼šè°ƒç”¨ `GET /api/checkpoint-settings/{jobId}`ã€‚
2. **æ¯”å¯¹é€»è¾‘**ï¼š
   * **ç¦æ­¢ä¿®æ”¹å‚æ•°** (`device`, `word_timestamps`)ï¼šå¦‚æœç”¨æˆ·åœ¨UIä¸­ä¿®æ”¹äº†è¿™äº›å‚æ•°ï¼Œå¼ºåˆ¶æ¢å¤ä¸ºåŸå€¼å¹¶è­¦å‘Šç”¨æˆ·ã€‚
   * **è­¦å‘Šä¿®æ”¹å‚æ•°** (`model`)ï¼šå¼¹å‡ºè­¦å‘Šå¯¹è¯æ¡†ï¼Œæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·"ä¿®æ”¹æ¨¡å‹ä¼šå¯¼è‡´å‰åå­—å¹•è´¨é‡ä¸ä¸€è‡´ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ"
   * **è‡ªç”±ä¿®æ”¹å‚æ•°** (`compute_type`, `batch_size`, `cpu_affinity_*`)ï¼šæç¤ºç”¨æˆ·å‚æ•°å·²ä¿®æ”¹ï¼Œä½†å…è®¸ç»§ç»­ã€‚

**å®ç°ç¤ºä¾‹**ï¼š

```javascript
// composables/useResumeValidation.js

import { ElMessageBox, ElMessage } from 'element-plus'
import { useProjectStore } from '@/stores/projectStore'

export function useResumeValidation() {
  const store = useProjectStore()

  /**
   * æ¢å¤ä»»åŠ¡å‰çš„å‚æ•°æ ¡éªŒ
   * @param {string} jobId - ä»»åŠ¡ID
   * @param {Object} currentSettings - å½“å‰UIé¢æ¿çš„è®¾ç½®
   * @returns {Promise<boolean>} - æ˜¯å¦å…è®¸ç»§ç»­
   */
  async function validateResume(jobId, currentSettings) {
    // 1. åŠ è½½æ–­ç‚¹ä¿¡æ¯
    const checkpoint = await store.loadCheckpoint(jobId)
    if (!checkpoint || !checkpoint.has_checkpoint) {
      return true  // æ²¡æœ‰æ–­ç‚¹ï¼Œç›´æ¥ç»§ç»­
    }

    // 2. æ ¡éªŒå‚æ•°å˜æ›´
    const validation = store.validateSettingsChange(
      currentSettings,
      checkpoint.original_settings
    )

    // 3. æ ¹æ®æ ¡éªŒç»“æœé‡‡å–ä¸åŒæªæ–½
    if (validation.warningLevel === 'error') {
      // ç¦æ­¢ä¿®æ”¹çš„å‚æ•°è¢«ä¿®æ”¹äº†
      await ElMessageBox.alert(
        `ä»¥ä¸‹å…³é”®å‚æ•°ä¸èƒ½ä¿®æ”¹ï¼Œå°†è‡ªåŠ¨æ¢å¤ä¸ºåŸå§‹å€¼ï¼š\n` +
        validation.immutableChanges.map(c =>
          `- ${c.key}: ${c.old} â†’ ${c.new}`
        ).join('\n'),
        'å‚æ•°ä¿®æ”¹é™åˆ¶',
        { type: 'error' }
      )

      // å¼ºåˆ¶æ¢å¤åŸå€¼
      validation.immutableChanges.forEach(change => {
        currentSettings[change.key] = change.old
      })
      return false  // éœ€è¦ç”¨æˆ·é‡æ–°ç¡®è®¤
    }

    if (validation.warningLevel === 'warning') {
      // modelå‚æ•°è¢«ä¿®æ”¹ï¼Œä¸¥é‡è­¦å‘Š
      try {
        await ElMessageBox.confirm(
          `âš ï¸ æ£€æµ‹åˆ°æ¨¡å‹å‚æ•°å·²ä¿®æ”¹ï¼š\n` +
          validation.warnChanges.map(c =>
            `- ${c.key}: ${c.old} â†’ ${c.new}`
          ).join('\n') +
          `\n\nä¿®æ”¹æ¨¡å‹ä¼šå¯¼è‡´å‰åå­—å¹•è´¨é‡ä¸ä¸€è‡´ï¼\n` +
          `é€‚ç”¨åœºæ™¯ï¼šå‘ç°ç”¨é”™äº†æ¨¡å‹éœ€è¦ä¸­é€”æ›´æ­£ã€‚\n\n` +
          `æ˜¯å¦ç»§ç»­ä½¿ç”¨æ–°æ¨¡å‹ï¼Ÿ`,
          'ä¸¥é‡è­¦å‘Š',
          {
            confirmButtonText: 'ç»§ç»­ï¼ˆä½¿ç”¨æ–°æ¨¡å‹ï¼‰',
            cancelButtonText: 'æ¢å¤åŸæ¨¡å‹',
            type: 'warning',
            dangerouslyUseHTMLString: true
          }
        )
        return true  // ç”¨æˆ·ç¡®è®¤ï¼Œå…è®¸ç»§ç»­
      } catch {
        // ç”¨æˆ·å–æ¶ˆï¼Œæ¢å¤åŸè®¾ç½®
        validation.warnChanges.forEach(change => {
          currentSettings[change.key] = change.old
        })
        ElMessage.info('å·²æ¢å¤ä¸ºåŸå§‹æ¨¡å‹é…ç½®')
        return false
      }
    }

    if (validation.warningLevel === 'info') {
      // è‡ªç”±ä¿®æ”¹çš„å‚æ•°å˜æ›´ï¼Œå‹å¥½æç¤º
      ElMessage.info(
        `æ£€æµ‹åˆ°å‚æ•°ä¿®æ”¹ï¼š${validation.freeChanges.map(c => c.key).join(', ')}`
      )
      return true
    }

    return true  // æ— å˜æ›´ï¼Œç›´æ¥ç»§ç»­
  }

  return {
    validateResume
  }
}
```

#### **B. SSE æµå¼ç›‘å¬å°è£… (useTranscribeStream)**

åˆ›å»ºä¸€ä¸ª Composable å°è£… SSE è¿æ¥é€»è¾‘ï¼Œè‡ªåŠ¨å¤„ç†é‡è¿ã€é”™è¯¯æ¢å¤ç­‰ã€‚

```javascript
// composables/useTranscribeStream.js

import { ref, onUnmounted } from 'vue'
import { useProjectStore } from '@/stores/projectStore'
import { ElMessage } from 'element-plus'

export function useTranscribeStream() {
  const store = useProjectStore()
  const eventSource = ref(null)
  const isConnected = ref(false)

  /**
   * è¿æ¥SSEæµ
   * @param {string} jobId - ä»»åŠ¡ID
   */
  function connect(jobId) {
    disconnect()  // å…ˆæ–­å¼€æ—§è¿æ¥

    const url = `/api/stream/${jobId}`
    eventSource.value = new EventSource(url)

    eventSource.value.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data)
        handleMessage(data)
      } catch (error) {
        console.error('SSEæ¶ˆæ¯è§£æå¤±è´¥:', error)
      }
    }

    eventSource.value.onerror = (error) => {
      console.error('SSEè¿æ¥é”™è¯¯:', error)
      isConnected.value = false

      // è‡ªåŠ¨é‡è¿é€»è¾‘ï¼ˆå¯é€‰ï¼‰
      setTimeout(() => {
        if (store.task.status === 'transcribing') {
          console.log('SSEé‡è¿ä¸­...')
          connect(jobId)
        }
      }, 5000)
    }

    console.log(`SSEå·²è¿æ¥: ${url}`)
  }

  /**
   * å¤„ç†SSEæ¶ˆæ¯
   */
  function handleMessage(data) {
    switch (data.type) {
      case 'connected':
        isConnected.value = true
        store.task.streaming = true
        console.log('SSEè¿æ¥å·²å»ºç«‹')
        break

      case 'segment':
        // æ–°ç‰‡æ®µè½¬å½•å®Œæˆ - æµå¼è¿½åŠ 
        store.handleStreamEvent(data)
        ElMessage.success({
          message: `å·²è½¬å½• ${data.data.progress.processed}/${data.data.progress.total} æ®µ`,
          duration: 1000,
          showClose: false
        })
        break

      case 'aligned':
        // å¯¹é½å®Œæˆ - æ‰¹é‡æ›´æ–°
        store.handleStreamEvent(data)
        ElMessage.success({
          message: 'âœ… å¯¹é½å®Œæˆï¼å­—å¹•å·²æ›´æ–°',
          duration: 3000
        })
        break

      case 'error':
        console.error('SSEé”™è¯¯äº‹ä»¶:', data.message)
        ElMessage.error(`è½¬å½•é”™è¯¯: ${data.message}`)
        break

      default:
        console.warn('æœªçŸ¥çš„SSEäº‹ä»¶ç±»å‹:', data.type)
    }
  }

  /**
   * æ–­å¼€è¿æ¥
   */
  function disconnect() {
    if (eventSource.value) {
      eventSource.value.close()
      eventSource.value = null
      isConnected.value = false
      console.log('SSEå·²æ–­å¼€')
    }
  }

  // ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ–­å¼€
  onUnmounted(() => {
    disconnect()
  })

  return {
    connect,
    disconnect,
    isConnected
  }
}
```

#### **C. ä½¿ç”¨ç¤ºä¾‹ï¼ˆåœ¨ EditorView ä¸­é›†æˆï¼‰**

```vue
<script setup>
import { ref, onMounted } from 'vue'
import { useProjectStore } from '@/stores/projectStore'
import { useResumeValidation } from '@/composables/useResumeValidation'
import { useTranscribeStream } from '@/composables/useTranscribeStream'

const store = useProjectStore()
const { validateResume } = useResumeValidation()
const { connect, disconnect } = useTranscribeStream()

const currentSettings = ref({
  model: 'medium',
  device: 'cuda',
  word_timestamps: false,
  compute_type: 'float16',
  batch_size: 16
})

/**
 * å¯åŠ¨/æ¢å¤è½¬å½•
 */
async function startTranscription() {
  const jobId = store.meta.jobId

  // 1. å‚æ•°æ ¡éªŒï¼ˆå¦‚æœæœ‰æ–­ç‚¹ï¼‰
  const canProceed = await validateResume(jobId, currentSettings.value)
  if (!canProceed) {
    return  // æ ¡éªŒå¤±è´¥ï¼Œä¸­æ­¢å¯åŠ¨
  }

  // 2. è¿æ¥SSEæµ
  connect(jobId)

  // 3. è°ƒç”¨åç«¯å¯åŠ¨æ¥å£
  try {
    await fetch(`/api/start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        job_id: jobId,
        settings: JSON.stringify(currentSettings.value)
      })
    })

    store.task.status = 'transcribing'
    ElMessage.success('è½¬å½•å·²å¯åŠ¨ï¼')
  } catch (error) {
    ElMessage.error('å¯åŠ¨å¤±è´¥ï¼š' + error.message)
    disconnect()
  }
}
</script>
```

-----

## 5\. å®Œæ•´çš„ç»„ä»¶æ–‡ä»¶ç›®å½•ç»“æ„ (ä¼˜åŒ–ç‰ˆ)

```
src/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ backend-peaks.js    # æ–°å¢ï¼šè·å–æ³¢å½¢å³°å€¼æ•°æ®
â”‚   â””â”€â”€ ...
â”œâ”€â”€ assets/
â”‚   â””â”€â”€ styles/
â”‚       â”œâ”€â”€ _variables.scss # å®šä¹‰é¢œè‰²å˜é‡ã€æš—é»‘æ¨¡å¼å˜é‡
â”‚       â”œâ”€â”€ _mixins.scss    # å“åº”å¼æ–­ç‚¹æ··åˆå®
â”‚       â””â”€â”€ main.scss       # å…¨å±€å…¥å£
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ editor/
â”‚   â”‚   â”œâ”€â”€ VideoStage/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.vue   # è§†å£å®¹å™¨
â”‚   â”‚   â”‚   â””â”€â”€ OverlayLayer.vue # å­—å¹•è¦†ç›–å±‚ (æŠ½ç¦»å‡ºæ¥ä»¥å¤ç”¨)
â”‚   â”‚   â”œâ”€â”€ Timeline/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.vue   # æ³¢å½¢å®¹å™¨
â”‚   â”‚   â”‚   â””â”€â”€ WaveformMap.vue # (å¯é€‰) è¿·ä½ å¯¼èˆªå›¾
â”‚   â”‚   â”œâ”€â”€ ScriptEditor/
â”‚   â”‚   â”‚   â”œâ”€â”€ ListMode.vue
â”‚   â”‚   â”‚   â””â”€â”€ DocumentMode.vue
â”‚   â”‚   â””â”€â”€ Controls/
â”‚   â”‚       â”œâ”€â”€ PlaybackBar.vue # å«è‡ªå®šä¹‰å€é€Ÿ
â”‚   â”‚       â””â”€â”€ TimeDisplay.vue
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ ThemeSwitch.vue # ä¸»é¢˜åˆ‡æ¢å™¨
â”‚   â”‚   â””â”€â”€ ErrorBoundary.vue # é”™è¯¯è¾¹ç•Œç»„ä»¶ (Vue 3)
â”œâ”€â”€ composables/
â”‚   â”œâ”€â”€ useTheme.js         # ç®¡ç†æ·±è‰²/æµ…è‰²æ¨¡å¼
â”‚   â”œâ”€â”€ useWaveform.js      # å°è£… wavesurfer å¤æ‚é€»è¾‘
â”‚   â”œâ”€â”€ useAutoSave.js      # è‡ªåŠ¨ä¿å­˜é€»è¾‘
â”‚   â”œâ”€â”€ useTranscribeStream.js  # æ–°å¢ï¼šSSEæµå¼è¿æ¥å°è£…
â”‚   â””â”€â”€ useResumeValidation.js  # æ–°å¢ï¼šæ–­ç‚¹æ¢å¤æ ¡éªŒé€»è¾‘
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ projectStore.js     # æ–°å¢ï¼šé¡¹ç›®æ ¸å¿ƒæ•°æ®ç®¡ç†
â”‚   â””â”€â”€ modelStore.js       # å·²å­˜åœ¨ï¼šæ¨¡å‹ç®¡ç†
â”œâ”€â”€ workers/
â”‚   â””â”€â”€ subtitle-merge.worker.js  # æ–°å¢ï¼šå­—å¹•åˆå¹¶Web Worker
â””â”€â”€ views/
    â””â”€â”€ ...
```

-----

## 6\. å¼€å‘è·¯çº¿å›¾ (Revised)

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½ä¸åŸå‹ (MVP)

1.  æ­å»º Vite + Vue 3 + Pinia + SCSS è„šæ‰‹æ¶ã€‚
2.  é…ç½® `useDark` å®ç°åŸºæœ¬çš„æ·±è‰²æ¨¡å¼åˆ‡æ¢ã€‚
3.  å®ç°åç«¯ `/peaks` æ¥å£ï¼ˆPython ç«¯ï¼‰ï¼Œç¡®ä¿å¤§æ–‡ä»¶æ³¢å½¢ç§’å¼€ã€‚

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒç¼–è¾‘å™¨ (Core)

1.  å®ç° `VideoStage` ä¸ `SubtitleList` çš„åŸºç¡€è”åŠ¨ï¼ˆç‚¹å‡»è·³è½¬ï¼‰ã€‚
2.  é›†æˆ `wavesurfer.js`ï¼Œå®ç°**åç«¯ Peaks æ•°æ®åŠ è½½**ã€‚
3.  å®ç°**åŒå‘ç»‘å®š**ï¼šRegion æ‹–æ‹½ \<-\> Store æ•°æ®æ›´æ–°ã€‚

### ç¬¬ä¸‰é˜¶æ®µï¼šä½“éªŒå¢å¼º (Polish)

1.  **å“åº”å¼é€‚é…**ï¼šè°ƒè¯• Tablet å°ºå¯¸ä¸‹çš„å¸ƒå±€æŠ˜å é€»è¾‘ã€‚
2.  **è‡ªå®šä¹‰å€é€Ÿ**ï¼šå®ç° `input[type=number]` æ§åˆ¶ `playbackRate`ã€‚
3.  **é²æ£’æ€§å»ºè®¾**ï¼šæ·»åŠ è‡ªåŠ¨ä¿å­˜å’Œé”™è¯¯æ‹¦æˆªã€‚

è¿™ä»½ç»ˆæç‰ˆæ–‡æ¡£ä¸ä»…æ¶µç›–äº†ç•Œé¢è®¾è®¡ï¼Œæ›´æ·±å…¥åˆ°äº†**å¤§æ–‡ä»¶æ€§èƒ½ä¼˜åŒ–**ã€**æ ·å¼å·¥ç¨‹åŒ–**å’Œ**å¼‚å¸¸å…œåº•**ç­‰ç”Ÿäº§ç¯å¢ƒå¿…é¡»è€ƒè™‘çš„ç»†èŠ‚ï¼Œæ˜¯ä¸€ä¸ªæˆç†Ÿè½¯ä»¶äº§å“çš„å¼€å‘è“å›¾ã€‚

-----

## 7\. æ ¸å¿ƒç®—æ³•å®ç°ï¼šWeb Worker å¤šçº¿ç¨‹åˆå¹¶

### 7.1 æ–°å¢æ–‡ä»¶ï¼š`src/workers/subtitle-merge.worker.js`

ä¸ºäº†é¿å…åœ¨åˆå¹¶å‡ åƒæ¡å­—å¹•æ—¶é˜»å¡ä¸»çº¿ç¨‹ï¼ˆå¯¼è‡´ç•Œé¢å¡é¡¿ï¼‰ï¼Œæˆ‘ä»¬å°†"æ™ºèƒ½åˆå¹¶"é€»è¾‘æ”¾å…¥åå°çº¿ç¨‹ã€‚

```javascript
// src/workers/subtitle-merge.worker.js

/**
 * å­—å¹•åˆå¹¶ Web Worker
 * å¤„ç†å¤§é‡å­—å¹•æ•°æ®çš„å¯¹é½åˆå¹¶æ“ä½œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
 */
self.onmessage = (e) => {
  const { currentSubtitles, alignedSegments } = e.data;

  try {
    // åˆ›å»ºä¸€ä¸ª Map ä»¥ä¾¿å¿«é€ŸæŸ¥æ‰¾ (O(1) å¤æ‚åº¦)
    const alignedMap = new Map(alignedSegments.map(s => [s.id, s]));

    const merged = currentSubtitles.map(item => {
      // å°è¯•åœ¨å¯¹é½ç»“æœä¸­æ‰¾åˆ°å¯¹åº” ID çš„ç‰‡æ®µ
      const aligned = alignedMap.get(item.id);

      if (!aligned) return item;

      // æ ¸å¿ƒé€»è¾‘ï¼šç”¨æˆ·æ”¹è¿‡çš„(Dirty)ï¼Œä¿ç•™æ–‡å­—åªæ”¹æ—¶é—´ï¼›æ²¡æ”¹è¿‡çš„ï¼Œå…¨è¦†ç›–
      if (item.isDirty) {
        return {
          ...item,
          start: aligned.start,
          end: aligned.end,
          status: 'confirmed'
          // text: item.text (ä¿ç•™ç”¨æˆ·ä¿®æ”¹)
        };
      } else {
        return {
          ...item,
          start: aligned.start,
          end: aligned.end,
          text: aligned.text,
          status: 'confirmed'
        };
      }
    });

    // è¿”å›åˆå¹¶ç»“æœ
    self.postMessage(merged);
  } catch (error) {
    // å‘é€é”™è¯¯ä¿¡æ¯
    self.postMessage({ error: error.message });
  }
};
```

### 7.2 æ›´æ–° Store é€»è¾‘ï¼šé›†æˆ Web Worker

åœ¨ `stores/projectStore.js` ä¸­ä¿®æ”¹ `mergeAlignedSubtitles` actionï¼Œé›†æˆ Web Worker å¤„ç†é€»è¾‘ï¼š

```javascript
// stores/projectStore.js

import { defineStore } from 'pinia';

export const useProjectStore = defineStore('project', {
  state: () => ({
    // ...(ä¿æŒå‰é¢æ–‡æ¡£ä¸­å®šä¹‰çš„å®Œæ•´stateç»“æ„)
    meta: { /* ... */ },
    task: { /* ... */ },
    subtitles: [],
    player: { /* ... */ },
    view: { /* ... */ }
  }),

  actions: {
    // ...(ä¿æŒå…¶ä»–actions)

    /**
     * SSEæµå¼æ•°æ®æ¥æ”¶ Actionï¼ˆæ›´æ–°ç‰ˆï¼‰
     * å¤„ç†ä»åç«¯æ¨é€è¿‡æ¥çš„ 'segment' (æœªå¯¹é½) å’Œ 'aligned' (å·²å¯¹é½) äº‹ä»¶
     */
    handleStreamEvent(event) {
      if (event.type === 'segment') {
        // æµå¼è¿½åŠ ï¼šç›´æ¥åœ¨ä¸»çº¿ç¨‹æ“ä½œï¼ˆé‡å°ï¼Œä¸å¡ï¼‰
        const newSegments = event.data.segments.map(seg => ({
          ...seg,
          status: 'draft',
          isDirty: false
        }));
        this.subtitles.push(...newSegments);

        // æ›´æ–°è¿›åº¦æ¡
        this.task.progress = event.data.progress.percentage;
        this.task.currentSegment = event.data.progress.processed;
        this.task.totalSegments = event.data.progress.total;
      }
      else if (event.type === 'aligned') {
        // å¯¹é½å®Œæˆï¼šæ•°æ®é‡å¤§ï¼Œäº¤ç»™ Worker å¤„ç†
        this.mergeAlignedSubtitles(event.data.segments);
      }
      else if (event.type === 'connected') {
        this.task.streaming = true;
      }
    },

    /**
     * ä½¿ç”¨ Web Worker è¿›è¡Œæ™ºèƒ½åˆå¹¶
     * "ä¸€æ­¥åˆ°ä½"çš„ç”Ÿäº§çº§å†™æ³•
     */
    async mergeAlignedSubtitles(alignedSegments) {
      this.task.status = 'aligning';

      try {
        // åŠ¨æ€åˆ›å»º Worker å®ä¾‹ï¼ˆä½¿ç”¨ Blob æ–¹å¼ï¼Œé¿å…è·¯å¾„é—®é¢˜ï¼‰
        const workerCode = `
          self.onmessage = (e) => {
            const { currentSubtitles, alignedSegments } = e.data;
            try {
              const alignedMap = new Map(alignedSegments.map(s => [s.id, s]));
              const merged = currentSubtitles.map(item => {
                const aligned = alignedMap.get(item.id);
                if (!aligned) return item;
                if (item.isDirty) {
                  return {
                    ...item,
                    start: aligned.start,
                    end: aligned.end,
                    status: 'confirmed'
                  };
                } else {
                  return {
                    ...item,
                    start: aligned.start,
                    end: aligned.end,
                    text: aligned.text,
                    status: 'confirmed'
                  };
                }
              });
              self.postMessage(merged);
            } catch (error) {
              self.postMessage({ error: error.message });
            }
          };
        `;

        const workerBlob = new Blob([workerCode], { type: 'application/javascript' });
        const worker = new Worker(URL.createObjectURL(workerBlob));

        // å‘é€æ•°æ®ç»™ Worker (åå°çº¿ç¨‹)
        const mergedResult = await new Promise((resolve, reject) => {
          worker.postMessage({
            // å¿…é¡»ä¼ é€’çº¯æ•°æ®å¯¹è±¡ (åºåˆ—åŒ– Pinia çš„å“åº”å¼å¯¹è±¡)
            currentSubtitles: JSON.parse(JSON.stringify(this.subtitles)),
            alignedSegments: alignedSegments
          });

          worker.onmessage = (e) => {
            if (e.data.error) {
              reject(new Error(e.data.error));
            } else {
              resolve(e.data);
            }
          };

          worker.onerror = (err) => reject(err);
        });

        // æ¥æ”¶ç»“æœï¼Œæ›´æ–°çŠ¶æ€
        this.subtitles = mergedResult;
        this.task.phase = 'align';
        this.task.status = 'finished';

        // ä»»åŠ¡å®Œæˆï¼Œé”€æ¯çº¿ç¨‹
        worker.terminate();
        URL.revokeObjectURL(workerBlob);

      } catch (error) {
        console.error("Workeråˆå¹¶å¤±è´¥ï¼Œå›é€€åˆ°ä¸»çº¿ç¨‹åˆå¹¶:", error);
        // å…œåº•ï¼šä¸»çº¿ç¨‹åŒæ­¥åˆå¹¶
        this.subtitles = this.subtitles.map(item => {
          const aligned = alignedSegments.find(a => a.id === item.id);
          if (!aligned) return item;

          if (item.isDirty) {
            return {
              ...item,
              start: aligned.start,
              end: aligned.end,
              status: 'confirmed'
            };
          } else {
            return {
              ...item,
              start: aligned.start,
              end: aligned.end,
              text: aligned.text,
              status: 'confirmed'
            };
          }
        });
        this.task.phase = 'align';
        this.task.status = 'finished';
      }
    }

    // ...(ä¿æŒ loadCheckpointã€validateSettingsChange ç­‰å…¶ä»–æ–¹æ³•)
  }
});
```

### 7.3 æ–°å¢ SSE è¿æ¥ Composable

åˆ›å»º `composables/useTranscribeStream.js` ç”¨äºå°è£… SSE è¿æ¥é€»è¾‘ï¼š

```javascript
// composables/useTranscribeStream.js

import { ref, onUnmounted } from 'vue';
import { useProjectStore } from '@/stores/projectStore';
import { ElMessage } from 'element-plus';

/**
 * SSEæµå¼è½¬å½•ç›‘å¬ Composable
 * è‡ªåŠ¨å¤„ç†é‡è¿ã€é”™è¯¯æ¢å¤ç­‰
 */
export function useTranscribeStream() {
  const store = useProjectStore();
  const eventSource = ref(null);
  const isConnected = ref(false);

  /**
   * è¿æ¥SSEæµ
   * @param {string} jobId - ä»»åŠ¡ID
   */
  function connect(jobId) {
    disconnect();  // å…ˆæ–­å¼€æ—§è¿æ¥

    const url = `/api/stream/${jobId}`;
    eventSource.value = new EventSource(url);

    eventSource.value.onopen = () => {
      console.log(`[SSE] è¿æ¥å·²å»ºç«‹: ${url}`);
      isConnected.value = true;
    };

    eventSource.value.onmessage = (event) => {
      // å¿ƒè·³æ£€æµ‹
      if (event.data === 'heartbeat') return;

      try {
        const payload = JSON.parse(event.data);
        // åˆ†å‘ç»™ Store å¤„ç†
        handleMessage(payload);
      } catch (err) {
        console.error('[SSE] æ¶ˆæ¯è§£æå¤±è´¥:', err);
      }
    };

    eventSource.value.onerror = (error) => {
      console.error('[SSE] è¿æ¥é”™è¯¯:', error);
      isConnected.value = false;

      // ç®€å•çš„é‡è¿é€»è¾‘ï¼ˆå¯é€‰ï¼‰
      // EventSource ä¼šè‡ªåŠ¨é‡è¿ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„é”™è¯¯å¤„ç†
    };
  }

  /**
   * å¤„ç†SSEæ¶ˆæ¯
   */
  function handleMessage(data) {
    switch (data.type) {
      case 'connected':
        isConnected.value = true;
        store.task.streaming = true;
        console.log('[SSE] è¿æ¥ç¡®è®¤');
        break;

      case 'segment':
        // æ–°ç‰‡æ®µè½¬å½•å®Œæˆ - æµå¼è¿½åŠ 
        store.handleStreamEvent(data);
        ElMessage({
          message: `å·²è½¬å½• ${data.data.progress.processed}/${data.data.progress.total} æ®µ`,
          type: 'success',
          duration: 1000,
          showClose: false
        });
        break;

      case 'aligned':
        // å¯¹é½å®Œæˆ - æ‰¹é‡æ›´æ–°
        store.handleStreamEvent(data);
        ElMessage({
          message: 'âœ… å¯¹é½å®Œæˆï¼å­—å¹•å·²æ›´æ–°',
          type: 'success',
          duration: 3000
        });
        break;

      case 'error':
        console.error('[SSE] é”™è¯¯äº‹ä»¶:', data.message);
        ElMessage.error(`è½¬å½•é”™è¯¯: ${data.message}`);
        break;

      default:
        console.warn('[SSE] æœªçŸ¥äº‹ä»¶ç±»å‹:', data.type);
    }
  }

  /**
   * æ–­å¼€è¿æ¥
   */
  function disconnect() {
    if (eventSource.value) {
      eventSource.value.close();
      eventSource.value = null;
      isConnected.value = false;
      console.log('[SSE] å·²æ–­å¼€');
    }
  }

  // ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ–­å¼€
  onUnmounted(() => {
    disconnect();
  });

  return {
    connect,
    disconnect,
    isConnected
  };
}
```

### 7.4 æ–°å¢æ–­ç‚¹æ¢å¤æ ¡éªŒ Composable

åˆ›å»º `composables/useResumeValidation.js` å¤„ç†æ¢å¤ä»»åŠ¡æ—¶çš„å‚æ•°å†²çªï¼š

```javascript
// composables/useResumeValidation.js

import { ElMessageBox, ElMessage } from 'element-plus';
import { useProjectStore } from '@/stores/projectStore';

/**
 * æ–­ç‚¹ç»­ä¼ å‚æ•°æ ¡éªŒ Composable
 * è´Ÿè´£å¤„ç†æ¢å¤ä»»åŠ¡æ—¶çš„å‚æ•°å†²çªï¼ˆåŒ…å« UI äº¤äº’ï¼‰
 */
export function useResumeValidation() {
  const store = useProjectStore();

  /**
   * æ ¡éªŒå¹¶æ¢å¤å‚æ•°
   * @param {string} jobId - ä»»åŠ¡ID
   * @param {Object} currentSettings - å½“å‰UIé¢æ¿çš„è®¾ç½®
   * @returns {Promise<boolean>} - æ˜¯å¦å…è®¸ç»§ç»­ï¼ˆfalseè¡¨ç¤ºéœ€è¦ç”¨æˆ·é‡æ–°ç¡®è®¤ï¼‰
   */
  async function validateAndRestore(jobId, currentSettings) {
    // 1. è·å–åç«¯ Checkpoint æ•°æ®
    const checkpoint = await store.loadCheckpoint(jobId);
    if (!checkpoint || !checkpoint.has_checkpoint) {
      return true; // æ— æ–­ç‚¹ï¼Œç›´æ¥ç»§ç»­
    }

    // 2. æ ¡éªŒé€»è¾‘
    const result = store.validateSettingsChange(
      currentSettings,
      checkpoint.original_settings
    );

    // 3. å¤„ç†çº¢çº¿å‚æ•° (Immutable)
    if (result.warningLevel === 'error') {
      await ElMessageBox.alert(
        'æ£€æµ‹åˆ°å…³é”®å‚æ•°ï¼ˆè®¾å¤‡/æ—¶é—´æˆ³æ ¼å¼ï¼‰å˜æ›´ï¼Œå°†å¼ºåˆ¶æ¢å¤ä¸ºåŸè®¾ç½®ä»¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚\n\n' +
        result.immutableChanges.map(c =>
          `â€¢ ${c.key}: ${c.new} â†’ ${c.old}`
        ).join('\n'),
        'å‚æ•°å†²çª',
        {
          type: 'error',
          confirmButtonText: 'ç¡®å®š'
        }
      );

      // å¼ºåˆ¶è¦†ç›–ä¸ºåŸå€¼
      result.immutableChanges.forEach(change => {
        currentSettings[change.key] = change.old;
      });
      return false; // æŒ‡ç¤ºè°ƒç”¨æ–¹åˆ·æ–° UI
    }

    // 4. å¤„ç†é»„çº¿å‚æ•° (Warning)
    if (result.warningLevel === 'warning') {
      try {
        await ElMessageBox.confirm(
          'âš ï¸ æ£€æµ‹åˆ°æ¨¡å‹å‚æ•°å·²ä¿®æ”¹ï¼š\n\n' +
          result.warnChanges.map(c =>
            `â€¢ ${c.key}: ${c.old} â†’ ${c.new}`
          ).join('\n') +
          '\n\nä¿®æ”¹æ¨¡å‹ä¼šå¯¼è‡´å‰åå­—å¹•è´¨é‡ä¸ä¸€è‡´ï¼\n' +
          'é€‚ç”¨åœºæ™¯ï¼šå‘ç°ç”¨é”™äº†æ¨¡å‹éœ€è¦ä¸­é€”æ›´æ­£ã€‚\n\n' +
          'æ˜¯å¦ç»§ç»­ä½¿ç”¨æ–°æ¨¡å‹ï¼Ÿ',
          'ä¸¥é‡è­¦å‘Š',
          {
            confirmButtonText: 'ç»§ç»­ï¼ˆä½¿ç”¨æ–°æ¨¡å‹ï¼‰',
            cancelButtonText: 'æ¢å¤åŸæ¨¡å‹',
            type: 'warning',
            dangerouslyUseHTMLString: false
          }
        );
        return true; // ç”¨æˆ·ç¡®è®¤ï¼Œå…è®¸ç»§ç»­
      } catch {
        // ç”¨æˆ·å–æ¶ˆï¼Œæ¢å¤åŸè®¾ç½®
        result.warnChanges.forEach(change => {
          currentSettings[change.key] = change.old;
        });
        ElMessage.info('å·²æ¢å¤ä¸ºåŸå§‹æ¨¡å‹é…ç½®');
        return false;
      }
    }

    // 5. å¤„ç†ç»¿çº¿å‚æ•° (Info)
    if (result.warningLevel === 'info') {
      ElMessage.info(
        `æ£€æµ‹åˆ°å‚æ•°ä¿®æ”¹ï¼š${result.freeChanges.map(c => c.key).join(', ')}`
      );
      return true;
    }

    return true; // æ— å˜æ›´ï¼Œç›´æ¥ç»§ç»­
  }

  return {
    validateAndRestore
  };
}
```

### 7.5 åœ¨ EditorView ä¸­é›†æˆä½¿ç”¨ç¤ºä¾‹

```vue
<script setup>
import { ref, onMounted } from 'vue';
import { useProjectStore } from '@/stores/projectStore';
import { useResumeValidation } from '@/composables/useResumeValidation';
import { useTranscribeStream } from '@/composables/useTranscribeStream';
import { ElMessage } from 'element-plus';

const store = useProjectStore();
const { validateAndRestore } = useResumeValidation();
const { connect, disconnect } = useTranscribeStream();

const currentSettings = ref({
  model: 'medium',
  device: 'cuda',
  word_timestamps: false,
  compute_type: 'float16',
  batch_size: 16,
  cpu_affinity_enabled: false,
  cpu_affinity_strategy: 'auto'
});

/**
 * å¯åŠ¨/æ¢å¤è½¬å½•
 */
async function startTranscription() {
  const jobId = store.meta.jobId;

  // 1. å‚æ•°æ ¡éªŒï¼ˆå¦‚æœæœ‰æ–­ç‚¹ï¼‰
  const canProceed = await validateAndRestore(jobId, currentSettings.value);
  if (!canProceed) {
    return; // æ ¡éªŒå¤±è´¥ï¼Œä¸­æ­¢å¯åŠ¨
  }

  // 2. è¿æ¥SSEæµ
  connect(jobId);

  // 3. è°ƒç”¨åç«¯å¯åŠ¨æ¥å£
  try {
    const response = await fetch('/api/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        job_id: jobId,
        settings: currentSettings.value
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    store.task.status = 'transcribing';
    ElMessage.success('è½¬å½•å·²å¯åŠ¨ï¼');
  } catch (error) {
    ElMessage.error('å¯åŠ¨å¤±è´¥ï¼š' + error.message);
    disconnect();
  }
}

/**
 * æš‚åœè½¬å½•
 */
async function pauseTranscription() {
  try {
    await fetch(`/api/pause/${store.meta.jobId}`, { method: 'POST' });
    store.task.status = 'paused';
    disconnect();
    ElMessage.info('ä»»åŠ¡å·²æš‚åœ');
  } catch (error) {
    ElMessage.error('æš‚åœå¤±è´¥ï¼š' + error.message);
  }
}

onMounted(() => {
  // å¦‚æœæœ‰æ–­ç‚¹ï¼Œå¯ä»¥åœ¨æ­¤å¤„æç¤ºç”¨æˆ·
  if (store.task.hasCheckpoint) {
    ElMessage({
      message: `æ£€æµ‹åˆ°æœªå®Œæˆçš„ä»»åŠ¡ (${store.task.progress.toFixed(1)}%)ï¼Œç‚¹å‡»"ç»§ç»­"å¯æ¢å¤`,
      type: 'info',
      duration: 5000
    });
  }
});
</script>

<template>
  <div class="editor-view">
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
      <el-button
        v-if="store.task.status === 'idle' || store.task.status === 'paused'"
        type="primary"
        @click="startTranscription"
      >
        {{ store.task.hasCheckpoint ? 'ç»§ç»­è½¬å½•' : 'å¼€å§‹è½¬å½•' }}
      </el-button>
      <el-button
        v-if="store.task.status === 'transcribing'"
        @click="pauseTranscription"
      >
        æš‚åœ
      </el-button>
    </div>

    <!-- å…¶ä»–ç»„ä»¶... -->
  </div>
</template>
```

-----

## 8\. æ€»ç»“ï¼šç”Ÿäº§çº§ç‰¹æ€§æ¸…å•

å®Œæˆä»¥ä¸Šä¿®æ”¹åï¼Œä½ çš„å‰ç«¯å°†å…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š

1. **èŒè´£åˆ†ç¦»**ï¼šåç«¯æ–‡æ¡£ç®¡ APIï¼Œå‰ç«¯æ–‡æ¡£ç®¡å®ç°ï¼Œè¾¹ç•Œæ¸…æ™°ã€‚

2. **æ€§èƒ½æ— å¿§**ï¼š
   - é€šè¿‡ **Web Worker** å¤„ç†å¤§é‡å­—å¹•åˆå¹¶ï¼Œå³ä½¿å¯¹é½ 2 å°æ—¶ç”µå½±å­—å¹•ï¼Œç•Œé¢ä¹Ÿä¸ä¼šå¡é¡¿ã€‚
   - ä½¿ç”¨ Map æ•°æ®ç»“æ„ä¼˜åŒ–æŸ¥æ‰¾æ€§èƒ½ï¼ˆO(1) å¤æ‚åº¦ï¼‰ã€‚

3. **é€»è¾‘é—­ç¯**ï¼š
   - SSE ç›‘å¬ â†’ çŠ¶æ€æ›´æ–° â†’ Worker å¤„ç† â†’ ç•Œé¢æ¸²æŸ“ï¼Œå®Œæ•´çš„æ•°æ®æµã€‚
   - å‚æ•°æ ¡éªŒ â†’ æ–­ç‚¹æ¢å¤ â†’ æµå¼è¿½åŠ  â†’ æ™ºèƒ½åˆå¹¶ï¼Œå®Œæ•´çš„ä¸šåŠ¡æµç¨‹ã€‚

4. **é”™è¯¯å…œåº•**ï¼š
   - Worker å¤±è´¥è‡ªåŠ¨å›é€€åˆ°ä¸»çº¿ç¨‹å¤„ç†ã€‚
   - SSE è¿æ¥é”™è¯¯è‡ªåŠ¨é‡è¿ï¼ˆEventSource å†…ç½®æœºåˆ¶ï¼‰ã€‚

5. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - å‚æ•°å†²çªæ—¶çš„ä¸‰çº§è­¦å‘Šï¼ˆçº¢/é»„/ç»¿çº¿ï¼‰ã€‚
   - å®æ—¶è¿›åº¦æç¤ºå’Œå®Œæˆé€šçŸ¥ã€‚
   - æ–­ç‚¹ç»­ä¼ æ— ç¼è¡”æ¥ã€‚

6. **ä»£ç è´¨é‡**ï¼š
   - æ‰€æœ‰è·¯å¾„ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆ`@/stores/...`ï¼‰ï¼Œç¬¦åˆé¡¹ç›®è¦æ±‚ã€‚
   - ä½¿ç”¨ Blob URL åˆ›å»º Workerï¼Œé¿å…å¤–éƒ¨æ–‡ä»¶è·¯å¾„é—®é¢˜ã€‚
   - å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•ã€‚

**ä¸‹ä¸€æ­¥å»ºè®®**ï¼š
- æ ¹æ®æœ¬æ–‡æ¡£åˆ›å»º `composables/useTranscribeStream.js` å’Œ `useResumeValidation.js` æ–‡ä»¶ã€‚
- å¦‚éœ€ç‹¬ç«‹çš„ Worker æ–‡ä»¶ï¼Œåˆ›å»º `workers/subtitle-merge.worker.js`ï¼ˆå¯é€‰ï¼Œå½“å‰å®ç°å·²ä½¿ç”¨ Blob æ–¹å¼ï¼‰ã€‚
- åœ¨å®é™…ç»„ä»¶ä¸­é›†æˆå¹¶æµ‹è¯• SSE æµå¼æ›´æ–°å’Œæ–­ç‚¹æ¢å¤åŠŸèƒ½ã€‚