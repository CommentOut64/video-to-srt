# SenseVoice 集成开发计划 - 架构优化补充文档

> **核心变更摘要**：
> 本补充文档确立了 **"SenseVoice 为时间轴基准，Whisper/LLM 为内容修正者"** 的时空解耦架构。移除了强制对齐的硬性依赖，引入了模块化的处理流矩阵，并重点优化了 LLM 稀疏校对的上下文策略。

-----

## 一、 核心架构重构：时空解耦 (Time-Space Decoupling)

我们将音频处理管线中的“时间”与“内容”职责分离，以解决多模型对齐带来的复杂度和割裂感。

### 1.1 角色定义

  * **SenseVoice (时间领主 / Timeline Truth)**：
      * **职责**：提供绝对的时间轴基准（Start/End）、基础文本和字级置信度。
      * **地位**：所有后续步骤严禁修改由 SenseVoice 确定的句段起止时间（Start/End），仅允许在时间段内部进行文本替换。
  * **Whisper (听觉补丁 / Acoustic Patch)**：
      * **职责**：针对低置信度片段进行二次“精听”。
      * **地位**：仅提供文本内容，**弃用**其时间戳。
  * **LLM (逻辑胶水 / Semantic Refiner)**：
      * **职责**：基于上下文进行错别字修正、歧义仲裁（SenseVoice vs Whisper）及翻译。
      * **地位**：最终文本的裁决者。

### 1.2 关键决策

1.  **废弃强制对齐**：不再要求 Whisper 补刀后必须进行强制对齐。
2.  **伪对齐（Pseudo-Alignment）算法**：当 Whisper 或 LLM 替换文本后，采用 **“线性时间平摊”** 策略，将新文本的字符均匀分布在 SenseVoice 划定的时间窗口内，生成伪造的字级时间戳（用于维持数据结构完整性）。
3.  **前端渲染优化**：鉴于字级置信度数据量虽小但 DOM 节点极多，前端必须实现 **虚拟滚动 (Virtual Scrolling)** 策略，仅渲染视口内的字级 `<span>` 节点，防止长视频导致页面卡顿。

-----

## 二、 优化的工作流逻辑

### 2.1 整体 Pipeline

1.  **SenseVoice 全量扫描**：生成基础字幕列表 `Base_Subtitle_List`（含字级时间戳、置信度）。
2.  **目标筛选 (Targeting)**：遍历列表，标记 `avg_confidence < 阈值` 的句段索引。
3.  **听觉增强 (可选)**：对标记片段调用 Whisper 转录（仅取文本）。
4.  **语义增强 (可选)**：
      * **稀疏模式**：打包“标记片段 + 上下文”发送给 LLM。
      * **全量模式**：滑动窗口发送全文给 LLM。
5.  **回填与渲染**：
      * LLM/Whisper 结果替换原文本。
      * 执行“线性时间平摊”生成新时间戳。
      * 前端根据最终置信度渲染（修正后的片段置信度视为 1.0 或特定颜色）。

### 2.2 LLM 稀疏校对策略 (Context-Aware Sparse Correction)

为防止“只传一句导致 LLM 瞎改”，必须采用 **“三明治” Prompt 结构**。

  * **输入结构**：`[前2句 Context] + <target>待修补低置信度句</target> + [后2句 Context]`
  * **Prompt 核心指令**：
    > “请基于上下文逻辑，仅修正 \<target\> 标签内的文本。如果提供了参考文本（Whisper 结果），请对比选择更准确的一个。保持原句意，修正错别字。”

-----

## 三、 组合方案矩阵 (Solution Matrix)

系统将提供高度模块化的配置，允许用户在“速度、成本、质量”之间自由组合。系统应在后台自动匹配以下方案，而非将复杂选项直接暴露给用户。

### 3.1 基础层 (Base Layer)

| 方案 ID | 流程描述 | 适用场景 | 备注 |
| :--- | :--- | :--- | :--- |
| **A1** | **SenseVoice Only** | 实时预览、即时日志 | **极速**。原汁原味，依靠前端标红提示错误。 |

### 3.2 听觉增强层 (Acoustic Layer) - “补刀”

| 方案 ID | 流程描述 | 适用场景 | 备注 |
| :--- | :--- | :--- | :--- |
| **B1** | SV + **Whisper Partial** | 嘈杂、多 BGM 环境 | **默认推荐**。仅对低置信度片段进行 Whisper 重听，平摊时间戳。 |
| **B2** | SV + Whisper Partial + **强制对齐** | 极高精度时间轴需求 | **高成本**。补刀后强制对齐，防止线性平摊导致的微小音画不同步。 |
| **C1** | SV + **Whisper Full** | 对比测试 / 极低质量音频 | **重制**。实际上是用 SV 做 VAD，Whisper 跑全文。 |

### 3.3 语义增强层 (Semantic Layer) - “校对”

*(可叠加在 A 或 B 类方案之上)*

| 方案 ID | 流程描述 | 适用场景 | 备注 |
| :--- | :--- | :--- | :--- |
| **P1** | ... + **LLM Partial Proof** | 个人笔记、日常 Vlog | **性价比之王**。按需稀疏校对，节省 90%+ Token。 |
| **P2** | ... + **LLM Full Proof** | 正式出版、文稿整理 | **高质量**。全量滑动窗口，润色口语、修正逻辑。 |

### 3.4 翻译层 (Translation Layer)

*(必须在校对之后执行)*

| 方案 ID | 流程描述 | 适用场景 | 备注 |
| :--- | :--- | :--- | :--- |
| **T1** | ... + **LLM Full Trans** | 跨语言内容 | 传统的全量翻译。 |
| **T2** | ... + **LLM Partial Trans** | 教学重点标注 | 仅翻译用户指定的重点段落。 |

-----

## 四、 推荐配置 (Best Practices)

在 UI 设计中，建议简化为三个维度的选择器：

1.  **增强模式 (Enhancement)**：

      * `关闭` (A1)
      * `智能补刀 (推荐)` (B1 - Whisper Partial)
      * `深度重听` (C1 - Whisper Full)

2.  **AI 校对 (Proofread)**：

      * `关闭`
      * `按需修复 (推荐)` (P1 - Sparse LLM)
      * `全文精修` (P2 - Full LLM)

3.  **翻译 (Translate)**：

      * `无`
      * `目标语言...` (T1)

**黄金组合 (Golden Standard)**：

> **[智能补刀] + [按需修复]**
> 即：`SenseVoice` + `Whisper(Partial)` + `LLM(Partial Context-Aware)`
>
> **理由**：这是目前技术条件下，能够兼顾 **秒级出图**（大部分由 SV 完成）、**高鲁棒性**（Whisper 兜底噪音）和 **逻辑通顺**（LLM 兜底语义）的最佳平衡点。

-----

## 五、 技术实现细节补充

### 5.1 伪对齐算法 (Pseudo-Alignment)

```python
def apply_pseudo_alignment(
    original_start: float,
    original_end: float,
    new_text: str
) -> List[WordTimestamp]:
    """
    将新文本均匀映射到原时间段内
    """
    duration = original_end - original_start
    char_count = len(new_text)
    
    if char_count == 0:
        return []
    
    step = duration / char_count
    result = []
    
    for i, char in enumerate(new_text):
        w_start = original_start + (i * step)
        w_end = w_start + step
        result.append(WordTimestamp(
            word=char,
            start=w_start,
            end=w_end,
            confidence=1.0  # 修正后的默认为满置信度
        ))
        
    return result
```

### 5.2 兼容性调整

  * **Subtitle Object**：需扩充字段以追踪修改来源。
    ```python
    class SentenceSegment:
        # ... 原有字段
        source: str = "sensevoice"  # 'sensevoice', 'whisper_patch', 'llm_correction'
        is_modified: bool = False
    ```

此文档旨在指导 Phase 3 及后续 LLM 集成阶段的具体开发工作。