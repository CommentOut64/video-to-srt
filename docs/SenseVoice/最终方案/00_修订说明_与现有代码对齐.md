# 修订说明：与现有代码对齐

> 检查发现部分设计与现有代码重复或不兼容，需要修订

---

## 一、核心发现

### 1. ✅ 硬件检测服务（已存在）

**现有代码**：
- `backend/app/services/hardware_service.py` - `CoreHardwareDetector`
- `backend/app/models/hardware_models.py` - `HardwareInfo`, `OptimizationConfig`
- `backend/app/api/routes/hardware_routes.py` - API 端点

**功能**：
- GPU/CPU/内存/存储检测
- 硬件优化配置生成
- 单例模式：`get_hardware_detector()`

**修订方案**：
- ❌ **删除** Phase 1 中的 `hardware_detector.py`
- ✅ **直接使用**现有的 `hardware_service.py`
- ✅ **扩展**现有的 `OptimizationConfig` 添加 SenseVoice 相关配置

---

### 2. ✅ SSE 服务（已存在）

**现有代码**：
- `backend/app/services/sse_service.py` - `SSEManager`

**核心 API**：
```python
# 异步广播
await sse_manager.broadcast(channel_id, event, data)

# 同步广播（线程安全）
sse_manager.broadcast_sync(channel_id, event, data)

# 订阅频道
async for message in sse_manager.subscribe(channel_id, request):
    ...
```

**SSE 事件格式**：
```python
event: {event_name}
data: {json_data}
```

**修订方案**：
- ✅ **复用**现有的 SSE 服务
- ✅ **添加新事件类型**：
  - `sentence` - 句级字幕推送
  - `circuit_breaker_analysis` - 频谱检测完成
  - `fuse_decision` - 熔断决策
  - `retry_started` - 补刀开始

---

### 3. ⚠️ 进度权重模型（需扩展）

**现有代码**：
- `backend/app/core/config.py` - `PHASE_WEIGHTS` (固定权重)

**现有权重**：
```python
PHASE_WEIGHTS = {
    "pending": 0,
    "extract": 5,
    "bgm_detect": 2,
    "demucs_global": 8,
    "split": 5,
    "transcribe": 50,
    "align": 20,
    "translate": 0,
    "proofread": 0,
    "srt": 10,
    "complete": 0
}
```

**问题**：
- 固定权重无法适配 SenseVoice（对齐阶段几乎为 0）
- 无法根据实际分离/补刀片段数动态调整

**修订方案**：
- ✅ **保留**现有的 `PHASE_WEIGHTS` 作为默认值
- ✅ **新增方法** `calculate_dynamic_weights()` 到 `ProjectConfig` 类：

```python
def calculate_dynamic_weights(
    self,
    engine: str,
    total_segments: int,
    segments_to_separate: int,
    segments_to_retry: int
) -> Dict[str, int]:
    """
    根据引擎和实际场景动态计算权重

    Args:
        engine: 'whisperx' | 'sensevoice'
        total_segments: 总片段数
        segments_to_separate: 需要分离的片段数
        segments_to_retry: 需要补刀的片段数

    Returns:
        动态权重字典
    """
    if engine == 'whisperx':
        # WhisperX 使用现有固定权重
        return self.PHASE_WEIGHTS.copy()

    # SenseVoice 动态权重
    base_weights = self.PHASE_WEIGHTS.copy()

    if total_segments > 0:
        sep_ratio = segments_to_separate / total_segments
        retry_ratio = segments_to_retry / total_segments

        # 调整权重
        base_weights['demucs_global'] = int(15 * sep_ratio)  # 最多15%
        base_weights['transcribe'] = 70  # SenseVoice 转录+分句
        base_weights['align'] = 0        # SenseVoice 无需对齐
        base_weights['retry'] = int(15 * retry_ratio)  # Whisper 补刀

        # 平衡到 100%
        used = sum(base_weights.values())
        if used < 100:
            base_weights['transcribe'] += (100 - used)

    return base_weights
```

---

### 4. ⚠️ 模型预加载管理器（需扩展）

**现有代码**：
- `backend/app/services/model_preload_manager.py` - `ModelPreloadManager`

**现有功能**：
- Whisper 模型 LRU 缓存
- Align 模型缓存
- 内存监控
- 预加载状态管理
- 全局锁机制（`_global_lock`）

**修订方案**：
- ✅ **扩展**现有的 `ModelPreloadManager` 类
- ✅ **添加 SenseVoice 缓存**到现有缓存体系：

```python
class ModelPreloadManager:
    def __init__(self, config: PreloadConfig = None):
        # ... 现有代码 ...

        # 新增：SenseVoice 缓存（单例模式）
        self._sensevoice_service = None

    def get_sensevoice_model(self):
        """获取 SenseVoice 模型（单例）"""
        with self._global_lock:
            if self._sensevoice_service is None:
                from services.sensevoice_onnx_service import get_sensevoice_service
                self._sensevoice_service = get_sensevoice_service()

                if not self._sensevoice_service.is_loaded:
                    self._sensevoice_service.load_model()

                # 更新缓存版本
                self._preload_status["cache_version"] = int(time.time())

            return self._sensevoice_service

    def unload_sensevoice(self):
        """卸载 SenseVoice 模型"""
        with self._global_lock:
            if self._sensevoice_service is not None:
                self._sensevoice_service.unload_model()
                self._sensevoice_service = None

                # 更新缓存版本
                self._preload_status["cache_version"] = int(time.time())

                self.logger.info("SenseVoice 模型已卸载")

    def clear_cache(self):
        """清空所有缓存（扩展）"""
        with self._global_lock:
            # ... 现有清理代码 ...

            # 新增：清理 SenseVoice
            self.unload_sensevoice()
```

---

## 二、修订后的文件结构

### Phase 1 修订

**删除的文件**：
- ❌ `backend/app/services/hardware_detector.py` （重复）

**保留的文件**：
- ✅ `backend/app/services/sensevoice_onnx_service.py`
- ✅ `backend/app/services/sentence_splitter.py`
- ✅ `backend/app/models/sensevoice_models.py`

**修改的文件**：
- ✅ `backend/app/models/hardware_models.py` - 扩展 `OptimizationConfig`

### Phase 2 修订

**新增的文件**：
- ✅ `backend/app/services/audio_circuit_breaker.py`
- ✅ `backend/app/services/fuse_breaker.py`
- ✅ `backend/app/models/circuit_breaker_models.py`

**修改的文件**：
- ✅ `backend/app/core/config.py` - 添加 `calculate_dynamic_weights()`

### Phase 3 修订

**修改的文件**：
- ✅ `backend/app/services/transcription_service.py` - 集成所有组件
- ✅ `backend/app/services/model_preload_manager.py` - 添加 SenseVoice 支持

**使用现有服务**：
- ✅ `backend/app/services/sse_service.py` - 直接使用
- ✅ `backend/app/services/hardware_service.py` - 直接使用

---

## 三、关键 API 对齐

### 3.1 硬件检测 API

```python
# 使用现有服务
from services.hardware_service import get_hardware_detector, get_hardware_optimizer

# 检测硬件
detector = get_hardware_detector()
hardware_info = detector.detect()

# 获取优化配置
optimizer = get_hardware_optimizer()
optimization_config = optimizer.get_optimization_config(hardware_info)

# 访问硬件信息
print(hardware_info.gpu_count)
print(hardware_info.gpu_memory_mb)
print(hardware_info.cuda_available)
print(hardware_info.gpu_name)
```

### 3.2 SSE 推送 API

```python
# 使用现有服务
from services.sse_service import get_sse_manager

sse_manager = get_sse_manager()

# 异步广播（在 async 函数中）
await sse_manager.broadcast(
    channel_id=f"job:{job_id}",
    event="sentence",
    data={
        "text": "这是一句话。",
        "start": 0.5,
        "end": 2.3,
        "confidence": 0.85
    }
)

# 同步广播（在普通函数/线程中）
sse_manager.broadcast_sync(
    channel_id=f"job:{job_id}",
    event="progress",
    data={
        "phase": "transcribe",
        "progress": 50
    }
)
```

### 3.3 进度更新 API

```python
# 在 transcription_service.py 中修改
def _update_progress(self, job, phase, phase_ratio, message=""):
    """更新进度（支持动态权重）"""
    from core.config import config

    # 动态获取权重
    engine = getattr(job.settings, 'engine', 'whisperx')

    # 动态计算权重
    phase_weights = config.calculate_dynamic_weights(
        engine=engine,
        total_segments=getattr(job, 'total_segments', 100),
        segments_to_separate=getattr(job, 'segments_to_separate', 0),
        segments_to_retry=getattr(job, 'segments_to_retry', 0)
    )

    # 计算累计进度（使用动态权重）
    done_phases = ['pending', 'extract', 'bgm_detect', 'demucs_global', 'split']
    if phase in done_phases:
        done_phases = done_phases[:done_phases.index(phase)]

    done_weight = sum(phase_weights.get(p, 0) for p in done_phases)
    current_weight = phase_weights.get(phase, 0) * phase_ratio
    total_weight = 100

    job.progress = round((done_weight + current_weight) / total_weight * 100, 1)
    job.phase = phase
    job.phase_percent = round(phase_ratio * 100, 1)
    job.message = message

    # 推送 SSE
    sse_manager = get_sse_manager()
    sse_manager.broadcast_sync(
        channel_id=f"job:{job.job_id}",
        event="progress",
        data={
            "phase": phase,
            "progress": job.progress,
            "message": message
        }
    )
```

---

## 四、修订后的开发顺序

### Phase 1（修订版）

1. ✅ 创建 `sensevoice_onnx_service.py`
2. ✅ 创建 `sentence_splitter.py`
3. ✅ 创建 `sensevoice_models.py`
4. ✅ **扩展** `hardware_models.py` 的 `OptimizationConfig`
5. ❌ **删除** 创建 `hardware_detector.py` 的任务

### Phase 2（修订版）

1. ✅ 创建 `audio_circuit_breaker.py`
2. ✅ 创建 `fuse_breaker.py`
3. ✅ 创建 `circuit_breaker_models.py`
4. ✅ **扩展** `config.py` 添加 `calculate_dynamic_weights()`

### Phase 3（修订版）

1. ✅ **扩展** `model_preload_manager.py` 添加 SenseVoice 支持
2. ✅ **修改** `transcription_service.py` 集成所有组件
3. ✅ **使用**现有的 `sse_service.py`
4. ✅ **使用**现有的 `hardware_service.py`

---

## 五、验证清单

- [ ] 硬件检测使用现有 `hardware_service.py`
- [ ] SSE 推送使用现有 `sse_service.py`
- [ ] 动态权重计算正确集成到 `config.py`
- [ ] SenseVoice 缓存正确集成到 `model_preload_manager.py`
- [ ] 所有 SSE 事件使用标准格式
- [ ] 进度更新使用动态权重
- [ ] 无重复代码

---

## 六、下一步

1. ✅ 根据此修订说明更新 Phase 1-5 开发文档
2. ✅ 确保所有代码示例使用现有服务
3. ✅ 测试与现有代码的兼容性

---

**修订完成日期**：2025-12-04
