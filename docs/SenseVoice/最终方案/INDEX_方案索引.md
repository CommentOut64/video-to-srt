# SenseVoice 集成方案索引

> **更新日期**：2024-12-04
> **文档版本**：v2.1
> **核心架构**：时空解耦 (Time-Space Decoupling) + VAD优先 + 频谱分诊

---

## 重要术语澄清（v2.1）

> **熔断和后处理增强是两个不同的概念，发生在不同阶段**

| 概念 | 触发条件 | 发生时机 | 动作 |
|------|----------|----------|------|
| **熔断** | BGM/Noise标签 + 低置信度 | 单个Chunk转录后立即判断 | 回溯到原始音频，升级分离模型重做 |
| **后处理增强** | 用户配置启用 + 低置信度 | 所有Chunk转录完成后 | Whisper补刀、LLM校对、翻译 |

**关键设计**：
- 熔断时必须使用 `original_audio`（分离前的原始音频）重新分离
- 熔断仅升级分离模型（NONE → HTDEMUCS → MDX_EXTRA），不涉及Whisper
- Whisper补刀属于后处理增强，不是熔断
- 止损点：`max_fuse_retry = 1`，防止无限循环

---

## 一、文档结构

```
最终方案/
├── INDEX_方案索引.md                             # 本文件
│
├── ══════════════════════════════════════════════
│   │         基础阶段文档（Phase 1-5，已整合 06 修改）
│   ══════════════════════════════════════════════
│
├── 01_Phase1_基础能力搭建_修订版.md  ★ v2.1
│   ├── SenseVoice ONNX 服务
│   ├── 分句算法
│   ├── 【新增】扩展数据模型（source, warning_type 等）
│   ├── 【新增】伪对齐算法
│   ├── 【新增】智能进度系统
│   ├── 【新增】阈值配置体系（置信度、困惑度）
│   └── 【新增】SSE 事件 Tag 统一设计
│
├── 02_Phase2_智能熔断集成_修订版.md  ★ v2.1
│   ├── 【v2.1核心】频谱指纹分诊台 AudioSpectrumClassifier
│   ├── 【v2.1核心】频谱分诊阈值 spectrum_thresholds.py
│   ├── 熔断决策、组合方案矩阵
│   ├── 【新增】WHISPER_TEXT_ONLY 动作
│   ├── 【新增】LLM_ARBITRATE 动作
│   └── 【新增】前端预设方案体系
│
├── 03_Phase3_转录服务重构_修订版.md  ★ v2.1
│   ├── 【v2.1核心】流程顺序：VAD → 频谱分诊 → 按需分离 → 转录
│   ├── 【核心】Whisper 补刀仅取文本 + 伪对齐
│   ├── 【新增】流式字幕输出系统
│   └── 【新增】智能进度追踪集成
│
├── 04_Phase4_前端适配_修订版.md  ★ v2.0
│   ├── UI、引擎选择器
│   ├── 【新增】预设选择器组件（6 预设 + 自定义）
│   ├── 【新增】置信度警告高亮系统
│   ├── 【新增】虚拟滚动优化
│   └── 【新增】统一 SSE 事件监听
│
├── 05_Phase5_整合测试_修订版.md  ★ v2.0
│   ├── 测试脚本、验收标准
│   ├── 【新增】时空解耦验证
│   └── 【新增】流式输出系统验证
│
├── ══════════════════════════════════════════════
│   │         深度优化设计文档（已整合到 Phase 1-5）
│   ══════════════════════════════════════════════
│
├── 06_转录层深度优化_时空解耦架构.md  ★ v2.1
│   ├── 【v2.1】VAD优先 + 频谱分诊流程
│   └── 【已整合】修改已合并到 Phase 1-5
│
└── 07_校对翻译层_LLM集成方案.md        # 独立 LLM 层方案
    ├── P1: 稀疏校对（三明治Prompt）
    ├── P2: 全量校对（滑动窗口）
    ├── T1: 全量翻译
    └── T2: 部分翻译
```

---

## 二、架构总览

### 2.1 VAD优先 + 时空解耦架构（v2.1）

```
┌─────────────────────────────────────────────────────────────────┐
│                   完整处理流程（v2.1）                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                   转录层 (Phase 1-3)                        ││
│  │                                                             ││
│  │  音频提取                                                   ││
│  │      ↓                                                      ││
│  │  VAD切分（15-30s Chunks）                                   ││
│  │      ↓                                                      ││
│  │  频谱分诊（Chunk级别，AudioSpectrumClassifier）            ││
│  │      │  - 提取特征：ZCR、谱质心、谐波比、能量方差          ││
│  │      │  - 判断：CLEAN / MUSIC / NOISE / MIXED               ││
│  │      │  - 推荐模型：htdemucs / mdx_extra / None             ││
│  │      ↓                                                      ││
│  │  [按需Demucs分离]（仅对需要分离的Chunk）                   ││
│  │      ↓                                                      ││
│  │  SenseVoice 转录（时间领主：确定绝对时间轴）                ││
│  │      ↓                                                      ││
│  │  分句算法 → 熔断决策（BGM/Noise+低置信度→升级分离）        ││
│  │      ↓                                                      ││
│  │  流式字幕输出（句级SSE推送）                                ││
│  │      ↓                                                      ││
│  │  ═══════════════════════════════════════════════════════   ││
│  │  │         后处理增强层（所有Chunk转录完成后）            │ ││
│  │  ═══════════════════════════════════════════════════════   ││
│  │      ↓                                                      ││
│  │  [Whisper补刀（仅文本）] → 伪对齐                          ││
│  │                                                             ││
│  └─────────────────────────────────────────────────────────────┘│
│                              ↓                                  │
│                     TranscriptionOutput                         │
│                              ↓                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                   校对翻译层 (07)                           ││
│  │                                                             ││
│  │  [P1: 稀疏校对] 或 [P2: 全量校对]                          ││
│  │      ↓                                                      ││
│  │  [T1: 全量翻译] 或 [T2: 部分翻译]                          ││
│  │      ↓                                                      ││
│  │  最终字幕输出                                               ││
│  │                                                             ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 VAD优先原则（v2.1核心变更）

**为什么必须先 VAD 再频谱分诊？**

1. **效率**：2小时电影可能只有40分钟有人说话，先VAD只对有效片段分析
2. **显存安全**：VAD将长音频切分为15-30s的Chunk，Demucs对短Chunk处理显存可控
3. **精细控制**：每个Chunk独立判断是否需要分离，纯净片段直接跳过

```
旧流程: 音频提取 → BGM检测(全局) → [Demucs全局分离] → VAD → 转录
新流程: 音频提取 → VAD → 频谱分诊(Chunk级) → [按需Chunk分离] → 转录
```

### 2.3 角色分工

| 角色 | 模型 | 职责 | 文档 |
|------|------|------|------|
| **时间领主** | SenseVoice | 时间轴基准、基础文本 | Phase 1, 3 |
| **听觉补丁** | Whisper | 低置信度补刀（仅文本，伪对齐） | Phase 3 |
| **逻辑胶水** | LLM | 校对、仲裁、翻译 | 07 |

---

## 三、前端预设方案

| 预设 ID | 名称 | 组合 | 耗时倍率 |
|---------|------|------|----------|
| default | SenseVoice Only | 极速模式 | 0.1x |
| preset1 | 智能补刀 | SV + Whisper 局部（推荐） | 0.15x |
| preset2 | 轻度校对 | 智能补刀 + LLM 按需校对 | 0.2x |
| preset3 | 深度校对 | 智能补刀 + LLM 全文精修 | 0.3x |
| preset4 | 校对+翻译 | 深度校对 + 全文翻译 | 0.5x |
| preset5 | 校对+重点翻译 | 深度校对 + 部分翻译 | 0.35x |

---

## 四、关键技术点

### 4.1 时空解耦原则

```
SenseVoice 确定的时间轴（start/end）不可变
  ↓
Whisper 补刀时仅取文本，弃用其时间戳
  ↓
新文本使用伪对齐均匀分布到原时间窗口
```

### 4.2 伪对齐算法

**位置**：`Phase 1` → `pseudo_alignment.py`

```python
def apply_pseudo_alignment(start, end, new_text):
    step = (end - start) / len(new_text)
    return [
        WordTimestamp(char, start + i*step, start + (i+1)*step, is_pseudo=True)
        for i, char in enumerate(new_text)
    ]
```

### 4.3 数据模型扩展

**位置**：`Phase 1` → `sensevoice_models.py`

```python
class SentenceSegment:
    source: TextSource           # sensevoice / whisper_patch / llm_correction
    is_modified: bool
    original_text: Optional[str]
    warning_type: WarningType    # 警告类型
    perplexity: Optional[float]  # LLM 困惑度
    translation: Optional[str]   # 翻译结果
```

---

## 五、实施顺序

### 阶段一：基础能力（Phase 1）
1. SenseVoice ONNX 服务
2. 分句算法
3. 伪对齐算法
4. 智能进度系统
5. 阈值配置体系

### 阶段二：智能熔断（Phase 2）
1. 频谱检测
2. 熔断决策器（时空解耦版）
3. 组合方案矩阵
4. 动态权重计算

### 阶段三：转录服务重构（Phase 3）
1. VAD 物理切分
2. SenseVoice 转录（时间领主）
3. Whisper 补刀（仅取文本）
4. 流式字幕输出系统

### 阶段四：前端适配（Phase 4）
1. 预设选择器组件
2. 置信度警告高亮
3. 虚拟滚动优化
4. 统一 SSE 事件监听

### 阶段五：测试验收（Phase 5）
1. 功能测试
2. 时空解耦验证
3. 性能测试

### 阶段六：LLM 集成（07 文档）
1. LLM 服务基类
2. P1 稀疏校对器
3. P2 全量校对器
4. T1/T2 翻译器

---

## 六、验收标准速查

### 熔断回溯机制（v2.1核心）

| 验证项 | 文档位置 |
|--------|----------|
| ChunkProcessState 保存 original_audio | Phase 3 §4.1 |
| 熔断时使用 original_audio 重新分离 | Phase 3 §4.2 |
| 熔断仅在 BGM/Noise + 低置信度时触发 | Phase 2 §5 |
| 止损点 max_fuse_retry=1 生效 | Phase 2 §4.2 |
| Whisper补刀在转录完成后执行 | Phase 3 §5 |

### 时空解耦架构

| 验证项 | 文档位置 |
|--------|----------|
| Whisper 补刀仅使用文本 | Phase 3 §4.1 |
| 伪对齐正确生成字级时间戳 | Phase 1 §3 |
| SentenceSegment.source 正确标记 | Phase 1 §2 |
| 流式输出使用统一 SSE Tag | Phase 1 §6 |

### 前端系统

| 验证项 | 文档位置 |
|--------|----------|
| 预设选择器正确显示 6 个预设 | Phase 4 §2 |
| 置信度警告高亮正确显示 | Phase 4 §3 |
| 虚拟滚动在大量字幕时不卡顿 | Phase 4 §4 |

---

## 七、快速入门

### 7.1 转录层开发

```bash
# 阅读顺序
1. 01_Phase1_基础能力搭建_修订版.md    # 数据模型、伪对齐、进度系统
2. 02_Phase2_智能熔断集成_修订版.md    # 熔断决策、组合方案矩阵
3. 03_Phase3_转录服务重构_修订版.md    # 时空解耦补刀、流式输出
```

### 7.2 前端开发

```bash
# 阅读顺序
1. 04_Phase4_前端适配_修订版.md        # 预设选择器、警告高亮、虚拟滚动
2. 02_Phase2_智能熔断集成_修订版.md §5 # 了解预设配置数据
```

### 7.3 LLM 层开发

```bash
# 阅读顺序
1. 07_校对翻译层_LLM集成方案.md       # 完整方案
```

---

## 八、版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2024-12-04 | 初始版本：Phase 1-5 修订版 |
| v1.1 | 2024-12-04 | 新增 06、07 文档，实现时空解耦架构 |
| v2.0 | 2024-12-04 | 将 06 文档内容整合到 Phase 1-5，统一文档版本 |
| **v2.1** | **2024-12-04** | **概念澄清：熔断=升级分离（转录中），后处理增强=Whisper补刀/LLM（转录后）；新增熔断回溯机制** |
