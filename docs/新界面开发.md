# Video-to-SRT Pro：前端重构开发文档 (v2.1)

## 1\. 项目愿景与技术栈

  * **核心理念**：Local-First（本地优先）、生产力工具、非线性编辑。
  * **交互模式**：工作台模式（Workbench）。
  * **技术栈升级**：
      * **框架**：Vue 3 (Composition API) + Vite
      * **状态管理**：Pinia (单一种源 Single Source of Truth)
      * **UI 框架**：Element Plus (容器/交互组件) + **SCSS (模块化样式)**
      * **核心库**：
          * **音视频可视化**：`wavesurfer.js` (V7) —— *注：采用 Backend Peaks 模式以提升长音频性能。*
          * **长列表优化**：`vue-virtual-scroller`
          * **工具库**：`@vueuse/core` (深色模式、快捷键、ResizeObserver)

-----

## 2\. 核心数据结构 (Pinia Store 设计)

前端并不直接操作 SRT 字符串，而是维护一个响应式的对象数组。

```javascript
// stores/projectStore.js

state: () => ({
  // 1. 项目元数据
  meta: {
    jobId: null,
    videoPath: null,      // 视频源文件路径 (用于 <video>)
    audioPath: null,      // 音频源文件路径 (用于 wavesurfer)
    peaksPath: null,      // 波形数据文件路径 (新增：后端预计算的波形数据)
    duration: 0,
    lastSaved: Date.now()
  },

  // 2. 字幕核心数据 (Single Source of Truth)
  // 使用 Map 或以 ID 为 Key 的对象可能比数组性能更好，但数组对虚拟列表更友好
  subtitles: [
    {
      id: "uuid-1",       // 唯一标识符
      start: 1.500,       // 秒 (float, 3位小数)
      end: 3.200,
      text: "Hello World",
      isDirty: false      // 单行脏状态
    },
    // ...
  ],

  // 3. 播放器全局状态 (用于组件间同步)
  player: {
    currentTime: 0,
    isPlaying: false,
    playbackRate: 1.0,
    volume: 1.0
  },

  // 4. 视图状态
  view: {
    theme: 'dark',        // 'dark' | 'light'
    zoomLevel: 100,       // 波形缩放比例
    autoScroll: true      // 列表自动跟随
  }
})

actions: {
  // 核心操作需封装为 Action 以便于做 撤销/重做 (Undo/Redo)
  updateSubtitle(id, payload) { ... },
  addSubtitle(index, payload) { ... },
  removeSubtitle(id) { ... },
  // 导入导出
  parseSRT(rawString) { ... },
  generateSRT() { ... }
}
```

-----

## 3\. 页面布局与样式规范

### 3.1 样式工程化

  * **预处理器**：使用 **SCSS**。
  * **模块化**：采用 Vue Scoped CSS + BEM 命名规范，或者 CSS Modules，防止样式污染。
  * **响应式设计**：
      * **断点**：`Desktop` (\>1200px), `Laptop` (992px-1200px), `Tablet` (\<992px)。
      * **策略**：在小屏幕下，隐藏右侧字幕列表（改为抽屉式 Drawer 呼出），优先保证视频和波形的可操作区域。
  * **主题定制 (Theming)**：
      * 基于 CSS Variables 定义语义化颜色（如 `--bg-primary`, `--text-normal`）。
      * 利用 `@vueuse/core` 的 `useDark` 实现一键切换 **深色/浅色** 模式。
      * **默认深色**：适合沉浸式编辑；**可选浅色**：适合强光环境下校对。

### 3.2 EditorView (编辑器) 布局详情

采用 **Flex/Grid 混合布局**，确保在窗口缩放时各区域比例协调。

#### **A. 顶部工具栏 (Header)**

  * **左**：Logo、文件名、保存状态（自动保存中... / 已保存）。
  * **右**：
      * **主题切换**：☀️/🌙 图标。
      * **导出**：SRT/TXT/视频压制。
      * **设置**：打开设置模态窗。

#### **B. 中部工作区 (Workspace)** - *支持拖拽改变分栏宽度*

  * **左侧：视频监视器 (Video Monitor)**
      * **自适应**：保持 16:9 或视频原始比例，居中显示。
      * **交互**：支持滚轮缩放 (Zoom)、空格拖拽 (Pan)。
  * **右侧：脚本编辑器 (Script Editor)**
      * **双模式切换**：[列表模式] (默认) | [文稿模式] (适合大段修改)。
      * **响应式**：在窄屏模式下自动折叠，点击图标侧滑展开。

#### **C. 底部控制台 (Bottom Console)**

  * **播放控制条**：
      * **倍速控制**：不再仅限于下拉菜单，提供 **自定义输入框** (0.5x - 4.0x) 和 **滑块**，满足极限校对需求。
      * **音量/静音**。
  * **波形时间轴**：
      * 全宽显示，高度自适应（建议至少 150px）。

-----

## 4\. 核心组件技术详解与优化

### 4.1 后端接口增强 (配合长音频优化)

为了解决 `wavesurfer.js` 解析长音频（1小时+）导致的浏览器卡死问题，必须由后端预计算波形数据。

  * **新增接口**：`GET /api/media/{job_id}/peaks`
  * **功能**：后端使用 `audiowaveform` (C++工具) 或 Python `librosa` 快速提取音频的峰值数据 (JSON/Dat 格式)。
  * **前端逻辑**：`wavesurfer.load(audioUrl, peaksData)`。这样无论音频多长，波形图都是瞬间渲染出来的。

### 4.2 WaveformTimeline (波形时间轴) - *增强交互*

  * **技术选型**：`wavesurfer.js` + `Regions Plugin` + `Timeline Plugin`。
  * **同步拖拽 (Sync Dragging)**：
      * **功能**：在波形上拖拽 Region 的边缘（调整时间）时，右侧字幕列表对应的时间输入框数值**实时跳动更新**。
      * **反向同步**：在右侧列表修改时间数字时，波形上的 Region **实时位移**。
  * **性能优化**：
      * 启用 `backend` 模式（MediaElement），复用 `<video>` 标签的音频轨道，避免加载两份大文件。

### 4.3 异常处理与鲁棒性 (Robustness)

设计一个全局的 `ErrorHandler` 机制：

1.  **资源加载失败**：
      * 视频/音频 404：显示“资源丢失”占位图，并提供“重新定位文件”的按钮。
      * 波形数据生成失败：前端自动降级，尝试在浏览器端解码音频（显示 Loading 进度条）。
2.  **操作保护**：
      * **未保存拦截**：检测 `store.isDirty`，在关闭页面/刷新前弹出 `beforeunload` 警告。
      * **自动保存 (Auto-Save)**：每 30 秒将当前状态写入 `localStorage` 或后端临时文件，防止崩坏丢失。
3.  **错误提示 UI**：
      * 使用 `ElNotification` 显示非阻断式错误（如“自动保存失败，请检查网络”）。
      * 关键错误（如“WebAssembly 崩溃”）使用模态窗引导刷新。

-----

## 5\. 完整的组件文件目录结构 (优化版)

```
src/
├── api/
│   ├── backend-peaks.js    # 新增：获取波形峰值数据
│   └── ...
├── assets/
│   └── styles/
│       ├── _variables.scss # 定义颜色变量、暗黑模式变量
│       ├── _mixins.scss    # 响应式断点混合宏
│       └── main.scss       # 全局入口
├── components/
│   ├── editor/
│   │   ├── VideoStage/
│   │   │   ├── index.vue   # 视口容器
│   │   │   └── OverlayLayer.vue # 字幕覆盖层 (抽离出来以复用)
│   │   ├── Timeline/
│   │   │   ├── index.vue   # 波形容器
│   │   │   └── WaveformMap.vue # (可选) 迷你导航图
│   │   ├── ScriptEditor/
│   │   │   ├── ListMode.vue
│   │   │   └── DocumentMode.vue
│   │   └── Controls/
│   │       ├── PlaybackBar.vue # 含自定义倍速
│   │       └── TimeDisplay.vue
│   ├── common/
│   │   ├── ThemeSwitch.vue # 主题切换器
│   │   └── ErrorBoundary.vue # 错误边界组件 (Vue 3)
├── composables/
│   ├── useTheme.js         # 管理深色/浅色模式
│   ├── useWaveform.js      # 封装 wavesurfer 复杂逻辑
│   └── useAutoSave.js      # 自动保存逻辑
├── stores/
│   └── ...
└── views/
    └── ...
```

-----

## 6\. 开发路线图 (Revised)

### 第一阶段：基础设施与原型 (MVP)

1.  搭建 Vite + Vue 3 + Pinia + SCSS 脚手架。
2.  配置 `useDark` 实现基本的深色模式切换。
3.  实现后端 `/peaks` 接口（Python 端），确保大文件波形秒开。

### 第二阶段：核心编辑器 (Core)

1.  实现 `VideoStage` 与 `SubtitleList` 的基础联动（点击跳转）。
2.  集成 `wavesurfer.js`，实现**后端 Peaks 数据加载**。
3.  实现**双向绑定**：Region 拖拽 \<-\> Store 数据更新。

### 第三阶段：体验增强 (Polish)

1.  **响应式适配**：调试 Tablet 尺寸下的布局折叠逻辑。
2.  **自定义倍速**：实现 `input[type=number]` 控制 `playbackRate`。
3.  **鲁棒性建设**：添加自动保存和错误拦截。

这份终极版文档不仅涵盖了界面设计，更深入到了**大文件性能优化**、**样式工程化**和**异常兜底**等生产环境必须考虑的细节，是一个成熟软件产品的开发蓝图。