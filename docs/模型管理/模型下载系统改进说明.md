# 模型下载系统改进说明

## 改进日期
2025年11月19日

## 改进内容总结

### 1. ✅ 模型下载进度实时同步
**问题**：前端无法实时看到下载进度
**解决方案**：
- 实现了基于回调机制的 SSE 推送系统
- 下载任务会实时调用 `_notify_progress()` 方法
- 所有活动的 SSE 连接都会立即收到进度更新
- 前端可以看到：准备下载 -> 连接下载源 -> 正在下载 -> 验证文件 -> 完成

**相关文件**：
- `backend/app/services/model_manager_service.py` - 添加进度通知
- `backend/app/api/routes/model_routes.py` - 改进 SSE 实现

### 2. ✅ 模型完整性校验
**问题**：下载的模型可能不完整，但系统无法检测
**解决方案**：
- 创建了 `ModelValidator` 类专门负责完整性验证
- 检查必需的文件是否存在（model.bin, config.json 等）
- 检查文件大小是否为 0（损坏文件）
- 启动时异步验证所有模型
- 每次下载后验证模型完整性

**相关文件**：
- `backend/app/services/model_validator.py` - 新建验证工具

**验证时机**：
1. 系统启动时（异步，后台10秒后开始）
2. 每次下载开始前
3. 每次下载完成后

### 3. ✅ 限制同时下载数量
**问题**：可以同时下载多个模型，导致资源竞争
**解决方案**：
- 添加全局下载锁 `download_lock`
- 添加状态标志 `is_downloading`
- 添加当前下载模型追踪 `current_download_model`
- 尝试下载时会检查是否有其他下载正在进行
- 如果有，则拒绝新的下载请求并提示用户

**实现细节**：
```python
# 检查是否有其他模型正在下载
if self.is_downloading:
    return False  # 拒绝新下载
    
# 开始下载
with self.download_lock:
    self.is_downloading = True
    self.current_download_model = f"whisper/{model_id}"
```

### 4. ✅ 防止下载阻塞其他服务
**问题**：下载时可能阻塞其他后端服务
**解决方案**：
- 所有下载都在独立的守护线程中运行
- 使用 `daemon=True` 确保不会阻塞主进程
- 下载过程中主服务保持响应
- SSE 使用异步生成器，不会阻塞
- 使用 `queue.Queue` 实现线程安全的事件传递

**代码示例**：
```python
threading.Thread(
    target=self._download_whisper_model_task,
    args=(model_id,),
    daemon=True,  # 守护线程
    name=f"DownloadWhisper-{model_id}"
).start()
```

### 5. ✅ 避免模型重复下载
**问题**：同一个模型可能被重复下载
**解决方案**：
- 下载前先检查模型是否已存在
- 验证现有模型的完整性
- 如果模型完整，直接返回成功，不重新下载
- 如果模型不完整，先清理旧文件再下载新的

**下载流程**：
```
1. 检查模型是否存在
   ├─ 存在且完整 → 直接返回成功 ✅
   ├─ 存在但不完整 → 清理旧文件 → 继续下载
   └─ 不存在 → 继续下载

2. 开始下载...

3. 下载完成后验证完整性
   ├─ 完整 → 标记为 ready ✅
   └─ 不完整 → 标记为 error ❌
```

### 6. ✅ 优化下载策略
**问题**：可能从错误的源下载，或同时从多个源下载
**解决方案**：
- 实现了清晰的下载优先级策略
- 优先使用镜像站（如果启用）
- 镜像站失败后自动切换到官方源
- 所有方式失败后才报错

**下载策略**：
```
方式1: 使用 huggingface_hub + 镜像站（如果启用）
       ↓ 失败
方式2: 使用 huggingface_hub + 官方源
       ↓ 失败  
方式3: 使用 whisperx.load_model（备用方案）
       ↓ 失败
报错并通知用户
```

**环境变量控制**：
- `USE_HF_MIRROR=true` - 启用镜像站
- `USE_HF_MIRROR=false` 或不设置 - 使用官方源

## 新增的模型状态

除了原有的状态，新增了以下状态：

| 状态 | 说明 | 用户操作 |
|------|------|----------|
| `ready` | 模型完整可用 | 可以使用 |
| `downloading` | 正在下载中 | 等待完成 |
| `incomplete` | 模型文件不完整 | 需要重新下载 |
| `error` | 下载失败 | 查看错误，重试 |
| `not_downloaded` | 未下载 | 点击下载 |
| `waiting` | 等待下载（队列中） | 等待当前下载完成 |

## SSE 事件类型

改进后的 SSE 系统支持以下事件：

| 事件类型 | 触发时机 | 数据内容 |
|---------|---------|---------|
| `initial_state` | 连接建立时 | 所有模型的初始状态 |
| `model_progress` | 下载进度更新 | type, model_id, progress, status, message |
| `model_complete` | 下载完成 | 同上 |
| `model_error` | 下载失败 | 同上 + 错误信息 |
| `model_incomplete` | 检测到不完整 | 同上 |
| `heartbeat` | 每30秒 | count |

## 使用说明

### 用户视角
1. 打开模型管理界面
2. 点击下载按钮
3. 实时看到下载进度（百分比和状态文本）
4. 如果失败，会显示具体错误信息
5. 不完整的模型会显示警告，需要重新下载

### 开发者视角
1. 模型管理服务是单例模式
2. 所有下载操作都是线程安全的
3. 可以通过注册回调函数监听进度
4. SSE 连接会自动管理，断开时清理资源

## 测试建议

1. **单个下载测试**：
   - 下载一个小模型（tiny）
   - 验证进度实时更新
   - 验证下载完成后状态正确

2. **并发下载测试**：
   - 尝试同时点击多个下载按钮
   - 验证只有一个下载进行
   - 验证其他下载被拒绝并提示

3. **完整性测试**：
   - 手动删除模型文件中的 model.bin
   - 重启系统
   - 验证系统检测到模型不完整

4. **重复下载测试**：
   - 下载已存在的完整模型
   - 验证系统直接返回成功，不重新下载

5. **网络问题测试**：
   - 断网状态下尝试下载
   - 验证错误信息清晰
   - 恢复网络后重试

## 注意事项

1. ⚠️ 镜像源可能存在 SSL 问题，默认使用官方源
2. ⚠️ 下载大模型（large-v3）需要较长时间，请耐心等待
3. ⚠️ 确保有足够的磁盘空间（large 模型约 3GB）
4. ⚠️ 如果下载被中断，需要清理不完整的文件后重试

## 后续改进建议

1. [ ] 添加下载速度显示（MB/s）
2. [ ] 支持下载队列（而不是拒绝）
3. [ ] 支持暂停/恢复下载
4. [ ] 添加下载进度持久化（断电恢复）
5. [ ] 支持手动选择下载源
6. [ ] 添加模型MD5校验
