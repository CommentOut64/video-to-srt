# æ¨¡å‹ç®¡ç†ç³»ç»Ÿè¡¥å……å¼€å‘æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäºå½“å‰å·²å®ç°çš„æ¨¡å‹ç®¡ç†åŠŸèƒ½ï¼Œæä¾›å®Œæ•´çš„è¡¥å……å¼€å‘è§„èŒƒï¼Œ**é‡ç‚¹é‡‡ç”¨ SSEï¼ˆServer-Sent Eventsï¼‰æ¶æ„æ›¿ä»£ä¼ ç»Ÿè½®è¯¢**ï¼Œå®ç°å®æ—¶è¿›åº¦æ¨é€ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-18
**é€‚ç”¨èŒƒå›´**: video_to_srt_gpu é¡¹ç›® - é˜¶æ®µ2.5æ¨¡å‹ç®¡ç†ç³»ç»Ÿ

---

## ğŸ“Š å½“å‰å®ç°çŠ¶æ€åˆ†æ

### âœ… å·²å®ç°éƒ¨åˆ†

#### 1. åç«¯æœåŠ¡å±‚

| æ–‡ä»¶ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `backend/app/services/model_manager_service.py` | æ¨¡å‹ä¸‹è½½ã€åˆ é™¤ã€çŠ¶æ€ç®¡ç† | âœ… å®Œæˆ |
| `backend/app/services/model_preload_manager.py` | é¢„åŠ è½½ã€LRUç¼“å­˜ã€å•æ¨¡å‹ç®¡ç† | âœ… å®Œæˆ |
| `backend/app/services/transcription_service.py` | é›†æˆå¯¹é½æ¨¡å‹è‡ªåŠ¨ä¸‹è½½ | âœ… å®Œæˆ |
| `backend/app/services/ffmpeg_manager.py` | FFmpegè‡ªåŠ¨æ£€æµ‹å’Œä¸‹è½½ | âœ… å®Œæˆ |

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… 6ä¸ªWhisperæ¨¡å‹ç®¡ç†ï¼ˆtiny, base, small, medium, large-v2, large-v3ï¼‰
- âœ… 12ç§è¯­è¨€å¯¹é½æ¨¡å‹ç®¡ç†
- âœ… åå°çº¿ç¨‹ä¸‹è½½ï¼ŒçŠ¶æ€è·Ÿè¸ªï¼ˆnot_downloaded, downloading, ready, errorï¼‰
- âœ… è½¬å½•æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶ä¸‹è½½ç¼ºå¤±çš„å¯¹é½æ¨¡å‹ï¼ˆç­‰å¾…æœ€å¤š5åˆ†é’Ÿï¼‰
- âœ… åˆ é™¤æ¨¡å‹åŒæ—¶æ¸…ç†å†…å­˜ç¼“å­˜

#### 2. API è·¯ç”±å±‚

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| `/api/models/whisper` | GET | åˆ—å‡ºæ‰€æœ‰Whisperæ¨¡å‹ | âœ… å®Œæˆ |
| `/api/models/align` | GET | åˆ—å‡ºæ‰€æœ‰å¯¹é½æ¨¡å‹ | âœ… å®Œæˆ |
| `/api/models/whisper/{model_id}/download` | POST | ä¸‹è½½Whisperæ¨¡å‹ | âœ… å®Œæˆ |
| `/api/models/align/{language}/download` | POST | ä¸‹è½½å¯¹é½æ¨¡å‹ | âœ… å®Œæˆ |
| `/api/models/whisper/{model_id}` | DELETE | åˆ é™¤Whisperæ¨¡å‹ | âœ… å®Œæˆ |
| `/api/models/align/{language}` | DELETE | åˆ é™¤å¯¹é½æ¨¡å‹ | âœ… å®Œæˆ |
| `/api/models/progress` | GET | è·å–æ‰€æœ‰ä¸‹è½½è¿›åº¦ï¼ˆè½®è¯¢ï¼‰ | âœ… å®Œæˆ |

#### 3. é¢„åŠ è½½ç®¡ç†å™¨é›†æˆ

| API | åŠŸèƒ½ | çŠ¶æ€ |
|-----|------|------|
| `/api/models/preload/status` | è·å–é¢„åŠ è½½çŠ¶æ€ | âœ… å®Œæˆ |
| `/api/models/cache/status` | è·å–ç¼“å­˜çŠ¶æ€ | âœ… å®Œæˆ |
| `/api/models/preload/start` | å¯åŠ¨é¢„åŠ è½½ | âœ… å®Œæˆ |
| `/api/models/cache/clear` | æ¸…ç©ºç¼“å­˜ | âœ… å®Œæˆ |
| `/api/models/preload/reset` | é‡ç½®å¤±è´¥è®¡æ•° | âœ… å®Œæˆ |

### âŒ ç¼ºå¤±éƒ¨åˆ†

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å½±å“ |
|------|--------|------|
| SSE å®æ—¶è¿›åº¦æ¨é€ç«¯ç‚¹ | ğŸ”´ é«˜ | å‰ç«¯éœ€è¦æŒç»­è½®è¯¢ï¼Œæ€§èƒ½å·® |
| å‰ç«¯ ModelManager.vue ç»„ä»¶ | ğŸ”´ é«˜ | æ— æ³•é€šè¿‡UIç®¡ç†æ¨¡å‹ |
| æ¨¡å‹ä¸‹è½½è¿›åº¦ç»†ç²’åº¦å›è°ƒ | ğŸŸ¡ ä¸­ | æ— æ³•å®æ—¶æ˜¾ç¤ºç™¾åˆ†æ¯”è¿›åº¦ |
| å‰åç«¯äº¤äº’æ–‡æ¡£ | ğŸŸ¡ ä¸­ | å¼€å‘æ•ˆç‡ä½ |
| HuggingFaceä¸‹è½½è¿›åº¦é’©å­ | ğŸŸ¢ ä½ | å½“å‰ä»…èƒ½æ˜¾ç¤º 0% æˆ– 100% |

---

##  æ ¸å¿ƒæ¶æ„æ”¹è¿›ï¼šSSE æ›¿ä»£è½®è¯¢

### ä¸ºä»€ä¹ˆä½¿ç”¨ SSEï¼Ÿ

| å¯¹æ¯”ç»´åº¦ | ä¼ ç»Ÿè½®è¯¢ | SSE (Server-Sent Events) |
|----------|---------|--------------------------|
| **ç½‘ç»œå¼€é”€** | é«˜ï¼ˆæ¯ç§’å¤šæ¬¡HTTPè¯·æ±‚ï¼‰ | ä½ï¼ˆå•ä¸ªæŒä¹…è¿æ¥ï¼‰ |
| **å®æ—¶æ€§** | å·®ï¼ˆå–å†³äºè½®è¯¢é—´éš”ï¼‰ | ä¼˜ï¼ˆæœåŠ¡ç«¯ä¸»åŠ¨æ¨é€ï¼‰ |
| **æœåŠ¡å™¨å‹åŠ›** | å¤§ï¼ˆé¢‘ç¹åˆ›å»ºè¿æ¥ï¼‰ | å°ï¼ˆå¤ç”¨é•¿è¿æ¥ï¼‰ |
| **å®ç°å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ |
| **æµè§ˆå™¨æ”¯æŒ** | æ‰€æœ‰ | ç°ä»£æµè§ˆå™¨ï¼ˆIEé™¤å¤–ï¼‰ |
| **æ–­çº¿é‡è¿** | éœ€æ‰‹åŠ¨å®ç° | æµè§ˆå™¨è‡ªåŠ¨é‡è¿ |

**ç»“è®º**: SSE æ˜¯æ¨¡å‹ä¸‹è½½è¿›åº¦æ¨é€çš„æœ€ä½³é€‰æ‹©ï¼Œç›¸æ¯” WebSocket æ›´è½»é‡ï¼Œç›¸æ¯”è½®è¯¢æ›´é«˜æ•ˆã€‚

---

## ğŸ“ SSE æ¶æ„è®¾è®¡

### 1. SSE ç«¯ç‚¹è§„èŒƒ

#### 1.1 ç»Ÿä¸€è¿›åº¦æ¨é€ç«¯ç‚¹

```
GET /api/models/events/progress
```

**åŠŸèƒ½**: å®æ—¶æ¨é€æ‰€æœ‰æ¨¡å‹çš„ä¸‹è½½è¿›åº¦å’ŒçŠ¶æ€å˜åŒ–

**è¯·æ±‚å‚æ•°**:
- æ— ï¼ˆä½¿ç”¨ `EventSource` å»ºç«‹è¿æ¥ï¼‰

**å“åº”æ ¼å¼** (SSE æ ‡å‡†):
```
Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive

event: model_progress
data: {"type": "whisper", "model_id": "medium", "status": "downloading", "progress": 35.6, "speed_mbps": 2.4}

event: model_progress
data: {"type": "align", "model_id": "zh", "status": "downloading", "progress": 68.2, "speed_mbps": 3.1}

event: model_complete
data: {"type": "whisper", "model_id": "medium", "status": "ready", "total_time_seconds": 120}

event: model_error
data: {"type": "whisper", "model_id": "large-v3", "status": "error", "error": "Network timeout"}

event: heartbeat
data: {"timestamp": 1700000000}
```

**äº‹ä»¶ç±»å‹**:
| äº‹ä»¶å | è§¦å‘æ—¶æœº | æ•°æ®ç»“æ„ |
|--------|---------|---------|
| `model_progress` | ä¸‹è½½è¿›åº¦æ›´æ–°ï¼ˆæ¯ç§’ï¼‰ | `{type, model_id, status, progress, speed_mbps}` |
| `model_complete` | ä¸‹è½½å®Œæˆ | `{type, model_id, status, total_time_seconds}` |
| `model_error` | ä¸‹è½½å¤±è´¥ | `{type, model_id, status, error}` |
| `model_deleted` | æ¨¡å‹è¢«åˆ é™¤ | `{type, model_id, deleted_at}` |
| `heartbeat` | æ¯30ç§’å¿ƒè·³ | `{timestamp}` |

#### 1.2 å•æ¨¡å‹è¿›åº¦æ¨é€ç«¯ç‚¹

```
GET /api/models/events/{type}/{model_id}
```

**åŠŸèƒ½**: ä»…æ¨é€æŒ‡å®šæ¨¡å‹çš„è¿›åº¦ï¼ˆç”¨äºè¯¦æƒ…é¡µï¼‰

**è·¯å¾„å‚æ•°**:
- `type`: `whisper` æˆ– `align`
- `model_id`: æ¨¡å‹IDæˆ–è¯­è¨€ä»£ç 

**ç¤ºä¾‹**:
```
GET /api/models/events/whisper/medium
GET /api/models/events/align/zh
```

**å“åº”æ ¼å¼**: åŒä¸Šï¼Œä½†ä»…åŒ…å«è¯¥æ¨¡å‹çš„äº‹ä»¶

---

### 2. åç«¯å®ç°æ–¹æ¡ˆ

#### 2.1 åœ¨ `model_routes.py` æ·»åŠ  SSE ç«¯ç‚¹

```python
# backend/app/api/routes/model_routes.py

from fastapi import APIRouter
from fastapi.responses import StreamingResponse
import asyncio
import json
from typing import AsyncGenerator

router = APIRouter(prefix="/api/models", tags=["models"])

@router.get("/events/progress")
async def stream_all_progress():
    """SSEç«¯ç‚¹ï¼šæ¨é€æ‰€æœ‰æ¨¡å‹ä¸‹è½½è¿›åº¦"""

    async def event_generator() -> AsyncGenerator[str, None]:
        """äº‹ä»¶ç”Ÿæˆå™¨"""
        model_mgr = get_model_manager()
        last_state = {}

        try:
            while True:
                # è·å–å½“å‰æ‰€æœ‰æ¨¡å‹çŠ¶æ€
                current_state = {
                    "whisper": {
                        m.model_id: {
                            "status": m.status,
                            "progress": m.download_progress
                        }
                        for m in model_mgr.list_whisper_models()
                    },
                    "align": {
                        m.language: {
                            "status": m.status,
                            "progress": m.download_progress
                        }
                        for m in model_mgr.list_align_models()
                    }
                }

                # æ£€æµ‹å˜åŒ–å¹¶æ¨é€
                for model_type in ["whisper", "align"]:
                    for model_id, state in current_state[model_type].items():
                        last = last_state.get(model_type, {}).get(model_id, {})

                        # çŠ¶æ€æˆ–è¿›åº¦å˜åŒ–
                        if state != last:
                            event_data = {
                                "type": model_type,
                                "model_id": model_id,
                                "status": state["status"],
                                "progress": state["progress"]
                            }

                            # ç¡®å®šäº‹ä»¶ç±»å‹
                            if state["status"] == "ready" and last.get("status") != "ready":
                                event_name = "model_complete"
                            elif state["status"] == "error":
                                event_name = "model_error"
                            else:
                                event_name = "model_progress"

                            # æ¨é€äº‹ä»¶
                            yield f"event: {event_name}\n"
                            yield f"data: {json.dumps(event_data)}\n\n"

                last_state = current_state

                # æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
                await asyncio.sleep(1)

                # æ¯30ç§’å‘é€å¿ƒè·³
                if int(asyncio.get_event_loop().time()) % 30 == 0:
                    yield f"event: heartbeat\n"
                    yield f"data: {json.dumps({'timestamp': int(time.time())})}\n\n"

        except asyncio.CancelledError:
            # å®¢æˆ·ç«¯æ–­å¼€è¿æ¥
            logger.info("SSEè¿æ¥å·²å…³é—­")

    return StreamingResponse(
        event_generator(),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "X-Accel-Buffering": "no"  # ç¦ç”¨nginxç¼“å†²
        }
    )
```

#### 2.2 åœ¨ `model_manager_service.py` æ·»åŠ è¿›åº¦å›è°ƒæœºåˆ¶

**éœ€è¦æ”¹è¿›çš„åœ°æ–¹**ï¼ˆå½“å‰å®ç°ç¼ºå¤±ï¼‰ï¼š

```python
# backend/app/services/model_manager_service.py

class ModelManagerService:
    def __init__(self):
        # ...ç°æœ‰ä»£ç ...

        # æ–°å¢ï¼šè¿›åº¦å›è°ƒæ³¨å†Œè¡¨
        self._progress_callbacks = []  # List[Callable[[str, str, float], None]]

    def register_progress_callback(self, callback):
        """æ³¨å†Œè¿›åº¦å›è°ƒå‡½æ•°"""
        self._progress_callbacks.append(callback)

    def _notify_progress(self, model_type: str, model_id: str, progress: float):
        """é€šçŸ¥æ‰€æœ‰æ³¨å†Œçš„å›è°ƒ"""
        for callback in self._progress_callbacks:
            try:
                callback(model_type, model_id, progress)
            except Exception as e:
                self.logger.error(f"è¿›åº¦å›è°ƒå¤±è´¥: {e}")

    def _download_whisper_model_task(self, model_id: str):
        """ä¸‹è½½ä»»åŠ¡ï¼ˆéœ€è¦æ·»åŠ è¿›åº¦é€šçŸ¥ï¼‰"""
        try:
            model = self.whisper_models[model_id]

            # æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°ï¼ˆå®é™…éœ€è¦HuggingFaceé’©å­ï¼‰
            for progress in range(0, 101, 10):
                model.download_progress = progress
                self._notify_progress("whisper", model_id, progress)
                time.sleep(1)  # å®é™…ç”±ä¸‹è½½é€Ÿåº¦å†³å®š

            # ...ç°æœ‰ä¸‹è½½é€»è¾‘...

        except Exception as e:
            # ...é”™è¯¯å¤„ç†...
            self._notify_progress("whisper", model_id, 0)  # é‡ç½®è¿›åº¦
```

#### 2.3 HuggingFace ä¸‹è½½è¿›åº¦é’©å­

**é—®é¢˜**: å½“å‰ `whisperx.load_model()` æ— æ³•è·å–å®æ—¶ä¸‹è½½è¿›åº¦

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `huggingface_hub` çš„åº•å±‚API

```python
from huggingface_hub import hf_hub_download, snapshot_download
from tqdm import tqdm

def download_with_progress(repo_id: str, callback):
    """å¸¦è¿›åº¦çš„æ¨¡å‹ä¸‹è½½"""

    class ProgressCallback:
        def __init__(self, total_size):
            self.total = total_size
            self.current = 0

        def __call__(self, size):
            self.current += size
            progress = (self.current / self.total) * 100
            callback(progress)

    # ä½¿ç”¨ huggingface_hub ä¸‹è½½
    snapshot_download(
        repo_id=repo_id,
        cache_dir=str(config.HF_CACHE_DIR),
        resume_download=True,
        local_files_only=False,
        # è¿›åº¦å›è°ƒéœ€è¦è‡ªå®šä¹‰å®ç°
    )
```

---

### 3. å‰ç«¯å®ç°æ–¹æ¡ˆ

#### 3.1 ModelManager.vue ç»„ä»¶è§„èŒƒ

```vue
<!-- frontend/src/components/ModelManager.vue -->

<template>
  <div class="model-manager">
    <!-- å¤´éƒ¨æ ‡ç­¾é¡µ -->
    <el-tabs v-model="activeTab">
      <el-tab-pane label="Whisperæ¨¡å‹" name="whisper">
        <ModelList
          :models="whisperModels"
          type="whisper"
          @download="handleDownload"
          @delete="handleDelete"
        />
      </el-tab-pane>

      <el-tab-pane label="å¯¹é½æ¨¡å‹" name="align">
        <ModelList
          :models="alignModels"
          type="align"
          @download="handleDownload"
          @delete="handleDelete"
        />
      </el-tab-pane>

      <el-tab-pane label="ç¼“å­˜ç®¡ç†" name="cache">
        <CacheManager
          :cache-info="cacheInfo"
          @clear-cache="handleClearCache"
        />
      </el-tab-pane>
    </el-tabs>

    <!-- å…¨å±€ä¸‹è½½é˜Ÿåˆ—ï¼ˆå¯æŠ˜å ï¼‰ -->
    <DownloadQueue
      v-if="downloadingModels.length > 0"
      :models="downloadingModels"
    />
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue'
import { useModelStore } from '@/stores/modelStore'
import { ElMessage } from 'element-plus'

const activeTab = ref('whisper')
const modelStore = useModelStore()

// è®¡ç®—å±æ€§ï¼ˆä» store è·å–ï¼‰
const whisperModels = computed(() => modelStore.whisperModels)
const alignModels = computed(() => modelStore.alignModels)
const downloadingModels = computed(() => modelStore.downloadingModels)
const cacheInfo = computed(() => modelStore.cacheInfo)

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  modelStore.connectSSE()  // å»ºç«‹SSEè¿æ¥
  modelStore.fetchModelList()  // åˆå§‹åŠ è½½
})

onUnmounted(() => {
  modelStore.disconnectSSE()  // æ–­å¼€SSEè¿æ¥
})

// äº‹ä»¶å¤„ç†
const handleDownload = async (type, modelId) => {
  try {
    await modelStore.downloadModel(type, modelId)
    ElMessage.success(`å¼€å§‹ä¸‹è½½ ${modelId}`)
  } catch (error) {
    ElMessage.error(`ä¸‹è½½å¤±è´¥: ${error.message}`)
  }
}

const handleDelete = async (type, modelId) => {
  try {
    await ElMessageBox.confirm(`ç¡®å®šåˆ é™¤æ¨¡å‹ ${modelId}?`, 'è­¦å‘Š', {
      type: 'warning'
    })
    await modelStore.deleteModel(type, modelId)
    ElMessage.success('åˆ é™¤æˆåŠŸ')
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error(`åˆ é™¤å¤±è´¥: ${error.message}`)
    }
  }
}

const handleClearCache = async () => {
  await modelStore.clearCache()
  ElMessage.success('ç¼“å­˜å·²æ¸…ç©º')
}
</script>
```

#### 3.2 Pinia Store (modelStore.js)

```javascript
// frontend/src/stores/modelStore.js

import { defineStore } from 'pinia'
import axios from 'axios'

export const useModelStore = defineStore('model', {
  state: () => ({
    whisperModels: [],
    alignModels: [],
    cacheInfo: {},
    eventSource: null,  // SSEè¿æ¥å¯¹è±¡
  }),

  getters: {
    // æ­£åœ¨ä¸‹è½½çš„æ¨¡å‹
    downloadingModels: (state) => {
      const whisper = state.whisperModels.filter(m => m.status === 'downloading')
      const align = state.alignModels.filter(m => m.status === 'downloading')
      return [...whisper.map(m => ({...m, type: 'whisper'})),
              ...align.map(m => ({...m, type: 'align'}))]
    },

    // ç»Ÿè®¡ä¿¡æ¯
    stats: (state) => ({
      whisperReady: state.whisperModels.filter(m => m.status === 'ready').length,
      whisperTotal: state.whisperModels.length,
      alignReady: state.alignModels.filter(m => m.status === 'ready').length,
      alignTotal: state.alignModels.length,
    })
  },

  actions: {
    // è·å–æ¨¡å‹åˆ—è¡¨
    async fetchModelList() {
      try {
        const [whisperRes, alignRes] = await Promise.all([
          axios.get('/api/models/whisper'),
          axios.get('/api/models/align')
        ])
        this.whisperModels = whisperRes.data
        this.alignModels = alignRes.data
      } catch (error) {
        console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error)
        throw error
      }
    },

    // å»ºç«‹ SSE è¿æ¥
    connectSSE() {
      if (this.eventSource) {
        console.warn('SSEè¿æ¥å·²å­˜åœ¨')
        return
      }

      console.log('å»ºç«‹SSEè¿æ¥...')
      this.eventSource = new EventSource('/api/models/events/progress')

      // ç›‘å¬è¿›åº¦æ›´æ–°
      this.eventSource.addEventListener('model_progress', (e) => {
        const data = JSON.parse(e.data)
        this.updateModelProgress(data.type, data.model_id, data.progress, data.status)
      })

      // ç›‘å¬ä¸‹è½½å®Œæˆ
      this.eventSource.addEventListener('model_complete', (e) => {
        const data = JSON.parse(e.data)
        this.updateModelProgress(data.type, data.model_id, 100, 'ready')
        this.$notify.success({
          title: 'ä¸‹è½½å®Œæˆ',
          message: `æ¨¡å‹ ${data.model_id} ä¸‹è½½æˆåŠŸ`
        })
      })

      // ç›‘å¬ä¸‹è½½å¤±è´¥
      this.eventSource.addEventListener('model_error', (e) => {
        const data = JSON.parse(e.data)
        this.updateModelProgress(data.type, data.model_id, 0, 'error')
        this.$notify.error({
          title: 'ä¸‹è½½å¤±è´¥',
          message: `æ¨¡å‹ ${data.model_id}: ${data.error}`
        })
      })

      // ç›‘å¬è¿æ¥é”™è¯¯
      this.eventSource.onerror = (error) => {
        console.error('SSEè¿æ¥é”™è¯¯:', error)
        // æµè§ˆå™¨ä¼šè‡ªåŠ¨é‡è¿ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
      }

      console.log('SSEè¿æ¥å·²å»ºç«‹')
    },

    // æ–­å¼€ SSE è¿æ¥
    disconnectSSE() {
      if (this.eventSource) {
        this.eventSource.close()
        this.eventSource = null
        console.log('SSEè¿æ¥å·²æ–­å¼€')
      }
    },

    // æ›´æ–°æ¨¡å‹è¿›åº¦ï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰
    updateModelProgress(type, modelId, progress, status) {
      const list = type === 'whisper' ? this.whisperModels : this.alignModels
      const model = list.find(m =>
        type === 'whisper' ? m.model_id === modelId : m.language === modelId
      )

      if (model) {
        model.download_progress = progress
        model.status = status
      }
    },

    // ä¸‹è½½æ¨¡å‹
    async downloadModel(type, modelId) {
      const url = type === 'whisper'
        ? `/api/models/whisper/${modelId}/download`
        : `/api/models/align/${modelId}/download`

      await axios.post(url)

      // ç«‹å³æ›´æ–°çŠ¶æ€ä¸º downloading
      this.updateModelProgress(type, modelId, 0, 'downloading')
    },

    // åˆ é™¤æ¨¡å‹
    async deleteModel(type, modelId) {
      const url = type === 'whisper'
        ? `/api/models/whisper/${modelId}`
        : `/api/models/align/${modelId}`

      await axios.delete(url)

      // ç«‹å³æ›´æ–°çŠ¶æ€
      this.updateModelProgress(type, modelId, 0, 'not_downloaded')
    },

    // æ¸…ç©ºç¼“å­˜
    async clearCache() {
      await axios.post('/api/models/cache/clear')
      await this.fetchModelList()
    }
  }
})
```

#### 3.3 ModelList å­ç»„ä»¶

```vue
<!-- frontend/src/components/ModelManager/ModelList.vue -->

<template>
  <div class="model-list">
    <el-table :data="models" stripe>
      <el-table-column prop="name" label="æ¨¡å‹åç§°" width="200">
        <template #default="{ row }">
          <span class="model-name">
            {{ row.model_id || row.language }}
            <el-tag v-if="row.cached" size="small" type="success">å·²ç¼“å­˜</el-tag>
          </span>
        </template>
      </el-table-column>

      <el-table-column prop="description" label="æè¿°" />

      <el-table-column prop="size_mb" label="å¤§å°" width="120">
        <template #default="{ row }">
          {{ row.size_mb }} MB
        </template>
      </el-table-column>

      <el-table-column label="çŠ¶æ€" width="200">
        <template #default="{ row }">
          <!-- æœªä¸‹è½½ -->
          <el-tag v-if="row.status === 'not_downloaded'" type="info">
            æœªä¸‹è½½
          </el-tag>

          <!-- ä¸‹è½½ä¸­ -->
          <div v-else-if="row.status === 'downloading'" class="downloading">
            <el-progress
              :percentage="row.download_progress"
              :stroke-width="12"
              :status="row.download_progress === 100 ? 'success' : null"
            />
            <span class="progress-text">{{ row.download_progress.toFixed(1) }}%</span>
          </div>

          <!-- å·²å°±ç»ª -->
          <el-tag v-else-if="row.status === 'ready'" type="success">
            å·²å°±ç»ª
          </el-tag>

          <!-- é”™è¯¯ -->
          <el-tag v-else-if="row.status === 'error'" type="danger">
            ä¸‹è½½å¤±è´¥
          </el-tag>
        </template>
      </el-table-column>

      <el-table-column label="æ“ä½œ" width="200">
        <template #default="{ row }">
          <!-- ä¸‹è½½æŒ‰é’® -->
          <el-button
            v-if="row.status === 'not_downloaded' || row.status === 'error'"
            type="primary"
            size="small"
            @click="$emit('download', type, row.model_id || row.language)"
          >
            <el-icon><Download /></el-icon>
            ä¸‹è½½
          </el-button>

          <!-- ä¸‹è½½ä¸­ï¼ˆç¦ç”¨ï¼‰ -->
          <el-button
            v-else-if="row.status === 'downloading'"
            type="primary"
            size="small"
            disabled
            loading
          >
            ä¸‹è½½ä¸­...
          </el-button>

          <!-- åˆ é™¤æŒ‰é’® -->
          <el-button
            v-if="row.status === 'ready'"
            type="danger"
            size="small"
            @click="$emit('delete', type, row.model_id || row.language)"
          >
            <el-icon><Delete /></el-icon>
            åˆ é™¤
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script setup>
import { Download, Delete } from '@element-plus/icons-vue'

defineProps({
  models: {
    type: Array,
    required: true
  },
  type: {
    type: String,
    required: true,
    validator: (value) => ['whisper', 'align'].includes(value)
  }
})

defineEmits(['download', 'delete'])
</script>

<style scoped>
.model-name {
  display: flex;
  align-items: center;
  gap: 8px;
}

.downloading {
  display: flex;
  align-items: center;
  gap: 12px;
}

.progress-text {
  font-size: 12px;
  color: #606266;
}
</style>
```

---

## ğŸ“¡ å®Œæ•´äº¤äº’æµç¨‹

### æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯ Vue
    participant SSE as SSEè¿æ¥
    participant API as FastAPI
    participant Service as ModelManager
    participant HF as HuggingFace

    User->>Frontend: æ‰“å¼€æ¨¡å‹ç®¡ç†é¡µé¢
    Frontend->>API: GET /api/models/whisper
    Frontend->>API: GET /api/models/align
    API-->>Frontend: è¿”å›æ¨¡å‹åˆ—è¡¨

    Frontend->>SSE: new EventSource('/api/models/events/progress')
    SSE-->>Frontend: å»ºç«‹æŒä¹…è¿æ¥

    User->>Frontend: ç‚¹å‡»"ä¸‹è½½ medium"
    Frontend->>API: POST /api/models/whisper/medium/download
    API->>Service: download_whisper_model('medium')
    Service-->>API: è¿”å› {success: true}
    API-->>Frontend: ä¸‹è½½å·²å¼€å§‹

    Service->>HF: åå°çº¿ç¨‹å¼€å§‹ä¸‹è½½

    loop æ¯ç§’æ¨é€è¿›åº¦
        Service->>SSE: æ›´æ–°è¿›åº¦ 35%
        SSE-->>Frontend: event: model_progress
        Frontend->>Frontend: æ›´æ–°è¿›åº¦æ¡ 35%
    end

    HF-->>Service: ä¸‹è½½å®Œæˆ
    Service->>SSE: æ¨é€å®Œæˆäº‹ä»¶
    SSE-->>Frontend: event: model_complete
    Frontend->>Frontend: æ˜¾ç¤º"ä¸‹è½½å®Œæˆ"é€šçŸ¥
    Frontend->>Frontend: æ›´æ–°çŠ¶æ€ä¸º "ready"
```

### è¯¦ç»†æ­¥éª¤

#### é˜¶æ®µ1: é¡µé¢åˆå§‹åŒ–ï¼ˆ0-2ç§’ï¼‰

| æ­¥éª¤ | å‰ç«¯åŠ¨ä½œ | åç«¯å“åº” | è€—æ—¶ |
|------|---------|---------|------|
| 1 | æŒ‚è½½ ModelManager.vue | - | 0ms |
| 2 | è°ƒç”¨ `modelStore.fetchModelList()` | - | 0ms |
| 3 | å‘é€ GET /api/models/whisper | æŸ¥è¯¢6ä¸ªWhisperæ¨¡å‹çŠ¶æ€ | 50ms |
| 4 | å‘é€ GET /api/models/align | æŸ¥è¯¢12ä¸ªå¯¹é½æ¨¡å‹çŠ¶æ€ | 50ms |
| 5 | æ¸²æŸ“æ¨¡å‹åˆ—è¡¨ | - | 100ms |
| 6 | è°ƒç”¨ `modelStore.connectSSE()` | - | 0ms |
| 7 | åˆ›å»º `new EventSource()` | å»ºç«‹ SSE è¿æ¥ | 200ms |
| 8 | SSE è¿æ¥æˆåŠŸ | å¼€å§‹ç›‘å¬äº‹ä»¶ | - |

**æ€»è€—æ—¶**: ~400ms

#### é˜¶æ®µ2: ç”¨æˆ·ä¸‹è½½æ¨¡å‹ï¼ˆå¼‚æ­¥ï¼‰

| æ­¥éª¤ | å‰ç«¯åŠ¨ä½œ | åç«¯å“åº” | è€—æ—¶ |
|------|---------|---------|------|
| 1 | ç”¨æˆ·ç‚¹å‡»"ä¸‹è½½ medium" | - | 0ms |
| 2 | å‘é€ POST /api/models/whisper/medium/download | å¯åŠ¨ä¸‹è½½çº¿ç¨‹ | 50ms |
| 3 | æ˜¾ç¤º"ä¸‹è½½å·²å¼€å§‹"æç¤º | - | 0ms |
| 4 | ç«‹å³æ›´æ–°çŠ¶æ€ä¸º "downloading" | - | 0ms |
| 5 | - | åå°çº¿ç¨‹ä¸‹è½½æ¨¡å‹ | 60-300s |
| 6 | é€šè¿‡ SSE æ¥æ”¶è¿›åº¦æ›´æ–° (æ¯ç§’) | æ¨é€ `model_progress` äº‹ä»¶ | æŒç»­ |
| 7 | æ›´æ–°è¿›åº¦æ¡ (0% â†’ 100%) | - | æŒç»­ |
| 8 | æ¥æ”¶ `model_complete` äº‹ä»¶ | - | 0ms |
| 9 | æ˜¾ç¤º"ä¸‹è½½å®Œæˆ"é€šçŸ¥ | - | 0ms |
| 10 | æ›´æ–°çŠ¶æ€ä¸º "ready" | - | 0ms |

**æ€»è€—æ—¶**: 1-5åˆ†é’Ÿï¼ˆå–å†³äºç½‘ç»œé€Ÿåº¦ï¼‰

#### é˜¶æ®µ3: è½¬å½•æ—¶è‡ªåŠ¨ä¸‹è½½å¯¹é½æ¨¡å‹

| æ­¥éª¤ | è§¦å‘ç‚¹ | åç«¯åŠ¨ä½œ | è€—æ—¶ |
|------|-------|---------|------|
| 1 | è½¬å½•æœåŠ¡æ£€æµ‹åˆ°è¯­è¨€ "zh" | - | 0ms |
| 2 | è°ƒç”¨ `_get_align_model('zh')` | - | 0ms |
| 3 | æ£€æµ‹åˆ°æ¨¡å‹æœªä¸‹è½½ | - | 10ms |
| 4 | è§¦å‘ `model_mgr.download_align_model('zh')` | å¯åŠ¨ä¸‹è½½ | 50ms |
| 5 | è¿›å…¥ç­‰å¾…å¾ªç¯ï¼ˆæ¯5ç§’æ£€æŸ¥ï¼‰ | - | æŒç»­ |
| 6 | æ£€æŸ¥çŠ¶æ€: downloading 35% | ç»§ç»­ç­‰å¾… | 5s |
| 7 | æ£€æŸ¥çŠ¶æ€: downloading 78% | ç»§ç»­ç­‰å¾… | 5s |
| 8 | æ£€æŸ¥çŠ¶æ€: ready | é€€å‡ºç­‰å¾… | 0ms |
| 9 | è°ƒç”¨ `whisperx.load_align_model()` | åŠ è½½åˆ°å†…å­˜ | 3s |
| 10 | è¿”å›æ¨¡å‹å¯¹è±¡ | - | 0ms |

**æ€»è€—æ—¶**: 1-5åˆ†é’Ÿï¼ˆé¦–æ¬¡ï¼‰æˆ– 3ç§’ï¼ˆå·²ä¸‹è½½ï¼‰

---

## ğŸ› ï¸ å¼€å‘å®æ–½æ¸…å•

### åç«¯ä»»åŠ¡

| ä»»åŠ¡ | æ–‡ä»¶ | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|---------|--------|
| å®ç° SSE ç«¯ç‚¹ `/api/models/events/progress` | `backend/app/api/routes/model_routes.py` | 4h | P0 |
| å®ç° SSE ç«¯ç‚¹ `/api/models/events/{type}/{id}` | åŒä¸Š | 2h | P1 |
| æ·»åŠ è¿›åº¦å›è°ƒæ³¨å†Œæœºåˆ¶ | `backend/app/services/model_manager_service.py` | 2h | P0 |
| é›†æˆ HuggingFace ä¸‹è½½è¿›åº¦é’©å­ | åŒä¸Š | 6h | P2 |
| æ·»åŠ å¿ƒè·³æœºåˆ¶ï¼ˆ30ç§’ï¼‰ | `backend/app/api/routes/model_routes.py` | 1h | P1 |
| å•å…ƒæµ‹è¯•ï¼ˆSSE è¿æ¥ã€æ–­çº¿é‡è¿ï¼‰ | `backend/tests/test_sse.py` | 4h | P1 |

**åç«¯æ€»è®¡**: 19å°æ—¶

### å‰ç«¯ä»»åŠ¡

| ä»»åŠ¡ | æ–‡ä»¶ | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|---------|--------|
| åˆ›å»º ModelManager.vue ä¸»ç»„ä»¶ | `frontend/src/components/ModelManager.vue` | 4h | P0 |
| åˆ›å»º ModelList.vue å­ç»„ä»¶ | `frontend/src/components/ModelManager/ModelList.vue` | 3h | P0 |
| åˆ›å»º DownloadQueue.vue å­ç»„ä»¶ | `frontend/src/components/ModelManager/DownloadQueue.vue` | 2h | P1 |
| åˆ›å»º CacheManager.vue å­ç»„ä»¶ | `frontend/src/components/ModelManager/CacheManager.vue` | 2h | P1 |
| å®ç° Pinia modelStore | `frontend/src/stores/modelStore.js` | 4h | P0 |
| å®ç° SSE è¿æ¥ç®¡ç† | åŒä¸Š | 3h | P0 |
| æ·»åŠ æ–­çº¿é‡è¿é€»è¾‘ | åŒä¸Š | 2h | P1 |
| æ·»åŠ è·¯ç”±é…ç½® | `frontend/src/router/index.js` | 0.5h | P0 |
| æ ·å¼ä¼˜åŒ–ï¼ˆå“åº”å¼å¸ƒå±€ï¼‰ | å„ç»„ä»¶ CSS | 3h | P2 |
| å•å…ƒæµ‹è¯•ï¼ˆSSE äº‹ä»¶å¤„ç†ï¼‰ | `frontend/tests/modelStore.spec.js` | 3h | P1 |

**å‰ç«¯æ€»è®¡**: 26.5å°æ—¶

### æ–‡æ¡£ä»»åŠ¡

| ä»»åŠ¡ | æ–‡ä»¶ | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|---------|--------|
| API æ–‡æ¡£ï¼ˆSwaggerï¼‰ | OpenAPI spec | 2h | P0 |
| å‰ç«¯ç»„ä»¶æ–‡æ¡£ | README.md | 2h | P1 |
| SSE æ¶æ„è®¾è®¡æ–‡æ¡£ | æœ¬æ–‡æ¡£ | âœ… å·²å®Œæˆ | P0 |
| éƒ¨ç½²æ³¨æ„äº‹é¡¹ï¼ˆnginxé…ç½®ï¼‰ | DEPLOYMENT.md | 1h | P1 |

**æ–‡æ¡£æ€»è®¡**: 5å°æ—¶

**é¡¹ç›®æ€»å·¥æ—¶**: ~50å°æ—¶ï¼ˆçº¦1-2å‘¨ï¼‰

---

## âš™ï¸ éƒ¨ç½²æ³¨æ„äº‹é¡¹

### 1. Nginx é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

SSE éœ€è¦ç‰¹æ®Šçš„ Nginx é…ç½®æ¥ç¦ç”¨ç¼“å†²ï¼š

```nginx
# /etc/nginx/sites-available/video-srt

location /api/models/events/ {
    proxy_pass http://backend:8000;

    # SSE å…³é”®é…ç½®
    proxy_set_header Connection '';
    proxy_http_version 1.1;
    chunked_transfer_encoding off;
    proxy_buffering off;
    proxy_cache off;

    # è¶…æ—¶è®¾ç½®ï¼ˆSSEè¿æ¥å¯èƒ½æŒç»­å¾ˆé•¿æ—¶é—´ï¼‰
    proxy_read_timeout 3600s;
    proxy_connect_timeout 3600s;

    # æ ‡å‡†ä»£ç†å¤´
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

### 2. CORS é…ç½®

å¦‚æœå‰åç«¯åˆ†ç¦»éƒ¨ç½²ï¼Œéœ€è¦å…è®¸ SSE è·¨åŸŸï¼š

```python
# backend/app/main.py

from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # å‰ç«¯åŸŸå
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
    expose_headers=["*"]  # é‡è¦ï¼šå…è®¸æµè§ˆå™¨è¯»å–è‡ªå®šä¹‰å¤´
)
```

### 3. æµè§ˆå™¨å…¼å®¹æ€§

| æµè§ˆå™¨ | ç‰ˆæœ¬ | æ”¯æŒæƒ…å†µ |
|--------|------|---------|
| Chrome | 6+ | âœ… å®Œå…¨æ”¯æŒ |
| Firefox | 6+ | âœ… å®Œå…¨æ”¯æŒ |
| Safari | 5+ | âœ… å®Œå…¨æ”¯æŒ |
| Edge | 79+ | âœ… å®Œå…¨æ”¯æŒ |
| IE | æ‰€æœ‰ç‰ˆæœ¬ | âŒ ä¸æ”¯æŒ |

**IE å…¼å®¹æ–¹æ¡ˆ**: é™çº§åˆ°è½®è¯¢æ¨¡å¼ï¼ˆæ£€æµ‹ `window.EventSource`ï¼‰

```javascript
// frontend/src/stores/modelStore.js

connectSSE() {
  if (typeof EventSource === 'undefined') {
    console.warn('æµè§ˆå™¨ä¸æ”¯æŒSSEï¼Œé™çº§åˆ°è½®è¯¢æ¨¡å¼')
    this.startPolling()  // å¯åŠ¨è½®è¯¢
    return
  }

  // æ­£å¸¸SSEé€»è¾‘...
}

startPolling() {
  this.pollingTimer = setInterval(async () => {
    const progress = await axios.get('/api/models/progress')
    this.updateModelsFromProgress(progress.data)
  }, 2000)  // æ¯2ç§’è½®è¯¢
}
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### 1. åç«¯ SSE æµ‹è¯•

```python
# backend/tests/test_sse.py

import pytest
from fastapi.testclient import TestClient
from app.main import app

def test_sse_connection():
    """æµ‹è¯•SSEè¿æ¥å»ºç«‹"""
    client = TestClient(app)

    with client.stream("GET", "/api/models/events/progress") as response:
        assert response.status_code == 200
        assert response.headers["content-type"] == "text/event-stream"

        # è¯»å–å‰å‡ ä¸ªäº‹ä»¶
        events = []
        for line in response.iter_lines():
            if line.startswith("data:"):
                events.append(line)
                if len(events) >= 3:
                    break

        assert len(events) > 0

def test_sse_progress_update():
    """æµ‹è¯•è¿›åº¦æ›´æ–°æ¨é€"""
    client = TestClient(app)

    # å…ˆè§¦å‘ä¸‹è½½
    client.post("/api/models/whisper/tiny/download")

    # ç›‘å¬SSEäº‹ä»¶
    with client.stream("GET", "/api/models/events/progress") as response:
        found_progress_event = False

        for line in response.iter_lines():
            if line.startswith("event: model_progress"):
                found_progress_event = True
                break

        assert found_progress_event
```

### 2. å‰ç«¯ SSE æµ‹è¯•

```javascript
// frontend/tests/modelStore.spec.js

import { setActivePinia, createPinia } from 'pinia'
import { useModelStore } from '@/stores/modelStore'

describe('ModelStore SSE', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  it('should establish SSE connection', () => {
    const store = useModelStore()
    store.connectSSE()

    expect(store.eventSource).toBeDefined()
    expect(store.eventSource.url).toContain('/api/models/events/progress')
  })

  it('should handle progress events', async () => {
    const store = useModelStore()
    store.whisperModels = [
      { model_id: 'medium', status: 'not_downloaded', download_progress: 0 }
    ]

    store.connectSSE()

    // æ¨¡æ‹ŸSSEäº‹ä»¶
    const event = new MessageEvent('model_progress', {
      data: JSON.stringify({
        type: 'whisper',
        model_id: 'medium',
        progress: 50,
        status: 'downloading'
      })
    })

    store.eventSource.dispatchEvent(event)

    await nextTick()

    expect(store.whisperModels[0].download_progress).toBe(50)
    expect(store.whisperModels[0].status).toBe('downloading')
  })
})
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å‰ç«¯ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | å®ç°æ–¹æ³• | æ•ˆæœ |
|--------|---------|------|
| è™šæ‹Ÿæ»šåŠ¨ | å¯¹é½æ¨¡å‹åˆ—è¡¨ä½¿ç”¨ `vue-virtual-scroller` | æ¸²æŸ“12ä¸ªæ¨¡å‹â†’æ¸²æŸ“5ä¸ªå¯è§æ¨¡å‹ |
| é˜²æŠ– | åˆ é™¤æŒ‰é’®ç‚¹å‡»é˜²æŠ– 300ms | é¿å…è¯¯æ“ä½œ |
| æ‡’åŠ è½½ | ModelManager ç»„ä»¶è·¯ç”±æ‡’åŠ è½½ | å‡å°‘é¦–å±åŠ è½½æ—¶é—´ |
| ç¼“å­˜ | LocalStorage ç¼“å­˜æ¨¡å‹åˆ—è¡¨ï¼ˆ5åˆ†é’Ÿï¼‰ | å‡å°‘åˆå§‹è¯·æ±‚ |

### 2. åç«¯ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | å®ç°æ–¹æ³• | æ•ˆæœ |
|--------|---------|------|
| è¿æ¥æ±  | é™åˆ¶SSEè¿æ¥æ•°ï¼ˆæœ€å¤š50ä¸ªï¼‰ | é˜²æ­¢èµ„æºè€—å°½ |
| å¢é‡æ¨é€ | ä»…æ¨é€çŠ¶æ€å˜åŒ–çš„æ¨¡å‹ | å‡å°‘å¸¦å®½æ¶ˆè€— |
| å‹ç¼© | å¯ç”¨ gzip å‹ç¼©ï¼ˆè™½ç„¶SSEæ•ˆæœæœ‰é™ï¼‰ | å‡å°‘ ~30% æµé‡ |
| å¿ƒè·³ä¼˜åŒ– | ä»…åœ¨æ— å…¶ä»–äº‹ä»¶æ—¶å‘é€å¿ƒè·³ | å‡å°‘æ— æ•ˆæ¶ˆæ¯ |

### 3. ç½‘ç»œä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | é…ç½® | æ•ˆæœ |
|--------|------|------|
| HTTP/2 | Nginx å¯ç”¨ HTTP/2 | å¤šè·¯å¤ç”¨ï¼Œå‡å°‘è¿æ¥æ•° |
| CDN | å‰ç«¯é™æ€èµ„æºä½¿ç”¨CDN | åŠ é€Ÿå…¨çƒè®¿é—® |
| DNSé¢„è§£æ | `<link rel="dns-prefetch">` | å‡å°‘DNSæŸ¥è¯¢æ—¶é—´ |

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. SSE è®¤è¯

```python
# backend/app/api/routes/model_routes.py

from fastapi import Depends, HTTPException, status
from app.auth import get_current_user

@router.get("/events/progress")
async def stream_progress(current_user: User = Depends(get_current_user)):
    """éœ€è¦è®¤è¯çš„SSEç«¯ç‚¹"""

    if not current_user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="æœªè®¤è¯"
        )

    async def event_generator():
        # ... SSEé€»è¾‘
        pass

    return StreamingResponse(event_generator(), ...)
```

### 2. é˜²æ­¢æ»¥ç”¨

```python
# é™æµï¼šæ¯ä¸ªç”¨æˆ·æœ€å¤š1ä¸ªSSEè¿æ¥
from collections import defaultdict

active_sse_connections = defaultdict(int)

@router.get("/events/progress")
async def stream_progress(request: Request):
    client_ip = request.client.host

    if active_sse_connections[client_ip] >= 1:
        raise HTTPException(
            status_code=429,
            detail="SSEè¿æ¥æ•°è¶…é™"
        )

    active_sse_connections[client_ip] += 1

    try:
        # ... SSEé€»è¾‘
        pass
    finally:
        active_sse_connections[client_ip] -= 1
```

### 3. æ•°æ®éªŒè¯

```python
# ç¡®ä¿ä¸æ³„éœ²æ•æ„Ÿè·¯å¾„
def sanitize_model_path(path: str) -> str:
    """éšè—å®Œæ•´è·¯å¾„ï¼Œä»…è¿”å›ç›¸å¯¹è·¯å¾„"""
    if path:
        return path.replace(str(config.MODELS_DIR), "models")
    return None
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£

- [MDN: Server-Sent Events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)
- [FastAPI: StreamingResponse](https://fastapi.tiangolo.com/advanced/custom-response/#streamingresponse)
- [Vue 3: EventSource ä½¿ç”¨](https://vuejs.org/guide/extras/web-components.html)

### ç¬¬ä¸‰æ–¹åº“

- [aiosseclient](https://github.com/ebraminio/aiosseclient) - Python async SSE client
- [vue-sse](https://github.com/tserkov/vue-sse) - Vue SSE æ’ä»¶
- [eventsource-polyfill](https://github.com/Yaffle/EventSource) - IE å…¼å®¹è¡¥ä¸

---

## âœ… æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **å®æ—¶æ€§**: SSE æä¾›æ¯«ç§’çº§çš„è¿›åº¦æ›´æ–°ï¼Œç”¨æˆ·ä½“éªŒæä½³
2. **é«˜æ•ˆæ€§**: å•ä¸ªæŒä¹…è¿æ¥æ›¿ä»£é¢‘ç¹è½®è¯¢ï¼ŒèŠ‚çœ ~90% ç½‘ç»œå¼€é”€
3. **å¯é æ€§**: æµè§ˆå™¨è‡ªåŠ¨é‡è¿ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†æ–­çº¿
4. **ç®€å•æ€§**: ç›¸æ¯” WebSocket æ›´æ˜“å®ç°å’Œç»´æŠ¤

### å…³é”®é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | å®Œæˆæ ‡å¿— | éªŒæ”¶æ ‡å‡† |
|--------|---------|---------|
| M1: åç«¯SSEå®ç° | SSEç«¯ç‚¹è¿”å›æ­£ç¡®æ ¼å¼çš„äº‹ä»¶æµ | ä½¿ç”¨ `curl` èƒ½æ¥æ”¶åˆ°äº‹ä»¶ |
| M2: å‰ç«¯ç»„ä»¶å¼€å‘ | ModelManager é¡µé¢å¯å±•ç¤ºæ¨¡å‹åˆ—è¡¨ | èƒ½æŸ¥çœ‹6ä¸ªWhisperå’Œ12ä¸ªå¯¹é½æ¨¡å‹ |
| M3: SSEé›†æˆ | å‰ç«¯å®æ—¶æ¥æ”¶è¿›åº¦æ›´æ–° | ä¸‹è½½æ—¶è¿›åº¦æ¡å¹³æ»‘å˜åŒ– |
| M4: å®Œæ•´æµç¨‹æµ‹è¯• | ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡ | ä»ç‚¹å‡»ä¸‹è½½åˆ°å®Œæˆé€šçŸ¥å…¨æµç¨‹æ­£å¸¸ |
| M5: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² | Nginxé…ç½®ç”Ÿæ•ˆï¼Œæ— ç¼“å†²é—®é¢˜ | ç”Ÿäº§ç¯å¢ƒSSEè¿æ¥ç¨³å®š |

### åç»­æ‰©å±•

- [ ] æ”¯æŒå¤šæ¨¡å‹å¹¶è¡Œä¸‹è½½ï¼ˆé™åˆ¶æœ€å¤š3ä¸ªï¼‰
- [ ] æ·»åŠ ä¸‹è½½é€Ÿåº¦é™åˆ¶ï¼ˆé¿å…å æ»¡å¸¦å®½ï¼‰
- [ ] æ¨¡å‹ç‰ˆæœ¬ç®¡ç†ï¼ˆè‡ªåŠ¨æ£€æµ‹æ–°ç‰ˆæœ¬ï¼‰
- [ ] æ¨¡å‹ä½¿ç”¨ç»Ÿè®¡ï¼ˆè®°å½•æ¯ä¸ªæ¨¡å‹çš„ä½¿ç”¨é¢‘ç‡ï¼‰
- [ ] ç¦»çº¿æ¨¡å‹åŒ…å¯¼å…¥ï¼ˆUç›˜æ‹·è´ï¼‰

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£åº”éšä»£ç å®ç°åŒæ­¥æ›´æ–°ã€‚å¦‚æœ‰ä»»ä½•ç–‘é—®æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

**æœ€åæ›´æ–°**: 2025-11-18
**ä½œè€…**: Claude Code
**å®¡æ ¸**: å¾…å®š
